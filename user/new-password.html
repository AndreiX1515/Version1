<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Travel | New Password</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="/css/i18n-boot.css">
    <script src="/js/i18n-boot.js"></script>
    <script src="../js/i18n.js" defer></script>
    <script src="../js/password.js" defer></script>
    <script src="../js/input_member.js" defer></script>
    <script src="../js/profile.js" defer></script>
</head>
<body>
    <div class="main bg white mh100">
        <header class="header-type2">
            <a class="btn-mypage" href="javascript:window.history.back();"><img src="../images/ico_back_black.svg"></a>
            <div class="title">New Password</div>
            <div></div>
        </header>
        <div class="px20 mt28">
            <div class="input-wrap1">
                <input class="input-type1" id="password1" type="password" data-i18n-placeholder="passwordPlaceholder" placeholder="8-12 characters, including letters/numbers/special characters">
                <button class="btn-eye" type="button"><img src="../images/ico_eye_off.svg" alt=""></button>
            </div>
            <div class="text fz12 fw400 lh16 reded mt4" id="password1Error" style="display: none;"></div>
            <div class="input-wrap1 mt14">
                <input class="input-type1" id="password2" type="password" data-i18n-placeholder="passwordConfirmPlaceholder" placeholder="Password Confirm">
                <button class="btn-eye" type="button"><img src="../images/ico_eye_off.svg" alt=""></button>
            </div>
            <div class="text fz12 fw400 lh16 gray96 mt4 text-wrap">Please enter 8-12 characters including English letters/numbers/special characters.</div>
            <div class="text fz12 fw400 lh16 reded mt4" id="password2Error" style="display: none;"></div>
            <div class="text fz12 fw400 lh16 reded mt4" id="apiError" style="display: none;"></div>
            <!-- NOTE -->
            <div class="fixed-bottom px20">
                <button class="btn primary lg inactive mt20" type="button" id="changePasswordBtn" onclick="handlePasswordChange()" data-i18n="changePassword">Change Password</button>
            </div>
        </div>
        
        <!-- NOTE -->
        <div class="layer" id="passwordCompleteLayer" style="display: none;"></div>
        <div class="alert-modal" id="passwordCompletePopup" style="display: none;">
            <div class="guide" data-i18n="changePasswordComplete">Change Password Complete</div>
            <div class="align gap12">
                <button class="btn primary lg" type="button" id="passwordCompleteOkBtn" data-i18n="confirm" style="width: 100%;">Confirm</button>
            </div>
        </div>
        
    </div>

    <script>
        // NOTE
        document.addEventListener('DOMContentLoaded', async function() {
            // NOTE
            await loadServerTexts();
            
            // NOTE
            const password1Input = document.getElementById('password1');
            const password2Input = document.getElementById('password2');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const password1Error = document.getElementById('password1Error');
            const password2Error = document.getElementById('password2Error');
            const apiError = document.getElementById('apiError');
            
            // NOTE
            function validatePasswordFormat(password) {
                if (password.length < 8 || password.length > 12) {
                    return { valid: false, message: 'Password must be 8-12 characters long.' };
                }
                if (!/[a-zA-Z]/.test(password)) {
                    return { valid: false, message: 'Password must include at least one letter.' };
                }
                if (!/[0-9]/.test(password)) {
                    return { valid: false, message: 'Password must include at least one number.' };
                }
                if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                    return { valid: false, message: 'Password must include at least one special character.' };
                }
                return { valid: true, message: '' };
            }
            
            function checkFormValidity() {
                const password1 = password1Input?.value.trim();
                const password2 = password2Input?.value.trim();
                
                // NOTE
                if (password1Error) password1Error.style.display = 'none';
                if (password2Error) password2Error.style.display = 'none';
                if (apiError) apiError.style.display = 'none';
                
                let isValid = true;
                
                // NOTE
                if (password1) {
                    const formatCheck = validatePasswordFormat(password1);
                    if (!formatCheck.valid) {
                        isValid = false;
                        if (password1Error) {
                            password1Error.textContent = formatCheck.message;
                            password1Error.style.display = 'block';
                        }
                    }
                } else {
                    isValid = false;
                }
                
                // NOTE
                if (password2) {
                    if (password1 !== password2) {
                        isValid = false;
                        if (password2Error) {
                            password2Error.textContent = 'Passwords do not match.';
                            password2Error.style.display = 'block';
                        }
                    }
                } else {
                    isValid = false;
                }
                
                // NOTE
                if (isValid && password1 && password2 && password1 === password2) {
                    changePasswordBtn.classList.remove('inactive');
                    changePasswordBtn.disabled = false;
                } else {
                    changePasswordBtn.classList.add('inactive');
                    changePasswordBtn.disabled = true;
                }
            }
            
            if (password1Input && password2Input && changePasswordBtn) {
                password1Input.addEventListener('input', checkFormValidity);
                password2Input.addEventListener('input', checkFormValidity);
            }
        });

        // NOTE
        async function handlePasswordChange() {
            const password1Input = document.getElementById('password1');
            const password2Input = document.getElementById('password2');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const password1Error = document.getElementById('password1Error');
            const password2Error = document.getElementById('password2Error');
            const apiError = document.getElementById('apiError');
            
            // NOTE
            if (password1Error) password1Error.style.display = 'none';
            if (password2Error) password2Error.style.display = 'none';
            if (apiError) apiError.style.display = 'none';
            
            const newPassword = password1Input?.value.trim();
            const confirmPassword = password2Input?.value.trim();
            
            // NOTE
            function validatePasswordFormat(password) {
                if (password.length < 8 || password.length > 12) {
                    return { valid: false, message: 'Password must be 8-12 characters long.' };
                }
                if (!/[a-zA-Z]/.test(password)) {
                    return { valid: false, message: 'Password must include at least one letter.' };
                }
                if (!/[0-9]/.test(password)) {
                    return { valid: false, message: 'Password must include at least one number.' };
                }
                if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                    return { valid: false, message: 'Password must include at least one special character.' };
                }
                return { valid: true, message: '' };
            }
            
            if (!newPassword || !confirmPassword) {
                const currentLang = getCurrentLanguage();
                const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.ko;
                if (apiError) {
                    apiError.textContent = texts.enterAllRequiredFields || 'Please enter all required information.';
                    apiError.style.display = 'block';
                }
                return;
            }
            
            // NOTE
            const formatCheck = validatePasswordFormat(newPassword);
            if (!formatCheck.valid) {
                if (password1Error) {
                    password1Error.textContent = formatCheck.message;
                    password1Error.style.display = 'block';
                }
                return;
            }
            
            if (newPassword !== confirmPassword) {
                const currentLang = getCurrentLanguage();
                const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.ko;
                if (password2Error) {
                    password2Error.textContent = texts.passwordMismatch || 'Passwords do not match.';
                    password2Error.style.display = 'block';
                }
                return;
            }
            
            const userId = localStorage.getItem('userId');
            if (!userId) {
                const currentLang = getCurrentLanguage();
                const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.ko;
                if (apiError) {
                    apiError.textContent = texts.loginRequired || 'Login is required.';
                    apiError.style.display = 'block';
                }
                setTimeout(() => {
                    location.href = 'login.html';
                }, 2000);
                return;
            }
            
            try {
                // NOTE
                if (changePasswordBtn) {
                    changePasswordBtn.disabled = true;
                    const currentLang = getCurrentLanguage();
                    const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.ko;
                    changePasswordBtn.textContent = texts.saving || 'Saving...';
                }
                
                // NOTE
                const response = await fetch('../backend/api/profile.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'change_password',
                        user_id: userId,
                        new_password: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // NOTE
                    const passwordCompleteLayer = document.getElementById('passwordCompleteLayer');
                    const passwordCompletePopup = document.getElementById('passwordCompletePopup');
                    const passwordCompleteOkBtn = document.getElementById('passwordCompleteOkBtn');
                    
                    if (passwordCompleteLayer && passwordCompletePopup) {
                        passwordCompleteLayer.style.display = 'block';
                        passwordCompletePopup.style.display = 'block';
                        
                        // NOTE
                        passwordCompleteLayer.onclick = function() {
                            passwordCompleteLayer.style.display = 'none';
                            passwordCompletePopup.style.display = 'none';
                            location.href = 'mypage.html';
                        };
                        
                        // NOTE
                        if (passwordCompleteOkBtn) {
                            passwordCompleteOkBtn.onclick = function() {
                                passwordCompleteLayer.style.display = 'none';
                                passwordCompletePopup.style.display = 'none';
                                location.href = 'mypage.html';
                            };
                        }
                    } else {
                        // NOTE
                        const currentLang = getCurrentLanguage();
                        const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.ko;
                        alert(texts.passwordChanged || 'Password has been changed successfully.');
                        location.href = 'mypage.html';
                    }
                } else {
                    const currentLang = getCurrentLanguage();
                    const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.ko;
                    const errorMessage = result.message || texts.passwordChangeFailed || 'Failed to change password.';
                    
                    // NOTE
                    if (apiError) {
                        apiError.textContent = errorMessage;
                        apiError.style.display = 'block';
                    }
                    
                    // NOTE
                    if (changePasswordBtn) {
                        changePasswordBtn.disabled = false;
                        changePasswordBtn.classList.add('inactive');
                        const currentLang = getCurrentLanguage();
                        const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.ko;
                        changePasswordBtn.textContent = texts.changePassword || 'Change Password';
                    }
                }
                
            } catch (error) {
                console.error('Password change error:', error);
                const currentLang = getCurrentLanguage();
                const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.ko;
                const errorMessage = texts.passwordChangeError || 'An error occurred while changing password.';
                
                // NOTE
                if (apiError) {
                    apiError.textContent = errorMessage;
                    apiError.style.display = 'block';
                }
                
                // NOTE
                if (changePasswordBtn) {
                    changePasswordBtn.disabled = false;
                    changePasswordBtn.classList.add('inactive');
                    const currentLang = getCurrentLanguage();
                    const texts = globalLanguageTexts[currentLang] || globalLanguageTexts.ko;
                    changePasswordBtn.textContent = texts.changePassword || 'Change Password';
                }
            }
        }
    </script>
</body>
</html>