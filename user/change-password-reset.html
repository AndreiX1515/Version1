<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Travel | Password Reset</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="/css/i18n-boot.css">
    <script src="/js/i18n-boot.js"></script>
    <script src="../js/i18n.js" defer></script>
    <script src="../js/password.js" defer></script>
</head>
<body>
    <div class="main bg white mh100">
        <header class="header-type2">
            <a class="btn-mypage" href="../home.html"><img src="../images/ico_back_black.svg"></a>
            <div class="title">Password Reset</div>
            <div></div>
        </header>

        <div class="px20 mt28">
            <div class="input-wrap1">
                <input class="input-type1" id="password1" type="password" placeholder="8-12 characters, including letters/numbers/special characters">
                <button class="btn-eye" type="button"><img src="../images/ico_eye_off.svg" alt=""></button>
            </div>
            <div class="text fz12 fw400 lh16 reded mt4" id="password1Error" style="display:none;"></div>

            <div class="input-wrap1 mt14">
                <input class="input-type1" id="password2" type="password" placeholder="Password Confirm">
                <button class="btn-eye" type="button"><img src="../images/ico_eye_off.svg" alt=""></button>
            </div>
            <div class="text fz12 fw400 lh16 reded mt4" id="password2Error" style="display:none;"></div>
            <div class="text fz12 fw400 lh16 reded mt4" id="apiError" style="display:none;"></div>

            <div class="fixed-bottom px20">
                <button class="btn primary lg inactive mt20" type="button" id="resetBtn">Change Password</button>
            </div>
        </div>

        <div class="layer" id="completeLayer" style="display:none;"></div>
        <div class="alert-modal" id="completePopup" style="display:none;">
            <div class="guide">Completed</div>
            <div class="align gap12">
                <button class="btn primary lg" type="button" id="completeOkBtn" style="width:100%;">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            await loadServerTexts();

            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token') || '';

            const p1 = document.getElementById('password1');
            const p2 = document.getElementById('password2');
            const btn = document.getElementById('resetBtn');
            const e1 = document.getElementById('password1Error');
            const e2 = document.getElementById('password2Error');
            const apiErr = document.getElementById('apiError');

            function validatePasswordFormat(password) {
                if (password.length < 8 || password.length > 12) return 'Password must be 8-12 characters long.';
                if (!/[a-zA-Z]/.test(password)) return 'Password must include at least one letter.';
                if (!/[0-9]/.test(password)) return 'Password must include at least one number.';
                if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) return 'Password must include at least one special character.';
                return '';
            }

            function setBtn(enabled) {
                btn.disabled = !enabled;
                if (enabled) btn.classList.remove('inactive');
                else btn.classList.add('inactive');
            }

            function check() {
                const a = (p1.value || '').trim();
                const b = (p2.value || '').trim();
                if (e1) e1.style.display = 'none';
                if (e2) e2.style.display = 'none';
                if (apiErr) apiErr.style.display = 'none';

                let ok = true;
                const fmt = validatePasswordFormat(a);
                if (!a || fmt) ok = false;
                if (!b || a !== b) ok = false;
                setBtn(ok);
            }

            p1.addEventListener('input', check);
            p2.addEventListener('input', check);
            check();

            btn.addEventListener('click', async () => {
                const newPassword = (p1.value || '').trim();
                const confirmPassword = (p2.value || '').trim();

                if (apiErr) apiErr.style.display = 'none';
                if (!token) {
                    apiErr.textContent = 'The reset link is invalid.';
                    apiErr.style.display = 'block';
                    return;
                }

                const fmt = validatePasswordFormat(newPassword);
                if (fmt) {
                    e1.textContent = fmt;
                    e1.style.display = 'block';
                    return;
                }
                if (newPassword !== confirmPassword) {
                    e2.textContent = 'Passwords do not match.';
                    e2.style.display = 'block';
                    return;
                }

                btn.disabled = true;
                const prev = btn.textContent;
                btn.textContent = 'Updating...';

                try {
                    const res = await fetch('../backend/api/password-reset-link.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'reset_with_token', token, newPassword })
                    });
                    const text = await res.text();
                    let data = null;
                    try { data = JSON.parse(text); } catch (_) {}

                    if (res.ok && data && data.success) {
                        const layer = document.getElementById('completeLayer');
                        const popup = document.getElementById('completePopup');
                        const okBtn = document.getElementById('completeOkBtn');
                        layer.style.display = 'block';
                        popup.style.display = 'block';
                        const close = () => {
                            layer.style.display = 'none';
                            popup.style.display = 'none';
                            location.href = 'login.html';
                        };
                        layer.onclick = close;
                        okBtn.onclick = close;
                    } else {
                        apiErr.textContent = (data && data.message) ? data.message : 'An error occurred while changing password.';
                        apiErr.style.display = 'block';
                    }
                } catch (err) {
                    console.error(err);
                    apiErr.textContent = 'An error occurred while changing password.';
                    apiErr.style.display = 'block';
                } finally {
                    btn.textContent = prev;
                    check();
                }
            });
        });
    </script>
</body>
</html>


