<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>SMART TRAVEL ADMIN</title>

	<!-- Common styles -->
	<link rel="shortcut icon" href="../image/favicon.ico">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/a_reset.css">
	<link rel="stylesheet" href="../css/a_variables.css">
	<link rel="stylesheet" href="../css/a_components.css">
	<link rel="stylesheet" href="../css/a_contents.css">

	<!-- calendar -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
</head>

<body>

	<!-- Header slot -->
	<header class="layout-header"></header>

	<!-- Main content -->
	<main class="layout-main">
		<!-- Nav slot -->
		<nav class="layout-nav"></nav>

		<section class="layout-content">
			<h1 class="page-title" data-lan-eng="Full list">Full list</h1>

			<div class="card-panel jw-mgt32">

			<div class="list-header">
				<div class="result-count">
					<span data-lan-eng="Search results">Search results</span> <span class="result-count__num" id="totalCount">0</span><span data-lan-eng="items"> items</span>
				</div>
				<input id="travelStartDate" type="text" placeholder="Travel start date" readonly style="width:200px; height:46px; border:1px solid #D4D4D4 !important; border-radius:12px !important; padding:0 40px 0 16px !important; background:#fff url('../image/calendar.svg') no-repeat right 12px center !important; background-size:24px 24px !important; font-size:16px; color:#121212; outline:none; cursor:pointer;">
			</div>
				
				<table class="jw-tableA">
					<colgroup>
						<col class="col-60"> <!-- No -->
						<col> <!-- Product Name -->
						<col> <!-- Travel start date -->
						<col> <!-- Reserver's name -->
						<col> <!-- Number of people -->
						<col> <!-- Progress status -->
					</colgroup>
					<thead>
						<tr>
							<th class="is-center">No</th>
							<th data-lan-eng="Product Name">Product Name</th>
							<th data-lan-eng="Travel start date">Travel start date</th>
							<th data-lan-eng="Reserver's name">Reserver's name</th>
							<th data-lan-eng="Number of people for reservation">Number of people for reservation</th>
							<th data-lan-eng="Progress status">Progress status</th>
						</tr>
					</thead>
					<tbody id="bookingsTableBody">
						<tr>
							<td colspan="6" class="is-center">Loading...</td>
						</tr>
					</tbody>
				</table>

				
				<div class="jw-pagebox" role="navigation" aria-label="Pagination" id="pagination">
					<div class="contents">
						<button type="button" class="first" aria-label="First page" aria-disabled="true" id="firstPage">
							<img src="../image/first.svg" alt="">
						</button>
						<button type="button" class="prev" aria-label="Previous page" aria-disabled="true" id="prevPage">
							<img src="../image/prev.svg" alt="">
						</button>

						<div class="page" role="list" id="pageNumbers">
							<!-- Page numbers are generated by JavaScript -->
						</div>

						<button type="button" class="next" aria-label="Next page" aria-disabled="true" id="nextPage">
							<img src="../image/next.svg" alt="">
						</button>
						<button type="button" class="last" aria-label="Last page" aria-disabled="true" id="lastPage">
							<img src="../image/last.svg" alt="">
						</button>
					</div>
				</div>

			</div>
			

		</section>

	</main>

	<script src="../js/default.js"></script>
	<script src="../js/guide.js"></script>
	<script src="../js/datepicker.js"></script>

	<script>
		init({
			headerUrl: '../inc/header.html',
			navUrl: '../inc/nav_guide.html'
		});

		// Global state
		let currentPage = 1;
		const limit = 20;
		let currentFilters = {
			selectedDate: null
		};

		// Session check + initial load
		document.addEventListener('DOMContentLoaded', async () => {
			// Session check
			try {
				// Dev/test: pass test_guide to check-session
				const __testGuide = new URLSearchParams(window.location.search).get('test_guide');
				const __qs = __testGuide ? `?test_guide=${encodeURIComponent(__testGuide)}` : '';
				const sessionResponse = await fetch('../backend/api/check-session.php' + __qs, {
					credentials: 'same-origin'
				});
				const sessionData = await sessionResponse.json();
				
				// Ensure guide session
				if (!sessionData.authenticated || (sessionData.userType && sessionData.userType !== 'guide')) {
					console.log('Session check:', sessionData);
					// Not a guide -> redirect to login
					window.location.href = '../index.html';
					return;
				}
				
				// Date filter (daterangepicker via datepicker.js)
				try {
					if (window.$) {
						const $travel = $('#travelStartDate');
						$travel.on('apply.daterangepicker', function () {
							currentFilters.selectedDate = String($(this).val() || '').trim() || null;
							currentPage = 1;
							loadBookings(1);
						});
						$travel.on('cancel.daterangepicker', function () {
							currentFilters.selectedDate = null;
							currentPage = 1;
							loadBookings(1);
						});
					}
				} catch (e) {
					console.warn('Failed to bind date filter events:', e);
				}
				
				// Load data
				await loadBookings();
			} catch (error) {
				console.error('Session check error:', error);
				window.location.href = '../index.html';
				return;
			}
		});

		// Load bookings
		async function loadBookings(page = 1) {
			try {
				const tbody = document.getElementById('bookingsTableBody');
				if (tbody) {
					tbody.innerHTML = '<tr><td colspan="6" class="is-center">Loading...</td></tr>';
				}

				// Build query params
				const params = new URLSearchParams({
					action: 'getAssignedBookings',
					page: page,
					limit: limit
				});
				// Dev/test: pass test_guide (guide-api also supports it)
				const __testGuide = new URLSearchParams(window.location.search).get('test_guide');
				if (__testGuide) params.append('test_guide', __testGuide);
				
				if (currentFilters.selectedDate) {
					params.append('selectedDate', currentFilters.selectedDate);
				}

				const response = await fetch(`../backend/api/guide-api.php?${params.toString()}`, {
					credentials: 'same-origin'
				});

				if (!response.ok) {
					throw new Error('HTTP ' + response.status);
				}

				const result = await response.json();

				if (result.success && result.data) {
					const { bookings, pagination } = result.data;
					const __testGuide = new URLSearchParams(window.location.search).get('test_guide');
					const __testGuideQs = __testGuide ? `&test_guide=${encodeURIComponent(__testGuide)}` : '';
					
					// Update total count
					const totalCountEl = document.getElementById('totalCount');
					if (totalCountEl) {
						totalCountEl.textContent = pagination.totalCount || 0;
					}

					// Render table
					if (tbody) {
						if (bookings.length === 0) {
							tbody.innerHTML = '<tr><td colspan="6" class="is-center">No assigned itineraries.</td></tr>';
						} else {
							tbody.innerHTML = bookings.map((booking, index) => {
								const rowNumber = (pagination.currentPage - 1) * pagination.limit + index + 1;
								return `
									<tr onclick="window.location.href='assigned-schedule-detail.html?id=${escapeHtml(booking.bookingId)}${__testGuideQs}'" style="cursor: pointer;">
										<td class="is-center">${rowNumber}</td>
										<td>${escapeHtml(booking.packageName || '')}</td>
										<td class="is-center">${escapeHtml(booking.travelStartDate || '')}</td>
										<td class="is-center">${escapeHtml(booking.reserverName || '-')}</td>
										<td class="is-center">${booking.numberOfPeople || 0}</td>
										<td class="is-center">${escapeHtml(booking.progressStatus || '')}</td>
									</tr>
								`;
							}).join('');
						}
					}

					// Update pagination
					updatePagination(pagination);
					currentPage = pagination.currentPage;
				} else {
					if (tbody) {
						tbody.innerHTML = '<tr><td colspan="6" class="is-center">Failed to load data.</td></tr>';
					}
				}
			} catch (error) {
				console.error('Error loading bookings:', error);
				const tbody = document.getElementById('bookingsTableBody');
				if (tbody) {
					tbody.innerHTML = '<tr><td colspan="6" class="is-center">Failed to load data.</td></tr>';
				}
			}
		}

		// Pagination
		function updatePagination(pagination) {
			const { currentPage, totalPages } = pagination;
			
			// Build page numbers
			const pageNumbersEl = document.getElementById('pageNumbers');
			if (pageNumbersEl) {
				pageNumbersEl.innerHTML = '';
				
				// Calculate visible page range
				const maxVisiblePages = 5;
				let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
				let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
				
				if (endPage - startPage < maxVisiblePages - 1) {
					startPage = Math.max(1, endPage - maxVisiblePages + 1);
				}
				
				for (let i = startPage; i <= endPage; i++) {
					const button = document.createElement('button');
					button.type = 'button';
					button.className = 'p' + (i === currentPage ? ' show' : '');
					button.setAttribute('role', 'listitem');
					if (i === currentPage) {
						button.setAttribute('aria-current', 'page');
					}
					button.textContent = i;
					button.onclick = () => loadBookings(i);
					pageNumbersEl.appendChild(button);
				}
			}
			
			// First page button
			const firstPageBtn = document.getElementById('firstPage');
			if (firstPageBtn) {
				firstPageBtn.disabled = currentPage === 1;
				firstPageBtn.setAttribute('aria-disabled', currentPage === 1);
				firstPageBtn.onclick = currentPage === 1 ? null : () => loadBookings(1);
			}
			
			// Previous page button
			const prevPageBtn = document.getElementById('prevPage');
			if (prevPageBtn) {
				prevPageBtn.disabled = currentPage === 1;
				prevPageBtn.setAttribute('aria-disabled', currentPage === 1);
				prevPageBtn.onclick = currentPage === 1 ? null : () => loadBookings(currentPage - 1);
			}
			
			// Next page button
			const nextPageBtn = document.getElementById('nextPage');
			if (nextPageBtn) {
				nextPageBtn.disabled = currentPage >= totalPages;
				nextPageBtn.setAttribute('aria-disabled', currentPage >= totalPages);
				nextPageBtn.onclick = currentPage >= totalPages ? null : () => loadBookings(currentPage + 1);
			}
			
			// Last page button
			const lastPageBtn = document.getElementById('lastPage');
			if (lastPageBtn) {
				lastPageBtn.disabled = currentPage >= totalPages;
				lastPageBtn.setAttribute('aria-disabled', currentPage >= totalPages);
				lastPageBtn.onclick = currentPage >= totalPages ? null : () => loadBookings(totalPages);
			}
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}
	</script>
</body>

</html>
