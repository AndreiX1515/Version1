<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>SMART TRAVEL ADMIN</title>

	<link rel="shortcut icon" href="../image/favicon.ico">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/a_reset.css">
	<link rel="stylesheet" href="../css/a_variables.css">
	<link rel="stylesheet" href="../css/a_components.css">
	<link rel="stylesheet" href="../css/a_contents.css">
	<style>
		.partner-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
			gap: 20px;
			margin-top: 20px;
		}
		.partner-card {
			background: #fff;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			padding: 16px;
			position: relative;
		}
		.partner-card .partner-image-wrap {
			width: 100%;
			height: 120px;
			background: #f5f5f5;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
			margin-bottom: 12px;
		}
		.partner-card .partner-image-wrap img {
			max-width: 100%;
			max-height: 100%;
			object-fit: contain;
		}
		.partner-card .partner-info {
			margin-bottom: 12px;
		}
		.partner-card .partner-name {
			font-weight: 600;
			font-size: 14px;
			margin-bottom: 4px;
		}
		.partner-card .partner-subtitle {
			font-size: 12px;
			color: #666;
		}
		.partner-card .partner-order {
			font-size: 11px;
			color: #999;
			margin-top: 4px;
		}
		.partner-card .partner-actions {
			display: flex;
			gap: 8px;
		}
		.partner-card .partner-actions button {
			flex: 1;
			padding: 8px;
			font-size: 12px;
		}
		.add-partner-card {
			background: #f9f9f9;
			border: 2px dashed #ccc;
			display: flex;
			align-items: center;
			justify-content: center;
			min-height: 220px;
			cursor: pointer;
			transition: border-color 0.2s;
		}
		.add-partner-card:hover {
			border-color: #999;
		}
		.add-partner-card span {
			font-size: 14px;
			color: #666;
		}

		/* Modal styles */
		.modal-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0,0,0,0.5);
			z-index: 1000;
			align-items: center;
			justify-content: center;
		}
		.modal-overlay.show {
			display: flex;
		}
		.modal-content {
			background: #fff;
			border-radius: 8px;
			padding: 24px;
			width: 100%;
			max-width: 500px;
			max-height: 90vh;
			overflow-y: auto;
		}
		.modal-title {
			font-size: 18px;
			font-weight: 600;
			margin-bottom: 20px;
		}
		.modal-form .form-group {
			margin-bottom: 16px;
		}
		.modal-form .form-group label {
			display: block;
			font-size: 13px;
			font-weight: 500;
			margin-bottom: 6px;
		}
		.modal-form .form-group input[type="text"],
		.modal-form .form-group input[type="number"] {
			width: 100%;
			padding: 10px 12px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
		}
		.modal-form .image-upload-area {
			width: 100%;
			height: 150px;
			background: #f5f5f5;
			border: 2px dashed #ddd;
			border-radius: 4px;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			overflow: hidden;
			position: relative;
		}
		.modal-form .image-upload-area img {
			max-width: 100%;
			max-height: 100%;
			object-fit: contain;
		}
		.modal-form .image-upload-area .upload-text {
			text-align: center;
			color: #999;
		}
		.modal-form .image-upload-area input[type="file"] {
			position: absolute;
			width: 100%;
			height: 100%;
			opacity: 0;
			cursor: pointer;
		}
		.modal-actions {
			display: flex;
			gap: 10px;
			margin-top: 24px;
		}
		.modal-actions button {
			flex: 1;
			padding: 12px;
		}
	</style>
</head>

<body>

	<header class="layout-header"></header>

	<main class="layout-main">
		<nav class="layout-nav"></nav>

		<section class="layout-content">

			<h1 class="page-title" data-lan-eng="Partner Management">Partner Management</h1>
			<p class="page-description jw-mgt8" style="color:#666; font-size:14px;" data-lan-eng="Manage partner companies displayed on the partnership information page.">
				Manage partner companies displayed on the partnership information page.
			</p>

			<div class="partner-grid" id="partnerGrid">
				<!-- Partners will be loaded here -->
			</div>

		</section>

	</main>

	<!-- Partner Edit Modal -->
	<div class="modal-overlay" id="partnerModal">
		<div class="modal-content">
			<h2 class="modal-title" id="modalTitle" data-lan-eng="Add Partner">Add Partner</h2>
			<form class="modal-form" id="partnerForm">
				<input type="hidden" id="partnerId" value="">

				<div class="form-group">
					<label data-lan-eng="Partner Logo">Partner Logo</label>
					<div class="image-upload-area" id="imageUploadArea">
						<input type="file" id="partnerImage" accept="image/*" onchange="handleImageSelect(this)">
						<div class="upload-text" id="uploadText">
							<div>Click to upload image</div>
							<div style="font-size:11px; margin-top:4px;">Recommended: 200x100px</div>
						</div>
						<img id="imagePreview" src="" alt="" style="display:none;">
					</div>
				</div>

				<div class="form-group">
					<label data-lan-eng="Partner Name">Partner Name <span style="color:red">*</span></label>
					<input type="text" id="partnerName" placeholder="e.g. ESCAPE TRAVEL" required>
				</div>

				<div class="form-group">
					<label data-lan-eng="Subtitle (optional)">Subtitle (optional)</label>
					<input type="text" id="partnerSubtitle" placeholder="e.g. CEBU-ICN-CEBU ONLY">
				</div>

				<div class="form-group">
					<label data-lan-eng="Display Order">Display Order</label>
					<input type="number" id="partnerOrder" value="1" min="1">
				</div>

				<div class="modal-actions">
					<button type="button" class="jw-button typeA" onclick="closeModal()" data-lan-eng="Cancel">Cancel</button>
					<button type="submit" class="jw-button typeB" data-lan-eng="Save">Save</button>
				</div>
			</form>
		</div>
	</div>

	<script src="../js/default.js?v=20250119_partner1"></script>
	<script src="../js/super.js?v=20250119_partner1"></script>

	<script>
		init({
			headerUrl: '../inc/header.html',
			navUrl: '../inc/nav_super.html'
		});

		let currentImageData = null;

		document.addEventListener('DOMContentLoaded', async () => {
			try {
				const sessionResponse = await fetch('../backend/api/check-session.php', {
					credentials: 'same-origin'
				});
				const sessionData = await sessionResponse.json();

				const isAdmin = sessionData && sessionData.authenticated && (sessionData.userType === 'admin' || sessionData.userType === 'super');
				if (!isAdmin) {
					window.location.href = '../index.html';
					return;
				}

				await loadPartners();
			} catch (error) {
				console.error('Session check error:', error);
				window.location.href = '../index.html';
				return;
			}
		});

		async function loadPartners() {
			try {
				const response = await fetch('../backend/api/super-api.php?action=getPartners', {
					credentials: 'same-origin'
				});

				if (!response.ok) throw new Error('HTTP ' + response.status);

				const result = await response.json();
				const grid = document.getElementById('partnerGrid');

				if (result.success && result.data && result.data.partners) {
					const partners = result.data.partners;

					let html = partners.map(p => {
						let imgSrc = p.imageUrl || '';
						if (imgSrc.startsWith('/uploads/')) {
							imgSrc = '../../' + imgSrc.substring(1);
						}
						return `
						<div class="partner-card" data-id="${p.partnerId}">
							<div class="partner-image-wrap">
								${p.imageUrl ? `<img src="${escapeHtml(imgSrc)}" alt="${escapeHtml(p.partnerName)}">` : '<span style="color:#ccc">No Image</span>'}
							</div>
							<div class="partner-info">
								<div class="partner-name">${escapeHtml(p.partnerName)}</div>
								${p.partnerSubtitle ? `<div class="partner-subtitle">${escapeHtml(p.partnerSubtitle)}</div>` : ''}
								<div class="partner-order">Order: ${p.partnerOrder}</div>
							</div>
							<div class="partner-actions">
								<button type="button" class="jw-button typeA" onclick="editPartner(${p.partnerId})"><span data-lan-eng="Edit">Edit</span></button>
								<button type="button" class="jw-button typeC" onclick="deletePartner(${p.partnerId})"><span data-lan-eng="Delete">Delete</span></button>
							</div>
						</div>
					`;
					}).join('');

					// Add "Add Partner" card at the end
					html += `
						<div class="partner-card add-partner-card" onclick="openAddModal()">
							<span>+ Add Partner</span>
						</div>
					`;

					grid.innerHTML = html;
				} else {
					grid.innerHTML = `
						<div class="partner-card add-partner-card" onclick="openAddModal()">
							<span>+ Add Partner</span>
						</div>
					`;
				}
			} catch (error) {
				console.error('Error loading partners:', error);
				document.getElementById('partnerGrid').innerHTML = `
					<div class="partner-card add-partner-card" onclick="openAddModal()">
						<span>+ Add Partner</span>
					</div>
				`;
			}
		}

		function openAddModal() {
			document.getElementById('modalTitle').textContent = 'Add Partner';
			document.getElementById('modalTitle').setAttribute('data-lan-eng', 'Add Partner');
			document.getElementById('partnerId').value = '';
			document.getElementById('partnerName').value = '';
			document.getElementById('partnerSubtitle').value = '';
			document.getElementById('partnerOrder').value = '1';
			document.getElementById('imagePreview').style.display = 'none';
			document.getElementById('imagePreview').src = '';
			document.getElementById('uploadText').style.display = 'block';
			currentImageData = null;
			document.getElementById('partnerModal').classList.add('show');
		}

		async function editPartner(partnerId) {
			try {
				const response = await fetch('../backend/api/super-api.php?action=getPartners', {
					credentials: 'same-origin'
				});
				const result = await response.json();

				if (result.success && result.data && result.data.partners) {
					const partner = result.data.partners.find(p => p.partnerId == partnerId);
					if (partner) {
						document.getElementById('modalTitle').textContent = 'Edit Partner';
						document.getElementById('modalTitle').setAttribute('data-lan-eng', 'Edit Partner');
						document.getElementById('partnerId').value = partner.partnerId;
						document.getElementById('partnerName').value = partner.partnerName || '';
						document.getElementById('partnerSubtitle').value = partner.partnerSubtitle || '';
						document.getElementById('partnerOrder').value = partner.partnerOrder || 1;

						if (partner.imageUrl) {
							// Handle both absolute and relative paths
							let imgSrc = partner.imageUrl;
							if (imgSrc.startsWith('/uploads/')) {
								imgSrc = '../../' + imgSrc.substring(1); // Convert /uploads/... to ../../uploads/...
							}
							document.getElementById('imagePreview').src = imgSrc;
							document.getElementById('imagePreview').style.display = 'block';
							document.getElementById('uploadText').style.display = 'none';
							currentImageData = partner.imageUrl; // Keep original for saving
						} else {
							document.getElementById('imagePreview').style.display = 'none';
							document.getElementById('uploadText').style.display = 'block';
							currentImageData = null;
						}

						document.getElementById('partnerModal').classList.add('show');
					}
				}
			} catch (error) {
				console.error('Error loading partner:', error);
				alert('Failed to load partner data.');
			}
		}

		function closeModal() {
			document.getElementById('partnerModal').classList.remove('show');
			currentImageData = null;
		}

		function handleImageSelect(input) {
			const file = input.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function(e) {
					document.getElementById('imagePreview').src = e.target.result;
					document.getElementById('imagePreview').style.display = 'block';
					document.getElementById('uploadText').style.display = 'none';
					currentImageData = e.target.result;
				};
				reader.readAsDataURL(file);
			}
		}

		document.getElementById('partnerForm').addEventListener('submit', async function(e) {
			e.preventDefault();

			const partnerId = document.getElementById('partnerId').value;
			const partnerName = document.getElementById('partnerName').value.trim();
			const partnerSubtitle = document.getElementById('partnerSubtitle').value.trim();
			const partnerOrder = parseInt(document.getElementById('partnerOrder').value) || 1;

			if (!partnerName) {
				alert('Partner name is required.');
				return;
			}

			try {
				const formData = {
					action: 'updatePartner',
					partnerName: partnerName,
					partnerSubtitle: partnerSubtitle || null,
					partnerOrder: partnerOrder,
					imageUrl: currentImageData || '',
					isActive: 1
				};

				if (partnerId) {
					formData.partnerId = parseInt(partnerId);
				}

				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(formData),
					credentials: 'same-origin'
				});

				const result = await response.json();

				if (result.success) {
					alert('Partner saved successfully.');
					closeModal();
					await loadPartners();
				} else {
					alert('Failed to save partner: ' + (result.message || 'Unknown error'));
				}
			} catch (error) {
				console.error('Error saving partner:', error);
				alert('An error occurred while saving.');
			}
		});

		async function deletePartner(partnerId) {
			if (!confirm('Are you sure you want to delete this partner?')) {
				return;
			}

			try {
				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						action: 'deletePartner',
						partnerId: partnerId
					}),
					credentials: 'same-origin'
				});

				const result = await response.json();

				if (result.success) {
					alert('Partner deleted successfully.');
					await loadPartners();
				} else {
					alert('Failed to delete partner: ' + (result.message || 'Unknown error'));
				}
			} catch (error) {
				console.error('Error deleting partner:', error);
				alert('An error occurred while deleting.');
			}
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

	</script>
</body>

</html>
