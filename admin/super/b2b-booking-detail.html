<!DOCTYPE html>
<html lang="en" id="html-lang">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>SMART TRAVEL ADMIN</title>

	<!-- Common styles -->
	<link rel="shortcut icon" href="../image/favicon.ico">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/a_reset.css">
	<link rel="stylesheet" href="../css/a_variables.css">
	<link rel="stylesheet" href="../css/a_components.css">
	<link rel="stylesheet" href="../css/a_contents.css">

	<!-- Date picker library (publishing parity) -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
</head>

<body>

	<!-- header slot -->
	<header class="layout-header"></header>

	<!-- Main area -->
	<main class="layout-main">
		<!-- nav slot -->
		<nav class="layout-nav"></nav>

		<section class="layout-content">
			<div class="page-toolbar">
				<a href="b2b-booking-list.html" class="jw-button" aria-label="Return to list">
					<img src="../image/arrow4.svg" alt="">
					<span data-lan-eng="Return to list">Return to list</span>
				</a>

				<div class="page-toolbar-actions">
					<button type="button" class="jw-button typeC" id="toggleEditAllowedBtn" title="Allow agent to edit product/traveler information">
						<span id="editAllowedIcon">üîí</span>
						<span id="editAllowedText" data-lan-eng="Allow Edit">Allow Edit</span>
					</button>
					<select class="select" id="guideSelect">
						<option value="" selected data-lan-eng="Guide not assigned">Guide not assigned</option>
					</select>
					<select class="select" id="reservationStatusSelect">
						<option value="pending" data-lan-eng="Pending">ÌôïÏù∏ ÎåÄÍ∏∞</option>
						<option value="waiting_down_payment" selected data-lan-eng="Waiting for Down Payment">Down Payment ÎåÄÍ∏∞</option>
						<option value="checking_down_payment" data-lan-eng="Checking Down Payment">Down Payment ÌôïÏù∏Ï§ë</option>
						<option value="waiting_second_payment" data-lan-eng="Waiting for Second Payment">Second Payment ÎåÄÍ∏∞</option>
						<option value="checking_second_payment" data-lan-eng="Checking Second Payment">Second Payment ÌôïÏù∏Ï§ë</option>
						<option value="waiting_balance" data-lan-eng="Waiting for Balance">Balance ÎåÄÍ∏∞</option>
						<option value="checking_balance" data-lan-eng="Checking Balance">Balance ÌôïÏù∏Ï§ë</option>
						<option value="waiting_full_payment" data-lan-eng="Waiting for Full Payment">Full Payment ÎåÄÍ∏∞</option>
						<option value="checking_full_payment" data-lan-eng="Checking Full Payment">Full Payment ÌôïÏù∏Ï§ë</option>
						<option value="rejected" data-lan-eng="Payment Rejected">Ï¶ùÎπô Í±∞Ï†à</option>
						<option value="confirmed" data-lan-eng="Reservation Confirmed">ÏòàÏïΩ ÌôïÏ†ï</option>
						<option value="completed" data-lan-eng="Trip Completed">Ïó¨Ìñâ ÏôÑÎ£å</option>
						<option value="cancelled" data-lan-eng="Reservation Cancelled">ÏòàÏïΩ Ï∑®ÏÜå</option>
						<option value="refunded" data-lan-eng="Refund Completed">ÌôòÎ∂à ÏôÑÎ£å</option>
					</select>
				</div>
			</div>

			<h1 class="page-title" data-lan-eng="B2B Reservation Details">B2B Reservation Details</h1>

			<div class="tab-wrap jw-mgt32">
				<p data-lan-eng="Product and Reservation Information">Product and Reservation Information</p>
				<a href="../common/reservation-location.html" target="_blank" id="meetingLocationLink"><span data-lan-eng="Meeting location">Meeting location</span><img src="../image/linkout.svg" alt=""></a>
				<a href="../common/reservation-notices.html" target="_blank" id="announcementsLink"><span data-lan-eng="Announcements">Announcements</span><img src="../image/linkout.svg" alt=""></a>
			</div>

			<h2 class="section-title jw-mgt32" data-lan-eng="Product Information">Product Information</h2>
			<div class="card-panel jw-mgt16">
				<div class="grid-wrap">
					<!-- Product name: full width -->
					<div class="grid-item col-span-3">
						<label class="label-name" data-lan-eng="Product Name">Product Name</label>
						<input type="text" class="form-control" id="packageName" value="" disabled>
					</div>

					<!-- Travel period -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Travel period">Travel period</label>
						<input type="text" class="form-control" id="travelPeriod" value="" disabled>
					</div>

					<!-- Meeting time -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Meeting time">Meeting time</label>
						<input type="text" class="form-control" id="meetingTime" value="" disabled>
					</div>

					<!-- Meeting place -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Meeting place">Meeting place</label>
						<input type="text" class="form-control" id="meetingLocation" value="" disabled>
					</div>
				</div>
			</div>

			<h2 class="section-title jw-mgt32" data-lan-eng="Reservation Information">Reservation Information</h2>
			<div class="card-panel jw-mgt16">
				<div class="grid-wrap">
					<!-- Row 1 -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Reservation number">Reservation number</label>
						<input type="text" class="form-control" id="bookingNo" placeholder="-" disabled readonly>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Reservation date and time">Reservation date and time</label>
						<input type="text" class="form-control" id="bookingDate" placeholder="-" disabled readonly>
					</div>
					<div class="grid-item"></div>

					<!-- Row 2 -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Number of people for reservation">Number of people for reservation</label>
						<input type="text" class="form-control" id="reservationPeople" placeholder="-" disabled readonly>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Room options">Room options</label>
						<input type="text" class="form-control" id="roomOption" placeholder="-" disabled readonly>
					</div>
					<div class="grid-item"></div>

					<!-- Row 3: optional selections -->
					<!-- SMT ÏàòÏ†ï ÏãúÏûë - Add Cabin Baggage, Breakfast Request, WiFi Rental ÏàòÏ†ï Í∞ÄÎä•ÌïòÍ≤å Î≥ÄÍ≤Ω -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Add Cabin Baggage">Add Cabin Baggage</label>
						<select class="select" id="cabinBaggageSelect">
							<option value="" selected data-lan-eng="Not selected">Not selected</option>
							<option value="15kg">15kg</option>
							<option value="20kg">20kg</option>
							<option value="30kg">30kg</option>
						</select>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Breakfast Request">Breakfast Request</label>
						<select class="select" id="breakfastSelect">
							<option value="apply" selected data-lan-eng="Apply">Apply</option>
							<option value="no_request" data-lan-eng="No request">No request</option>
						</select>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="WiFi Rental">WiFi Rental</label>
						<select class="select" id="wifiSelect">
							<option value="apply" selected data-lan-eng="Apply">Apply</option>
							<option value="no_request" data-lan-eng="No request">No request</option>
						</select>
					</div>
					<!-- SMT ÏàòÏ†ï ÏôÑÎ£å -->

					<!-- Row 4: airline seat request -->
					<div class="grid-item col-span-3">
						<label class="label-name" data-lan-eng="Airline seat request details">Airline seat request details</label>
						<div class="editor-box-wrap">
							<textarea rows="6" id="seatRequest" placeholder="-" style="resize:none;" disabled readonly></textarea>
						</div>
					</div>

					<!-- Row 5: other requests -->
					<div class="grid-item col-span-3">
						<label class="label-name" data-lan-eng="Other requests">Other requests</label>
						<div class="editor-box-wrap">
							<textarea rows="6" id="otherRequest" placeholder="-" style="resize:none;" disabled readonly></textarea>
						</div>
					</div>
				</div>
			</div>

			<h2 class="section-title jw-mgt32" data-lan-eng="Payment Information">Payment Information</h2>

			<!-- Total Amount -->
			<div class="card-panel jw-mgt16">
				<div class="grid-wrap">
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Total Amount (‚Ç±)">Total Amount (‚Ç±)</label>
						<input type="text" class="form-control" id="totalAmount" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Payment Type">Payment Type</label>
						<input type="text" class="form-control" id="paymentTypeDisplay" placeholder="-" disabled>
					</div>
					<div class="grid-item"></div>
				</div>
			</div>

			<!-- Staged Payment Sections -->
			<div id="stagedPaymentSections">
			<!-- Down Payment -->
			<div class="card-panel jw-mgt16" id="downPaymentSection">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
					<h3 class="card-panel-title" style="margin: 0;">Down Payment</h3>
					<div id="downPaymentStatus" class="payment-status"></div>
				</div>
				<div class="card-panel-divider"></div>
				<div class="grid-wrap jw-mgt16" style="grid-template-columns: 1fr 1fr 1fr auto;">
					<div class="grid-item">
						<label class="label-name">Down Payment (‚Ç±)</label>
						<input type="text" class="form-control" id="downPaymentAmount" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name">Deadline</label>
						<input type="text" class="form-control" id="downPaymentDeadline" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name">Proof File</label>
						<div class="cell">
							<div class="field-row jw-center">
								<div class="jw-center jw-gap10" id="downPaymentProofInfo">-</div>
								<div class="jw-center jw-gap10">
									<button type="button" class="jw-button typeF" id="downPaymentDownloadBtn" aria-label="Download" disabled>
										<img src="../image/buttun-download.svg" alt="">
									</button>
								</div>
							</div>
						</div>
					</div>
					<!-- Accept/Reject Î≤ÑÌäº -->
					<div class="grid-item" id="downPaymentActions" style="display: none;">
						<label class="label-name" style="visibility: hidden;">Action</label>
						<div style="display: flex; gap: 8px;">
							<button type="button" class="jw-button typeC" onclick="rejectPayment('down')" style="background: #DC3545; color: white; padding: 8px 16px;">
								<span>Reject</span>
							</button>
							<button type="button" class="jw-button typeB" onclick="confirmPayment('down')" style="background: #28A745; color: white; padding: 8px 16px;">
								<span>Accept</span>
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Second Payment -->
			<div class="card-panel jw-mgt16" id="secondPaymentSection">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
					<h3 class="card-panel-title" style="margin: 0;">Second Payment</h3>
					<div id="secondPaymentStatus" class="payment-status"></div>
				</div>
				<div class="card-panel-divider"></div>
				<div class="grid-wrap jw-mgt16" style="grid-template-columns: 1fr 1fr 1fr auto;">
					<div class="grid-item">
						<label class="label-name">Second Payment (‚Ç±)</label>
						<input type="text" class="form-control" id="secondPaymentAmount" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name">Deadline</label>
						<input type="text" class="form-control" id="secondPaymentDeadline" placeholder="-" disabled>
					</div>
					<div class="grid-item" id="secondPaymentFields">
						<label class="label-name">Proof File</label>
						<div class="cell">
							<div class="field-row jw-center">
								<div class="jw-center jw-gap10" id="secondPaymentProofInfo">-</div>
								<div class="jw-center jw-gap10">
									<button type="button" class="jw-button typeF" id="secondPaymentDownloadBtn" aria-label="Download" disabled>
										<img src="../image/buttun-download.svg" alt="">
									</button>
								</div>
							</div>
						</div>
					</div>
					<!-- Accept/Reject Î≤ÑÌäº -->
					<div class="grid-item" id="secondPaymentActions" style="display: none;">
						<label class="label-name" style="visibility: hidden;">Action</label>
						<div style="display: flex; gap: 8px;">
							<button type="button" class="jw-button typeC" onclick="rejectPayment('second')" style="background: #DC3545; color: white; padding: 8px 16px;">
								<span>Reject</span>
							</button>
							<button type="button" class="jw-button typeB" onclick="confirmPayment('second')" style="background: #28A745; color: white; padding: 8px 16px;">
								<span>Accept</span>
							</button>
						</div>
					</div>
				</div>
				<!-- ÎπÑÌôúÏÑ±Ìôî ÏïàÎÇ¥ -->
				<div id="secondPaymentDisabledNotice" class="payment-disabled-notice" style="padding: 16px; background: #F5F5F5; border-radius: 8px; margin-top: 16px; text-align: center; color: #666;">
					<p style="margin: 0; font-size: 14px;">Second Payment will be available after Down Payment is confirmed.</p>
				</div>
			</div>

			<!-- Balance -->
			<div class="card-panel jw-mgt16" id="balanceSection">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
					<h3 class="card-panel-title" style="margin: 0;">Balance</h3>
					<div id="balanceStatus" class="payment-status"></div>
				</div>
				<div class="card-panel-divider"></div>
				<div class="grid-wrap jw-mgt16" style="grid-template-columns: 1fr 1fr 1fr auto;">
					<div class="grid-item">
						<label class="label-name">Balance (‚Ç±)</label>
						<input type="text" class="form-control" id="balanceAmount" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name">Deadline</label>
						<input type="text" class="form-control" id="balanceDeadline" placeholder="-" disabled>
					</div>
					<div class="grid-item" id="balanceFields">
						<label class="label-name">Proof File</label>
						<div class="cell">
							<div class="field-row jw-center">
								<div class="jw-center jw-gap10" id="balanceProofInfo">-</div>
								<div class="jw-center jw-gap10">
									<button type="button" class="jw-button typeF" id="balanceDownloadBtn" aria-label="Download" disabled>
										<img src="../image/buttun-download.svg" alt="">
									</button>
								</div>
							</div>
						</div>
					</div>
					<!-- Accept/Reject Î≤ÑÌäº -->
					<div class="grid-item" id="balanceActions" style="display: none;">
						<label class="label-name" style="visibility: hidden;">Action</label>
						<div style="display: flex; gap: 8px;">
							<button type="button" class="jw-button typeC" onclick="rejectPayment('balance')" style="background: #DC3545; color: white; padding: 8px 16px;">
								<span>Reject</span>
							</button>
							<button type="button" class="jw-button typeB" onclick="confirmPayment('balance')" style="background: #28A745; color: white; padding: 8px 16px;">
								<span>Accept</span>
							</button>
						</div>
					</div>
				</div>
				<!-- ÎπÑÌôúÏÑ±Ìôî ÏïàÎÇ¥ -->
				<div id="balanceDisabledNotice" class="payment-disabled-notice" style="padding: 16px; background: #F5F5F5; border-radius: 8px; margin-top: 16px; text-align: center; color: #666;">
					<p style="margin: 0; font-size: 14px;">Balance will be available after Second Payment is confirmed.</p>
				</div>
			</div>
			</div><!-- End Staged Payment Sections -->

			<!-- Full Payment Section -->
			<div class="card-panel jw-mgt16" id="fullPaymentSection" style="display: none;">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
					<h3 class="card-panel-title" style="margin: 0;">Full Payment</h3>
					<div id="fullPaymentStatus" class="payment-status"></div>
				</div>
				<div class="card-panel-divider"></div>
				<div class="grid-wrap jw-mgt16" style="grid-template-columns: 1fr 1fr 1fr auto;">
					<div class="grid-item">
						<label class="label-name">Full Payment (‚Ç±)</label>
						<input type="text" class="form-control" id="fullPaymentAmount" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name">Deadline</label>
						<input type="text" class="form-control" id="fullPaymentDeadline" placeholder="-" disabled>
					</div>
					<div class="grid-item" id="fullPaymentFields">
						<label class="label-name">Proof File</label>
						<div class="cell">
							<div class="field-row jw-center">
								<div class="jw-center jw-gap10" id="fullPaymentProofInfo">-</div>
								<div class="jw-center jw-gap10">
									<button type="button" class="jw-button typeF" id="fullPaymentDownloadBtn" aria-label="Download" disabled>
										<img src="../image/buttun-download.svg" alt="">
									</button>
								</div>
							</div>
						</div>
					</div>
					<!-- Accept/Reject Î≤ÑÌäº -->
					<div class="grid-item" id="fullPaymentActions" style="display: none;">
						<label class="label-name" style="visibility: hidden;">Action</label>
						<div style="display: flex; gap: 8px;">
							<button type="button" class="jw-button typeC" onclick="rejectPayment('full')" style="background: #DC3545; color: white; padding: 8px 16px;">
								<span>Reject</span>
							</button>
							<button type="button" class="jw-button typeB" onclick="confirmPayment('full')" style="background: #28A745; color: white; padding: 8px 16px;">
								<span>Accept</span>
							</button>
						</div>
					</div>
				</div>
			</div>

			<h2 class="section-title jw-mgt32" data-lan-eng="Agent Information">Agent Information</h2>
			<div class="card-panel jw-mgt16">
				<div class="grid-wrap">
					<!-- Row 1 -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Agent Name">Agent Name</label>
						<input type="text" class="form-control" id="agentBranchName" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Person in charge">Person in charge</label>
						<input type="text" class="form-control" id="agentManagerName" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Person in charge email">Person in charge email</label>
						<input type="email" class="form-control" id="agentManagerEmail" placeholder="-" disabled>
					</div>

					<!-- Row 2 -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Contact information">Contact information</label>
						<input type="tel" class="form-control" id="agentManagerContact" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Deposit ratio (%)">Deposit ratio (%)</label>
						<input type="number" class="form-control" id="depositRatio" placeholder="-" min="0" max="100" step="1" disabled>
					</div>
					<div class="grid-item"></div>
				</div>
			</div>

			<h2 class="section-title jw-mgt32" data-lan-eng="Agent Notes">Agent Notes</h2>
			<div class="card-panel jw-mgt16">
				<div class="grid-wrap">
					<div class="grid-item col-span-3">
						<label class="label-name" data-lan-eng="Note">Note</label>
						<div class="editor-box-wrap">
							<textarea rows="8" id="agentMemo" placeholder="-" disabled readonly style="resize:none;"></textarea>
						</div>
					</div>
				</div>
			</div>

			<h2 class="section-title jw-mgt32" data-lan-eng="Flight Information">Flight Information</h2>
			<div class="card-panel jw-mgt16">
				<h3 class="grid-wrap-title" data-lan-eng="Departure flight">Departure flight</h3>
				<div class="grid-wrap jw-mgt16">
					<!-- Row 1 -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Flight number">Flight number</label>
						<input type="text" class="form-control" id="departureFlightNumber" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Departure date and time">Departure date and time</label>
						<input type="text" class="form-control" id="departureDateTime" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Arrival time">Arrival time</label>
						<input type="text" class="form-control" id="departureArrivalDateTime" placeholder="-" disabled>
					</div>

					<!-- Row 2 -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Departure point">Departure point</label>
						<input type="text" class="form-control" id="departurePoint" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Destination">Destination</label>
						<input type="text" class="form-control" id="departureDestination" placeholder="-" disabled>
					</div>
					<div class="grid-item"></div>
				</div>
			</div>
			<div class="card-panel jw-mgt16">
				<h3 class="grid-wrap-title" data-lan-eng="Return trip">Return trip</h3>
				<div class="grid-wrap jw-mgt16">
					<!-- Row 1 -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Flight number">Flight number</label>
						<input type="text" class="form-control" id="returnFlightNumber" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Departure date and time">Departure date and time</label>
						<input type="text" class="form-control" id="returnDepartureDateTime" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Arrival time">Arrival time</label>
						<input type="text" class="form-control" id="returnArrivalDateTime" placeholder="-" disabled>
					</div>

					<!-- Row 2 -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Departure point">Departure point</label>
						<input type="text" class="form-control" id="returnDeparturePoint" placeholder="-" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Destination">Destination</label>
						<input type="text" class="form-control" id="returnDestination" placeholder="-" disabled>
					</div>
					<div class="grid-item"></div>
				</div>
			</div>

			<div class="jw-cols jw-between jw-mgt32">
				<h2 class="section-title" data-lan-eng="Reservation Customer Information">Reservation Customer Information</h2>
				<div class="customer-edit-btns" id="customerEditBtns" style="display:none;">
					<button type="button" id="editCustomerBtn" class="jw-button typeA" data-lan-eng="Edit">Edit</button>
					<button type="button" id="saveCustomerBtn" class="jw-button typeB" style="display:none;" data-lan-eng="Save">Save</button>
					<button type="button" id="cancelCustomerBtn" class="jw-button typeD" style="display:none;" data-lan-eng="Cancel">Cancel</button>
				</div>
			</div>
			<div class="card-panel jw-mgt16">
				<div class="grid-wrap">
					<div class="grid-item">
						<label class="label-name" for="cust_name" data-lan-eng="Name">Name</label>
						<input id="cust_name" type="text" class="form-control" value="" disabled>
					</div>

					<div class="grid-item">
						<label class="label-name" for="cust_email" data-lan-eng="Email">Email</label>
						<input id="cust_email" type="email" class="form-control" value="" disabled>
					</div>

					<div class="grid-item">
						<label class="label-name" for="cust_phone" data-lan-eng="Contact">Contact</label>
						<input id="cust_phone" type="text" class="form-control" value="" disabled>
					</div>
				</div>
			</div>

			<div class="jw-cols jw-between jw-mgt32">
				<h2 class="section-title" data-lan-eng="Traveler Information">Traveler Information</h2>
			</div>
			<div class="card-panel jw-mgt16">
				<div class="traveler-summary-section">
					<div class="traveler-summary-header">
						<span class="traveler-summary-count" id="traveler-summary-count">0 Travelers</span>
						<button type="button" id="editTravelerBtn" class="jw-button typeA" style="display:none;" data-lan-eng="Edit">Edit</button>
					</div>
					<div class="traveler-summary-list" id="traveler-summary-list">
						<p class="no-traveler-message" data-lan-eng="No travelers information.">No travelers information.</p>
					</div>
				</div>
			</div>

			<!-- Traveler Detail Modal (View Only) -->
			<div id="travelerDetailModal" class="modal" style="display:none;">
				<div class="modal-content" style="max-width: 600px;">
					<div class="modal-header">
						<h3 id="travelerModalTitle" data-lan-eng="Traveler Details">Traveler Details</h3>
						<button type="button" class="modal-close" onclick="closeTravelerModal()">
							<img src="../image/button-close2.svg" alt="">
						</button>
					</div>
					<div class="modal-body">
						<div class="grid-wrap">
							<div class="grid-item">
								<label class="label-name" data-lan-eng="Traveler Type">Traveler Type</label>
								<input type="text" id="modal_traveler_type_display" class="form-control" disabled>
							</div>
							<div class="grid-item">
								<label class="label-name" data-lan-eng="Title">Title</label>
								<input type="text" id="modal_traveler_title_display" class="form-control" disabled>
							</div>
							<div class="grid-item">
								<label class="label-name" data-lan-eng="Gender">Gender</label>
								<input type="text" id="modal_traveler_gender_display" class="form-control" disabled>
							</div>
							<div class="grid-item">
								<label class="label-name" data-lan-eng="First Name">First Name</label>
								<input type="text" id="modal_traveler_firstname_display" class="form-control" disabled>
							</div>
							<div class="grid-item">
								<label class="label-name" data-lan-eng="Last Name">Last Name</label>
								<input type="text" id="modal_traveler_lastname_display" class="form-control" disabled>
							</div>
							<div class="grid-item">
								<label class="label-name" data-lan-eng="Date of Birth">Date of Birth</label>
								<input type="text" id="modal_traveler_birthdate_display" class="form-control" disabled>
							</div>
							<div class="grid-item">
								<label class="label-name" data-lan-eng="Nationality">Nationality</label>
								<input type="text" id="modal_traveler_nationality_display" class="form-control" disabled>
							</div>
							<div class="grid-item">
								<label class="label-name" data-lan-eng="Passport Number">Passport Number</label>
								<input type="text" id="modal_traveler_passport_display" class="form-control" disabled>
							</div>
							<div class="grid-item">
								<label class="label-name" data-lan-eng="Passport Expiry">Passport Expiry</label>
								<input type="text" id="modal_traveler_passport_expiry_display" class="form-control" disabled>
							</div>
							<div class="grid-item col-span-3" id="passport_image_section">
								<label class="label-name" data-lan-eng="Passport Image">Passport Image</label>
								<div id="passport_image_container" style="margin-top: 8px;">
									<p class="no-traveler-message" style="padding: 12px;">No passport image</p>
								</div>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="jw-button typeD" onclick="closeTravelerModal()" data-lan-eng="Close">Close</button>
					</div>
				</div>
			</div>

			<!-- Traveler Edit Modal (All Travelers) -->
			<div id="travelerEditAllModal" class="modal" style="display:none;">
				<div class="modal-content modal-traveler">
					<div class="modal-header">
						<h3 data-lan-eng="Edit Travelers">Edit Travelers</h3>
						<button type="button" class="modal-close" onclick="closeTravelerEditModal()">
							<img src="../image/button-close2.svg" alt="">
						</button>
					</div>
					<div class="modal-body traveler-modal-body">
						<!-- ÏôºÏ™Ω: Î©îÏù∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ -->
						<div class="traveler-modal-main">
							<div class="traveler-cards-header">
								<span class="traveler-count" id="traveler-edit-count">0 Travelers</span>
								<div class="traveler-cards-actions">
									<button type="button" class="jw-button typeA" onclick="addTravelerCardInEdit()">+ Add Traveler</button>
								</div>
							</div>
							<div class="traveler-cards-container" id="traveler-cards-container">
								<!-- ÎèôÏ†ÅÏúºÎ°ú Ïó¨ÌñâÏûê Ïπ¥ÎìúÎì§Ïù¥ Ï∂îÍ∞ÄÎê® -->
							</div>
						</div>
						<!-- Ïò§Î•∏Ï™Ω: ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏÇ¨Ïù¥ÎìúÎ∞î -->
						<div class="traveler-modal-sidebar" id="traveler-modal-sidebar">
							<div class="sidebar-title" data-lan-eng="Travelers">Travelers</div>
							<div class="sidebar-nav-list" id="traveler-sidebar-nav">
								<!-- Ïó¨ÌñâÏûê ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏïÑÏù¥ÌÖúÏù¥ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="jw-button typeB" onclick="saveAllTravelers()" data-lan-eng="Save">Save</button>
						<button type="button" class="jw-button typeD" onclick="closeTravelerEditModal()" data-lan-eng="Cancel">Cancel</button>
					</div>
				</div>
			</div>

		</section>

	</main>

	<!-- ÌïòÎã® Í≥†Ï†ï Ïï°ÏÖò Î∞î -->
	<div class="fixed-bottom-bar">
		<!-- Pending ÏÉÅÌÉúÏùº Îïå ÌëúÏãú -->
		<div id="pendingActions" style="display: none; gap: 12px;">
			<button type="button" class="jw-button" id="rejectBookingBtn" style="background: #ef4444; color: #fff; padding: 10px 24px; border-radius: 8px;" data-lan-eng="Reject">Reject</button>
			<button type="button" class="jw-button" id="approveBookingBtn" style="background: #22c55e; color: #fff; padding: 10px 24px; border-radius: 8px;" data-lan-eng="Approve">Approve</button>
		</div>
		<!-- Pending Ïô∏ ÏÉÅÌÉúÏùº Îïå ÌëúÏãú -->
		<button type="button" class="jw-button typeB" id="saveBtn" data-lan-eng="Save">Save</button>
	</div>

	<style>
		.layout-main {
			padding-bottom: 60px !important;
		}
		.fixed-bottom-bar {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			height: 60px;
			background: #fff;
			border-top: 1px solid #e0e0e0;
			display: flex;
			align-items: center;
			justify-content: flex-end;
			padding: 0 24px;
			z-index: 100;
		}
		/* Traveler Summary Styles */
		.traveler-summary-section {
			padding: 8px 0;
		}
		.traveler-summary-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 16px;
		}
		.traveler-summary-count {
			font-size: 16px;
			font-weight: 600;
			color: #374151;
		}
		.traveler-summary-list {
			display: flex;
			flex-direction: column;
			gap: 8px;
			min-height: 72px;
		}
		.traveler-summary-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 16px;
			background: #F9FAFB;
			border-radius: 8px;
			border: 1px solid #E5E7EB;
			cursor: pointer;
			transition: all 0.2s;
		}
		.traveler-summary-item:hover {
			background: #F3F4F6;
		}
		.traveler-summary-item.is-primary {
			background: #F7FAFF;
			border-color: #0050C8;
		}
		.traveler-summary-info {
			display: flex;
			align-items: center;
			gap: 12px;
		}
		.traveler-summary-info .badge-primary {
			background: #0050C8;
			color: #fff;
			padding: 2px 8px;
			border-radius: 4px;
			font-size: 11px;
			font-weight: 500;
		}
		.traveler-summary-info .badge-type {
			background: #E5E7EB;
			color: #374151;
			padding: 2px 8px;
			border-radius: 4px;
			font-size: 11px;
			font-weight: 500;
		}
		.traveler-summary-name {
			font-weight: 500;
			color: #111827;
		}
		.traveler-summary-details {
			color: #6B7280;
			font-size: 13px;
			display: flex;
			gap: 16px;
		}
		.traveler-summary-details span {
			display: flex;
			align-items: center;
			gap: 4px;
		}
		.no-traveler-message {
			text-align: center;
			padding: 24px;
			color: #9CA3AF;
		}
		.traveler-detail-btn {
			color: #6B7280;
			font-size: 13px;
			display: flex;
			align-items: center;
			gap: 4px;
		}
		.traveler-detail-btn:hover {
			color: #0050C8;
		}
		/* Traveler Edit Card Styles */
		.traveler-edit-card {
			background: #F9FAFB;
			border: 1px solid #E5E7EB;
			border-radius: 12px;
			padding: 20px;
			margin-bottom: 16px;
		}
		.traveler-edit-card.is-primary {
			background: #F0F7FF;
			border-color: #0050C8;
		}
		.traveler-edit-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 16px;
			padding-bottom: 12px;
			border-bottom: 1px solid #E5E7EB;
		}
		.traveler-edit-header h4 {
			margin: 0;
			font-size: 16px;
			font-weight: 600;
			color: #111827;
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.traveler-edit-header .badge-primary {
			background: #0050C8;
			color: #fff;
			padding: 2px 8px;
			border-radius: 4px;
			font-size: 11px;
		}
		.traveler-edit-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 16px;
		}
		.traveler-edit-grid .form-group {
			display: flex;
			flex-direction: column;
			gap: 4px;
		}
		.traveler-edit-grid .form-group label {
			font-size: 13px;
			font-weight: 500;
			color: #374151;
		}
		.traveler-edit-grid .form-group.full-width {
			grid-column: span 3;
		}
		.passport-upload-area {
			display: flex;
			align-items: center;
			gap: 16px;
			padding: 12px;
			background: #fff;
			border: 1px dashed #D1D5DB;
			border-radius: 8px;
		}
		.passport-preview {
			width: 120px;
			height: 80px;
			object-fit: cover;
			border-radius: 4px;
			border: 1px solid #E5E7EB;
		}
		.passport-upload-btns {
			display: flex;
			gap: 8px;
		}
		@media (max-width: 768px) {
			.traveler-edit-grid {
				grid-template-columns: 1fr;
			}
			.traveler-edit-grid .form-group.full-width {
				grid-column: span 1;
			}
		}
		/* Modal Traveler Styles (create-reservation style) */
		.modal-traveler {
			max-width: 1400px !important;
			width: 95vw !important;
			max-height: 90vh !important;
			display: flex;
			flex-direction: column;
		}
		.traveler-modal-body {
			flex: 1;
			overflow: hidden;
			padding: 0 !important;
			display: flex;
			gap: 0;
		}
		/* ÏôºÏ™Ω Î©îÏù∏ ÏòÅÏó≠ */
		.traveler-modal-main {
			flex: 1;
			overflow-y: auto;
			min-width: 0;
		}
		/* Ïò§Î•∏Ï™Ω ÏÇ¨Ïù¥ÎìúÎ∞î */
		.traveler-modal-sidebar {
			width: 220px;
			flex-shrink: 0;
			background: #F9FAFB;
			border-left: 1px solid #E5E7EB;
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}
		.traveler-modal-sidebar .sidebar-title {
			padding: 16px 20px;
			font-size: 14px;
			font-weight: 600;
			color: #374151;
			border-bottom: 1px solid #E5E7EB;
			background: #fff;
		}
		.traveler-modal-sidebar .sidebar-nav-list {
			flex: 1;
			overflow-y: auto;
			padding: 12px;
		}
		.traveler-modal-sidebar .sidebar-nav-item {
			display: flex;
			align-items: center;
			gap: 10px;
			padding: 12px 14px;
			margin-bottom: 6px;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.15s;
			border: 1px solid transparent;
		}
		.traveler-modal-sidebar .sidebar-nav-item:hover {
			background: #fff;
			border-color: #E5E7EB;
		}
		.traveler-modal-sidebar .sidebar-nav-item.active {
			background: #EFF6FF;
			border-color: #0050C8;
		}
		.traveler-modal-sidebar .sidebar-nav-item.is-primary {
			background: #F0F9FF;
		}
		.traveler-modal-sidebar .nav-item-number {
			width: 24px;
			height: 24px;
			display: flex;
			align-items: center;
			justify-content: center;
			background: #E5E7EB;
			border-radius: 50%;
			font-size: 12px;
			font-weight: 600;
			color: #374151;
			flex-shrink: 0;
		}
		.traveler-modal-sidebar .sidebar-nav-item.is-primary .nav-item-number {
			background: #0050C8;
			color: #fff;
		}
		.traveler-modal-sidebar .nav-item-info {
			flex: 1;
			min-width: 0;
			overflow: hidden;
		}
		.traveler-modal-sidebar .nav-item-name {
			font-size: 13px;
			font-weight: 500;
			color: #111827;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}
		.traveler-modal-sidebar .nav-item-type {
			font-size: 11px;
			color: #6B7280;
			margin-top: 2px;
		}
		.traveler-modal-sidebar .nav-item-badge {
			font-size: 9px;
			padding: 2px 6px;
			background: #0050C8;
			color: #fff;
			border-radius: 3px;
			flex-shrink: 0;
		}
		.traveler-cards-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 16px 24px;
			border-bottom: 1px solid #E5E7EB;
			position: sticky;
			top: 0;
			background: #fff;
			z-index: 10;
		}
		.traveler-count {
			font-size: 16px;
			font-weight: 600;
			color: #374151;
		}
		.traveler-cards-actions {
			display: flex;
			gap: 8px;
		}
		.traveler-cards-container {
			padding: 16px 24px;
			display: flex;
			flex-direction: column;
			gap: 16px;
		}
		.traveler-card {
			background: #fff;
			border: 1px solid #E5E7EB;
			border-radius: 12px;
			overflow: hidden;
		}
		.traveler-card.is-primary {
			border: 2px solid #0050C8;
		}
		.traveler-card-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 16px;
			background: #F9FAFB;
			border-bottom: 1px solid #E5E7EB;
		}
		.traveler-card.is-primary .traveler-card-header {
			background: #EBF4FF;
		}
		.traveler-card-title {
			display: flex;
			align-items: center;
			gap: 8px;
			font-weight: 600;
			color: #111827;
		}
		.traveler-card-title .badge-primary {
			background: #0050C8;
			color: #fff;
			font-size: 11px;
			padding: 2px 8px;
			border-radius: 4px;
			font-weight: 500;
		}
		.traveler-card-actions {
			display: flex;
			gap: 8px;
		}
		.btn-set-primary {
			padding: 6px 12px;
			font-size: 12px;
			border: 1px solid #0050C8;
			background: #fff;
			color: #0050C8;
			border-radius: 6px;
			cursor: pointer;
			transition: all 0.2s;
		}
		.btn-set-primary:hover {
			background: #0050C8;
			color: #fff;
		}
		.btn-delete-traveler {
			padding: 6px 12px;
			font-size: 12px;
			border: 1px solid #DC2626;
			background: #fff;
			color: #DC2626;
			border-radius: 6px;
			cursor: pointer;
			transition: all 0.2s;
		}
		.btn-delete-traveler:hover {
			background: #DC2626;
			color: #fff;
		}
		.traveler-card-body {
			padding: 16px;
		}
		.traveler-card-grid {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 16px;
		}
		.traveler-card-grid .form-group {
			display: flex;
			flex-direction: column;
			gap: 4px;
		}
		.traveler-card-grid .form-group label {
			font-size: 13px;
			font-weight: 500;
			color: #374151;
		}
		.traveler-card-grid .form-group.full-width {
			grid-column: span 4;
		}
		.traveler-card-grid .form-group.half-width {
			grid-column: span 2;
		}
		.traveler-cards-container select {
			display: block !important;
			width: 100% !important;
			height: 40px !important;
			padding: 0 12px !important;
			border: 1px solid #D1D5DB !important;
			border-radius: 6px !important;
			font-size: 14px !important;
			background-color: #fff !important;
			cursor: pointer !important;
			appearance: auto !important;
			-webkit-appearance: auto !important;
			-moz-appearance: auto !important;
		}
		.traveler-cards-container select:focus {
			outline: none;
			border-color: #0050C8 !important;
		}
		.passport-photo-section {
			display: flex;
			align-items: center;
			gap: 16px;
			padding: 12px;
			background: #F9FAFB;
			border: 1px dashed #D1D5DB;
			border-radius: 8px;
		}
		.passport-photo-preview {
			width: 120px;
			height: 80px;
			object-fit: cover;
			border-radius: 4px;
			border: 1px solid #E5E7EB;
			background: #fff;
		}
		.passport-photo-btns {
			display: flex;
			gap: 8px;
		}
		@media (max-width: 992px) {
			.traveler-card-grid {
				grid-template-columns: repeat(2, 1fr);
			}
			.traveler-card-grid .form-group.full-width {
				grid-column: span 2;
			}
			.traveler-card-grid .form-group.half-width {
				grid-column: span 1;
			}
		}
		@media (max-width: 576px) {
			.traveler-card-grid {
				grid-template-columns: 1fr;
			}
			.traveler-card-grid .form-group.full-width,
			.traveler-card-grid .form-group.half-width {
				grid-column: span 1;
			}
			.traveler-cards-header {
				flex-direction: column;
				gap: 12px;
				align-items: flex-start;
			}
		}
	</style>

	<!-- Base scripts -->
	<script src="../js/default.js"></script>
	<script src="../js/super.js"></script>
	<script src="../js/datepicker.js"></script>
	<script src="../js/passport-photo.js"></script>

	<script>
		init({
			headerUrl: '../inc/header.html',
			navUrl: '../inc/nav_super.html'
		});

		let bookingId = null;
		let allTravelers = [];
		let travelersPage = 1;
		const travelersPageSize = 10;
		let lastLoadedBooking = null;
		let __isSuperAdmin = false; // ÏµúÍ≥†Í¥ÄÎ¶¨ÏûêÎßå Customer/Traveler Ìé∏Ïßë Í∞ÄÎä•

		document.addEventListener('DOMContentLoaded', async () => {
			// Force English on this page (no Korean allowed).
			try {
				if (typeof setCookie === 'function') setCookie('lang', 'eng', 365);
				if (typeof language_apply === 'function') language_apply('eng');
			} catch (_) { }

			try {
				const sessionResponse = await fetch('../backend/api/check-session.php', { credentials: 'same-origin' });
				const sessionData = await sessionResponse.json().catch(() => ({}));
				if (!sessionData.authenticated || (sessionData.userType !== 'admin' && sessionData.userType !== 'super')) {
					window.location.href = '../index.html';
					return;
				}
				// ÏµúÍ≥†Í¥ÄÎ¶¨Ïûê ÌåêÏ†ï(ÏÑúÎ≤Ñ Ï†ïÏ±ÖÍ≥º ÎèôÏùºÌïòÍ≤å accountId=6 ÎòêÎäî admin@smarttravel.com)
				try {
					const qp0 = new URLSearchParams(window.location.search);
					const testAdmin = qp0.get('test_admin');
					__isSuperAdmin =
						(testAdmin === 'super_admin') ||
						(String(sessionData.accountId || '') === '6') ||
						(String(sessionData.emailAddress || '').toLowerCase() === 'admin@smarttravel.com');
				} catch (_) { __isSuperAdmin = false; }

				const urlParams = new URLSearchParams(window.location.search);
				bookingId = urlParams.get('id') || urlParams.get('bookingId');
				if (!bookingId) return;

				// Link out (guide-created content in guide front)
				try {
					const loc = document.getElementById('meetingLocationLink');
					const noti = document.getElementById('announcementsLink');
					if (loc) loc.href = `../common/reservation-location.html?bookingId=${encodeURIComponent(bookingId)}`;
					if (noti) noti.href = `../common/reservation-notices.html?bookingId=${encodeURIComponent(bookingId)}`;
				} catch (_) { }

				const saveBtn = document.getElementById('saveBtn');
				if (saveBtn) saveBtn.addEventListener('click', handleSave);

				// Pending ÏÉÅÌÉú Approve/Reject Î≤ÑÌäº Ïù¥Î≤§Ìä∏
				const approveBookingBtn = document.getElementById('approveBookingBtn');
				const rejectBookingBtn = document.getElementById('rejectBookingBtn');
				if (approveBookingBtn) approveBookingBtn.addEventListener('click', handleApproveBooking);
				if (rejectBookingBtn) rejectBookingBtn.addEventListener('click', handleRejectBooking);

				// Edit Allowed ÌÜ†Í∏Ä Î≤ÑÌäº Ïù¥Î≤§Ìä∏
				const toggleEditAllowedBtn = document.getElementById('toggleEditAllowedBtn');
				if (toggleEditAllowedBtn) toggleEditAllowedBtn.addEventListener('click', handleToggleEditAllowed);

				// SMT ÏàòÏ†ï ÏãúÏûë - ÏÑ†Í∏à Ï¶ùÎπô ÌååÏùº ÏóÖÎ°úÎìú Ïù¥Î≤§Ìä∏
				const depositProofUpload = document.getElementById('depositProofUpload');
				if (depositProofUpload) depositProofUpload.addEventListener('change', handleDepositProofUpload);
				// SMT ÏàòÏ†ï ÏôÑÎ£å

				await loadCountryCodesForCustomerPhone();
				await loadBookingDetail();
				await loadGuides();
			} catch (error) {
				console.error('Session check error:', error);
				window.location.href = '../index.html';
			}
		});

		async function loadCountryCodesForCustomerPhone() {
			const codeEl = document.getElementById('customerPhoneCode');
			if (!codeEl) return;
			try {
				const res = await fetch('/backend/api/countries.php', { credentials: 'same-origin' });
				const json = await res.json().catch(() => ({}));
				if (!res.ok || !json.success || !Array.isArray(json.countries)) return;

				const prev = String(codeEl.dataset.pendingCode || codeEl.value || '+63');
				codeEl.innerHTML = json.countries
					.map(c => {
						const code = String(c.code || '').trim();
						const name = String(c.name || '').trim();
						const label = name ? `${name} (${code})` : code;
						return `<option value="${escapeHtml(code)}">${escapeHtml(label)}</option>`;
					})
					.join('');
				codeEl.value = prev;
				if (!codeEl.value && prev) codeEl.value = prev;
				delete codeEl.dataset.pendingCode;
				await ensureJwSelectReady(codeEl);
				refreshJwSelect(codeEl);
			} catch (_) { }
		}

		// jw_selectÎäî ÏòµÏÖò Î≥ÄÍ≤ΩÏùÑ ÏûêÎèô Î∞òÏòÅÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú, ÌäπÏ†ï selectÏùò wrapperÎ•º ÏòµÏÖò/disabled/selected ÏÉÅÌÉúÏóê ÎßûÍ≤å ÎèôÍ∏∞ÌôîÌïúÎã§.
		async function ensureJwSelectReady(nativeSel, timeoutMs = 2000) {
			if (!nativeSel) return;
			if (nativeSel.closest('.jw-select')) return;
			if (typeof jw_select === 'function') {
				try { jw_select(); } catch (_) { }
			}
			const start = Date.now();
			while (Date.now() - start < timeoutMs) {
				if (nativeSel.closest('.jw-select')) return;
				await new Promise(r => setTimeout(r, 50));
			}
		}

		function refreshJwSelect(nativeSel) {
			if (!nativeSel) return;
			const wrap = nativeSel.closest('.jw-select');
			if (!wrap) return;
			const box = wrap.querySelector('.jw-selected');
			const list = wrap.querySelector('.jw-select-list');
			if (!box || !list) return;

			if (nativeSel.disabled) {
				wrap.classList.add('is-disabled');
				box.setAttribute('aria-disabled', 'true');
				box.tabIndex = -1;
			} else {
				wrap.classList.remove('is-disabled');
				box.removeAttribute('aria-disabled');
				box.tabIndex = 0;
			}

			const opt = nativeSel.selectedOptions?.[0] || nativeSel.options?.[0];
			box.textContent = opt ? (opt.textContent || '') : '';

			list.innerHTML = '';
			Array.from(nativeSel.options || []).forEach((o) => {
				const li = document.createElement('li');
				li.className = 'jw-select-item';
				li.setAttribute('role', 'option');
				li.dataset.value = o.value;
				li.textContent = o.textContent || '';
				if (o.disabled) {
					li.setAttribute('aria-disabled', 'true');
					li.classList.add('is-disabled');
				}
				if (o.selected) li.setAttribute('aria-selected', 'true');
				list.appendChild(li);
			});
		}

		async function loadGuides() {
			try {
				const response = await fetch('../backend/api/super-api.php?action=getContractGuides', { credentials: 'same-origin' });
				if (!response.ok) {
					if (response.status === 401 || response.status === 403) {
						window.location.href = '../index.html';
						return;
					}
					throw new Error('HTTP ' + response.status);
				}
				const result = await response.json().catch(() => ({}));
				if (!result.success || !result.data || !Array.isArray(result.data.guides)) return;

				const guideSelect = document.getElementById('guideSelect');
				if (!guideSelect) return;

				const guides = result.data.guides;
				guideSelect.innerHTML =
					'<option value="" selected data-lan-eng="Guide not assigned">Guide not assigned</option>' +
					guides.map(g => `<option value="${escapeHtml(g.guideId || '')}">${escapeHtml(g.guideName || '')}</option>`).join('');

				// If booking already has guideId, reflect it.
				try {
					if (lastLoadedBooking && lastLoadedBooking.guideId) guideSelect.value = String(lastLoadedBooking.guideId);
				} catch (_) { }

				// Sync custom select UI
				try { if (typeof refreshAllJwSelect === 'function') refreshAllJwSelect(); } catch (_) { }
			} catch (error) {
				console.error('Error loading guides:', error);
			}
		}

		async function loadBookingDetail() {
			try {
				const response = await fetch(`../backend/api/super-api.php?action=getB2BBookingDetail&id=${encodeURIComponent(bookingId)}`, { credentials: 'same-origin' });
				if (!response.ok) {
					if (response.status === 401 || response.status === 403) {
						window.location.href = '../index.html';
						return;
					}
					throw new Error('HTTP ' + response.status);
				}

				const result = await response.json().catch(() => ({}));
				if (!result.success || !result.data || !result.data.booking) return;

				const booking = result.data.booking || {};
				lastLoadedBooking = booking;
				allTravelers = Array.isArray(booking.travelers) ? booking.travelers : [];

				// Edit Allowed ÏÉÅÌÉú Î∞òÏòÅ
				const isEditAllowed = parseInt(booking.edit_allowed || 0) === 1;
				updateEditAllowedUI(isEditAllowed);

				// Product
				setValue('packageName', booking.packageName || '');
				setValue('travelPeriod', formatPeriod(booking.departureDate, booking.returnDate));
				setValue('meetingTime', formatMeetingTime(booking));
				setValue('meetingLocation', booking.meetingLocation || booking.meetingPoint || '');

				// Reservation
				setValue('bookingNo', booking.reservationNo || booking.bookingId || bookingId || '');
				setValue('bookingDate', formatDateTime(booking.createdAt));
				setValue('reservationPeople', formatReservationPeople(booking, result?.data?.selectedOptions, allTravelers));
				setValue('roomOption', result?.data?.roomSummary || '-');
				// Room option Í¥ÄÎ†® Î≥ÄÏàò ÏÑ§Ï†ï
				currentPackageId = booking.packageId;
				originalTravelerCount = (allTravelers || []).filter(t => {
					const type = (t.type || t.travelerType || '').toLowerCase();
					return type === 'adult' || type === 'child';
				}).length;

				// SMT ÏàòÏ†ï ÏãúÏûë - ÏòµÏÖò ÏÑ†ÌÉù Í∞í ÏÑ∏ÌåÖ
				setSelectValue('cabinBaggageSelect', booking.cabinBaggage || '');
				setSelectValue('breakfastSelect', booking.breakfastRequest || '');
				setSelectValue('wifiSelect', booking.wifiRental || '');
				// SMT ÏàòÏ†ï ÏôÑÎ£å
				setTextArea('seatRequest', booking.seatRequest || '');
				setTextArea('otherRequest', booking.otherRequest || '');

				// Payment - 3Îã®Í≥Ñ Í≤∞Ï†ú Ï†ïÎ≥¥ ÌëúÏãú
				setValue('totalAmount', formatNumber(booking.totalAmount));
				updatePaymentSections(booking);

				// Agent
				setValue('agentBranchName', booking.branchName || booking.companyName || booking.agentName || '');
				setValue('agentManagerName', booking.agentManagerName || '');
				setValue('agentManagerEmail', booking.agentManagerEmail || '');
				setValue('agentManagerContact', booking.agentManagerContact || '');
				setValue('depositRatio', booking.depositRatio || '');
				setTextArea('agentMemo', booking.specialRequests || booking.agentMemo || '');

				// Customer - ÏÉàÎ°úÏö¥ ÌïÑÎìú ID ÏÇ¨Ïö©
				setValue('cust_name', booking.customerName || booking.reserverName || '');
				setValue('cust_email', booking.customerEmail || '');
				setValue('cust_phone', booking.customerContact || '');

				// ÏµúÍ≥†Í¥ÄÎ¶¨ÏûêÎßå Customer/Traveler Ìé∏Ïßë Î≤ÑÌäº ÌëúÏãú
				initCustomerEditButtons();
				initTravelerEditButtons();

				// Flights
				try {
					let flights = booking.flights || {};
					if (Array.isArray(flights)) flights = {};
					const dep = flights.departure || flights.outbound || flights.DEPARTURE || flights.OUTBOUND || {};
					const ret = flights.return || flights.RETURN || {};
					setFlight('departure', dep);
					setFlight('return', ret);
				} catch (_) { }

				// Toolbar status/guide
				const statusSel = document.getElementById('reservationStatusSelect');
				if (statusSel) statusSel.value = computeUiStatus(booking);
				const guideSel = document.getElementById('guideSelect');
				if (guideSel && booking.guideId) guideSel.value = String(booking.guideId);

				// ÌôòÎ∂à ÏôÑÎ£å Ï†ÄÏû• Ïù¥ÌõÑÏóêÎäî ÏÉÅÌÉú Î≥ÄÍ≤Ω Î∂àÍ∞Ä(Ï†ÑÏ≤¥/Í∞úÎ≥Ñ)
				applyRefundStatusLock();

				// Travelers
				travelersPage = 1;
				renderTravelers();
				renderTravelersPager();

				// Ensure custom selects reflect updated option text
				try { if (typeof refreshAllJwSelect === 'function') refreshAllJwSelect(); } catch (_) { }
			} catch (error) {
				console.error('Error loading booking detail:', error);
			}
		}

		function applySuperAdminEditableState() {
			// Ïù¥Ï†ú initCustomerEditButtons()ÏóêÏÑú Ï≤òÎ¶¨Îê® - Ïù¥ Ìï®ÏàòÎäî Ìò∏ÌôòÏÑ±ÏùÑ ÏúÑÌï¥ Ïú†ÏßÄ
		}

		function applyRefundStatusLock() {
			const currentStatus = computeUiStatus(lastLoadedBooking || {});
			const isRefunded = currentStatus === 'refunded';
			const isPending = currentStatus === 'pending';

			const statusSel = document.getElementById('reservationStatusSelect');
			const saveBtn = document.getElementById('saveBtn');
			const pendingActions = document.getElementById('pendingActions');

			// Refunded ÏÉÅÌÉú: ÏÉÅÌÉú Î≥ÄÍ≤Ω Î∂àÍ∞Ä
			if (statusSel) statusSel.disabled = isRefunded || isPending;

			// Pending ÏÉÅÌÉú: Save Î≤ÑÌäº Ïà®Í∏∞Í≥† Approve/Reject Î≤ÑÌäº ÌëúÏãú
			if (isPending) {
				if (saveBtn) saveBtn.style.display = 'none';
				if (pendingActions) pendingActions.style.display = 'flex';
			} else {
				if (saveBtn) saveBtn.style.display = '';
				if (pendingActions) pendingActions.style.display = 'none';
			}

			// travelersÎäî render ÏãúÏóê disabled Ï≤òÎ¶¨
		}

		// Pending ÏÉÅÌÉú ÏòàÏïΩ ÏäπÏù∏
		async function handleApproveBooking() {
			if (!confirm('Ïù¥ ÏòàÏïΩÏùÑ ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nApprove this booking?')) return;

			try {
				const formData = new FormData();
				formData.append('action', 'approveB2BBooking');
				formData.append('bookingId', bookingId);

				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					body: formData,
					credentials: 'same-origin'
				});

				const result = await response.json();

				if (result.success) {
					alert('ÏòàÏïΩÏù¥ ÏäπÏù∏ÎêòÏóàÏäµÎãàÎã§.\nBooking approved.');
					window.location.reload();
				} else {
					alert('ÏäπÏù∏ Ïã§Ìå®: ' + (result.message || 'Unknown error'));
				}
			} catch (error) {
				console.error('Approve error:', error);
				alert('ÏäπÏù∏ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
			}
		}

		// Pending ÏÉÅÌÉú ÏòàÏïΩ Í±∞Ï†à
		async function handleRejectBooking() {
			const reason = prompt('Í±∞Ï†à ÏÇ¨Ïú†Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:\nEnter rejection reason:');
			if (reason === null) return; // Ï∑®ÏÜå

			try {
				const formData = new FormData();
				formData.append('action', 'rejectB2BBooking');
				formData.append('bookingId', bookingId);
				formData.append('reason', reason);

				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					body: formData,
					credentials: 'same-origin'
				});

				const result = await response.json();

				if (result.success) {
					alert('ÏòàÏïΩÏù¥ Í±∞Ï†àÎêòÏóàÏäµÎãàÎã§.\nBooking rejected.');
					window.location.href = 'b2b-booking-list.html';
				} else {
					alert('Í±∞Ï†à Ïã§Ìå®: ' + (result.message || 'Unknown error'));
				}
			} catch (error) {
				console.error('Reject error:', error);
				alert('Í±∞Ï†à Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
			}
		}

		// Edit Allowed ÌÜ†Í∏Ä Ìï∏Îì§Îü¨
		async function handleToggleEditAllowed() {
			if (!bookingId) {
				alert('Booking ID is missing.');
				return;
			}

			try {
				const formData = new FormData();
				formData.append('action', 'toggleEditAllowed');
				formData.append('bookingId', bookingId);

				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					body: formData,
					credentials: 'same-origin'
				});

				const result = await response.json();

				if (result.success) {
					const isAllowed = result.data?.edit_allowed === 1;
					updateEditAllowedUI(isAllowed);
					alert(isAllowed ? 'Edit is now ALLOWED for the agent.' : 'Edit is now LOCKED.');
				} else {
					alert('Failed to toggle edit permission: ' + (result.message || 'Unknown error'));
				}
			} catch (error) {
				console.error('Toggle edit allowed error:', error);
				alert('An error occurred while toggling edit permission.');
			}
		}

		// Edit Allowed UI ÏóÖÎç∞Ïù¥Ìä∏
		function updateEditAllowedUI(isAllowed) {
			const iconEl = document.getElementById('editAllowedIcon');
			const textEl = document.getElementById('editAllowedText');
			const btn = document.getElementById('toggleEditAllowedBtn');

			if (isAllowed) {
				if (iconEl) iconEl.textContent = 'üîì';
				if (textEl) textEl.textContent = 'Lock Edit';
				if (btn) {
					btn.classList.remove('typeC');
					btn.classList.add('typeA');
					btn.style.background = '#10B981';
					btn.style.borderColor = '#10B981';
					btn.style.color = '#fff';
				}
			} else {
				if (iconEl) iconEl.textContent = 'üîí';
				if (textEl) textEl.textContent = 'Allow Edit';
				if (btn) {
					btn.classList.remove('typeA');
					btn.classList.add('typeC');
					btn.style.background = '';
					btn.style.borderColor = '';
					btn.style.color = '';
				}
			}
		}

		async function handleSave() {
			try {
				// Always re-resolve bookingId at save time to avoid accidental null/undefined issues.
				const qp = new URLSearchParams(window.location.search);
				const resolvedBookingId = bookingId || qp.get('id') || qp.get('bookingId') || '';
				if (!resolvedBookingId) {
					alert('Booking ID is missing. Please reload this page.');
					return;
				}

				const guideId = (document.getElementById('guideSelect')?.value || '').trim() || null;
				const statusKey = (document.getElementById('reservationStatusSelect')?.value || 'pending').trim();
				const balanceDueDate = (document.getElementById('travelStartDate')?.value || '').trim() || null;

				// ÌôòÎ∂à ÏôÑÎ£å ÏÉÅÌÉúÎ°ú Ï†ÄÏû•Îêú Ïù¥ÌõÑÏóêÎäî ÏÉÅÌÉúÍ∞í Î≥ÄÍ≤Ω Î∂àÍ∞Ä (UI Î∞©ÏßÄ + ÏÑúÎ≤ÑÏóêÏÑúÎèÑ Ïû¨Í≤ÄÏ¶ù)
				const isAlreadyRefunded = computeUiStatus(lastLoadedBooking || {}) === 'refunded';
				if (isAlreadyRefunded) {
					const currentUi = computeUiStatus(lastLoadedBooking || {});
					if (String(statusKey).toLowerCase() !== String(currentUi).toLowerCase()) {
						alert('Refund Completed ÏÉÅÌÉúÏóêÏÑúÎäî ÏòàÏïΩ ÏÉÅÌÉúÎ•º Î≥ÄÍ≤ΩÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
						return;
					}
				}

				// SMT ÏàòÏ†ï ÏãúÏûë - ÏòµÏÖò Í∞í Ï∂îÍ∞Ä
				const cabinBaggage = (document.getElementById('cabinBaggageSelect')?.value || '').trim() || null;
				const breakfastRequest = (document.getElementById('breakfastSelect')?.value || '').trim() || null;
				const wifiRental = (document.getElementById('wifiSelect')?.value || '').trim() || null;
				// SMT ÏàòÏ†ï ÏôÑÎ£å

				const body = {
					action: 'updateB2BBooking',
					bookingId: resolvedBookingId,
					guideId,
					statusKey,
					balanceDueDate,
					// SMT ÏàòÏ†ï ÏãúÏûë - ÏòµÏÖò Í∞í Ï†ÄÏû•
					cabinBaggage,
					breakfastRequest,
					wifiRental
					// SMT ÏàòÏ†ï ÏôÑÎ£å
				};

				// ÏµúÍ≥†Í¥ÄÎ¶¨Ïûê: Customer/Traveler ÏàòÏ†ïÍ∞í Ìè¨Ìï®(Ïù∏ÏõêÏòµÏÖò read-only)
				if (__isSuperAdmin) {
					const code = String(document.getElementById('customerPhoneCode')?.value || '').trim();
					let phone = String(document.getElementById('customerPhone')?.value || '').trim();
					// SMT ÏàòÏ†ï ÏãúÏûë - Íµ≠Í∞ÄÏΩîÎìú Ï§ëÎ≥µ Î∞©ÏßÄ
					// phoneÏù¥ Ïù¥ÎØ∏ Íµ≠Í∞ÄÏΩîÎìúÎ°ú ÏãúÏûëÌïòÎ©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
					let fullPhone = phone;
					if (code && !phone.startsWith('+')) {
						fullPhone = `${code} ${phone}`.trim();
					}
					// SMT ÏàòÏ†ï ÏôÑÎ£å

					body.customerInfo = {
						name: String(document.getElementById('customerName')?.value || '').trim(),
						email: String(document.getElementById('customerEmail')?.value || '').trim(),
						phone: fullPhone
					};

					body.travelers = (allTravelers || []).map((t) => {
						const id = t.bookingTravelerId;
						// reservationStatus + syncDisabledÎäî ÏÑúÎ≤ÑÏóêÏÑú Ï†ÑÏ≤¥ ÏÉÅÌÉú(statusKey)ÏôÄ ÎπÑÍµêÌï¥ Î≥¥Ï†ï/Ï†ÄÏû•
						return {
							bookingTravelerId: id,
							reservationStatus: t.reservationStatus ?? null,
							statusSyncDisabled: t.statusSyncDisabled ?? null,
							visaStatus: t.visaStatus ?? null,
							title: t.title ?? null,
							firstName: t.firstName ?? t.givenName ?? null,
							lastName: t.lastName ?? t.familyName ?? null,
							gender: t.gender ?? null,
							birthDate: t.birthDate ?? t.dob ?? null,
							age: t.age ?? null,
							nationality: t.nationality ?? null,
							passportNumber: t.passportNumber ?? null,
							passportIssueDate: t.passportIssueDate ?? null,
							passportExpiry: t.passportExpiry ?? t.passportExpireDate ?? null
						};
					});
				}

				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({
						...body
					})
				});

				// Always try to parse server response (even on 4xx) so we can show the real message.
				const result = await response.json().catch(() => ({}));
				if (!response.ok) {
					const msg = result?.message ? String(result.message) : ('HTTP ' + response.status);
					throw new Error(msg);
				}

				if (result.success) {
					alert('Saved.');
					window.location.reload();
					return;
				}
				alert(result.message ? String(result.message) : 'Save failed.');
			} catch (error) {
				console.error('Error saving booking:', error);
				alert(error?.message ? String(error.message) : 'An error occurred while saving.');
			}
		}

		function renderTravelers() {
			// ÏÉàÎ°úÏö¥ Ïπ¥Îìú ÌòïÌÉú UIÎ°ú Î†åÎçîÎßÅ
			const listEl = document.getElementById('traveler-summary-list');
			const countEl = document.getElementById('traveler-summary-count');

			if (!listEl) return;

			if (!Array.isArray(allTravelers) || allTravelers.length === 0) {
				listEl.innerHTML = '<p class="no-traveler-message">No travelers information.</p>';
				if (countEl) countEl.textContent = '0 Travelers';
				return;
			}

			if (countEl) countEl.textContent = `${allTravelers.length} Traveler${allTravelers.length > 1 ? 's' : ''}`;

			listEl.innerHTML = allTravelers.map((t, idx) => {
				const main = String(t.isMainTraveler || t.isMain || '0') === '1';
				const travelerType = String(t.travelerType || '').toLowerCase();
				const typeLabel = travelerType === 'child' ? 'Child' : travelerType === 'infant' ? 'Infant' : 'Adult';
				const firstName = String(t.firstName || t.givenName || '');
				const lastName = String(t.lastName || t.familyName || '');
				const fullName = `${firstName} ${lastName}`.trim() || 'Unnamed';
				const gender = String(t.gender || '').toLowerCase();
				const genderLabel = (gender === 'female' || gender === 'f') ? 'Female' : (gender === 'male' || gender === 'm') ? 'Male' : '-';
				const birth = String(t.birthDate || t.dob || '-');
				const passportNo = String(t.passportNumber || '-');

				return `
					<div class="traveler-summary-item ${main ? 'is-primary' : ''}" onclick="openTravelerModal(${idx})">
						<div class="traveler-summary-info">
							${main ? '<span class="badge-primary">Primary</span>' : ''}
							<span class="badge-type">${escapeHtml(typeLabel)}</span>
							<span class="traveler-summary-name">${escapeHtml(fullName)}</span>
						</div>
						<div class="traveler-summary-details">
							<span>${escapeHtml(genderLabel)}</span>
							<span>DOB: ${escapeHtml(birth)}</span>
							<span>Passport: ${escapeHtml(passportNo)}</span>
						</div>
						<span class="traveler-detail-btn">View Details ‚Üí</span>
					</div>
				`;
			}).join('');
		}

		// Ïó¨ÌñâÏûê ÏÉÅÏÑ∏ Î™®Îã¨ Ïó¥Í∏∞
		function openTravelerModal(index) {
			const t = allTravelers[index];
			if (!t) return;

			const travelerType = String(t.travelerType || '').toLowerCase();
			const typeLabel = travelerType === 'child' ? 'Child' : travelerType === 'infant' ? 'Infant' : 'Adult';
			const title = String(t.title || '-');
			const gender = String(t.gender || '').toLowerCase();
			const genderLabel = (gender === 'female' || gender === 'f') ? 'Female' : (gender === 'male' || gender === 'm') ? 'Male' : '-';
			const firstName = String(t.firstName || t.givenName || '-');
			const lastName = String(t.lastName || t.familyName || '-');
			const birth = String(t.birthDate || t.dob || '-');
			const nationality = String(t.nationality || '-');
			const passportNo = String(t.passportNumber || '-');
			const passportExpiry = String(t.passportExpiry || t.passportExpireDate || '-');
			const passImg = String(t.passportImage || t.passportPhoto || '');

			document.getElementById('modal_traveler_type_display').value = typeLabel;
			document.getElementById('modal_traveler_title_display').value = title;
			document.getElementById('modal_traveler_gender_display').value = genderLabel;
			document.getElementById('modal_traveler_firstname_display').value = firstName;
			document.getElementById('modal_traveler_lastname_display').value = lastName;
			document.getElementById('modal_traveler_birthdate_display').value = birth;
			document.getElementById('modal_traveler_nationality_display').value = nationality;
			document.getElementById('modal_traveler_passport_display').value = passportNo;
			document.getElementById('modal_traveler_passport_expiry_display').value = passportExpiry;

			const imgContainer = document.getElementById('passport_image_container');
			if (imgContainer) {
				if (passImg) {
					imgContainer.innerHTML = `<img src="${escapeHtml(passImg)}" alt="Passport" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 1px solid #E5E7EB;">`;
				} else {
					imgContainer.innerHTML = '<p class="no-traveler-message" style="padding: 12px;">No passport image</p>';
				}
			}

			const modal = document.getElementById('travelerDetailModal');
			if (modal) modal.style.display = 'flex';
		}

		// Ïó¨ÌñâÏûê ÏÉÅÏÑ∏ Î™®Îã¨ Îã´Í∏∞
		function closeTravelerModal() {
			const modal = document.getElementById('travelerDetailModal');
			if (modal) modal.style.display = 'none';
		}

		// ÎÇòÏù¥ Í≥ÑÏÇ∞ Ìï®Ïàò
		function calculateAge(birthDateStr) {
			if (!birthDateStr) return '';
			const today = new Date();
			const birthDate = new Date(birthDateStr);
			if (isNaN(birthDate.getTime())) return '';
			let age = today.getFullYear() - birthDate.getFullYear();
			const monthDiff = today.getMonth() - birthDate.getMonth();
			if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
				age--;
			}
			return age >= 0 ? age : '';
		}

		// ÎÇòÏù¥ Í∏∞Î∞ò Ïó¨ÌñâÏûê Ïú†Ìòï ÏóÖÎç∞Ïù¥Ìä∏
		function updateTravelerAgeInEdit(idx) {
			const card = document.querySelector(`.traveler-card[data-traveler-index="${idx}"]`);
			if (!card) return;
			const dobInput = card.querySelector('[data-field="birthDate"]');
			const ageInput = card.querySelector('[data-field="age"]');
			const typeSelect = card.querySelector('[data-field="travelerType"]');
			if (!dobInput || !ageInput || !typeSelect) return;

			const age = calculateAge(dobInput.value);
			ageInput.value = age;

			if (age !== '') {
				if (age < 2) {
					typeSelect.value = 'infant';
				} else if (age < 12) {
					typeSelect.value = 'child';
				} else {
					typeSelect.value = 'adult';
				}
			}
		}

		// Ïó¨ÌñâÏûê Ìé∏Ïßë Ïπ¥Îìú Î†åÎçîÎßÅ
		function renderTravelerEditCards() {
			const container = document.getElementById('traveler-cards-container');
			const countEl = document.getElementById('traveler-edit-count');
			if (!container) return;

			countEl.textContent = `${allTravelers.length} Traveler${allTravelers.length !== 1 ? 's' : ''}`;

			container.innerHTML = allTravelers.map((t, idx) => {
				const main = String(t.isMainTraveler || t.isMain || '0') === '1';
				const travelerType = String(t.travelerType || 'adult').toLowerCase();
				const title = String(t.title || '').toUpperCase();
				const gender = String(t.gender || '').toLowerCase();
				const genderNorm = (gender === 'female' || gender === 'f') ? 'female' : 'male';
				const firstName = String(t.firstName || t.givenName || '');
				const lastName = String(t.lastName || t.familyName || '');
				const birth = String(t.birthDate || t.dob || '');
				const age = calculateAge(birth);
				const nationality = String(t.nationality || '');
				const passportNo = String(t.passportNumber || '');
				const passportIssue = String(t.passportIssueDate || '');
				const passportExpiry = String(t.passportExpiry || t.passportExpireDate || '');
				const visaRequired = t.visaRequired === true || t.visaRequired === 'true' || t.visaRequired === '1' || String(t.visaType || '').toLowerCase() === 'apply';
				const passImg = String(t.passportImage || t.passportPhoto || '');

				return `
					<div class="traveler-card ${main ? 'is-primary' : ''}" data-traveler-index="${idx}">
						<div class="traveler-card-header">
							<div class="traveler-card-title">
								<span>Traveler ${idx + 1}</span>
								${main ? '<span class="badge-primary">Primary</span>' : ''}
							</div>
							<div class="traveler-card-actions">
								${!main ? `<button type="button" class="btn-set-primary" onclick="setPrimaryTravelerInEdit(${idx})">Set as Primary</button>` : ''}
								${allTravelers.length > 1 ? `<button type="button" class="btn-delete-traveler" onclick="deleteTravelerCardInEdit(${idx})">Delete</button>` : ''}
							</div>
						</div>
						<div class="traveler-card-body">
							<div class="traveler-card-grid">
								<div class="form-group">
									<label>Title</label>
									<select class="form-control" data-field="title">
										<option value="">Select</option>
										<option value="MR" ${title === 'MR' ? 'selected' : ''}>MR</option>
										<option value="MS" ${title === 'MS' ? 'selected' : ''}>MS</option>
									</select>
								</div>
								<div class="form-group">
									<label>Gender</label>
									<select class="form-control" data-field="gender">
										<option value="">Select</option>
										<option value="male" ${genderNorm === 'male' ? 'selected' : ''}>Male</option>
										<option value="female" ${genderNorm === 'female' ? 'selected' : ''}>Female</option>
									</select>
								</div>
								<div class="form-group">
									<label>First Name</label>
									<input type="text" class="form-control" data-field="firstName" value="${escapeHtml(firstName)}" placeholder="First Name">
								</div>
								<div class="form-group">
									<label>Last Name</label>
									<input type="text" class="form-control" data-field="lastName" value="${escapeHtml(lastName)}" placeholder="Last Name">
								</div>
								<div class="form-group">
									<label>Type</label>
									<select class="form-control" data-field="travelerType">
										<option value="adult" ${travelerType === 'adult' ? 'selected' : ''}>Adult</option>
										<option value="child" ${travelerType === 'child' ? 'selected' : ''}>Child</option>
										<option value="infant" ${travelerType === 'infant' ? 'selected' : ''}>Infant</option>
									</select>
								</div>
								<div class="form-group">
									<label>Age</label>
									<input type="text" class="form-control" data-field="age" value="${age}" readonly style="background:#f3f4f6;">
								</div>
								<div class="form-group">
									<label>Date of Birth</label>
									<input type="date" class="form-control" data-field="birthDate" value="${escapeHtml(birth)}" onchange="updateTravelerAgeInEdit(${idx})">
								</div>
								<div class="form-group">
									<label>Nationality</label>
									<input type="text" class="form-control" data-field="nationality" value="${escapeHtml(nationality)}" placeholder="Nationality">
								</div>
								<div class="form-group">
									<label>Passport No.</label>
									<input type="text" class="form-control" data-field="passportNumber" value="${escapeHtml(passportNo)}" placeholder="Passport Number">
								</div>
								<div class="form-group">
									<label>Issue Date</label>
									<input type="date" class="form-control" data-field="passportIssueDate" value="${escapeHtml(passportIssue)}">
								</div>
								<div class="form-group">
									<label>Expiry</label>
									<input type="date" class="form-control" data-field="passportExpiry" value="${escapeHtml(passportExpiry)}">
								</div>
								<div class="form-group">
									<label>Visa Application</label>
									<select class="form-control" data-field="visaRequired">
										<option value="no" ${!visaRequired ? 'selected' : ''}>No</option>
										<option value="apply" ${visaRequired ? 'selected' : ''}>Apply</option>
									</select>
								</div>
								<div class="form-group full-width">
									<label>Passport Photo</label>
									<div class="passport-photo-section">
										<img class="passport-photo-preview" id="passport-preview-${idx}" src="${passImg || '../image/no-image.svg'}" alt="Passport" onerror="this.src='../image/no-image.svg'">
										<input type="file" id="passport-file-${idx}" accept="image/*" style="display:none;" onchange="handlePassportPhotoUploadInEdit(${idx}, this)">
										<div class="passport-photo-btns">
											<button type="button" class="jw-button typeA" onclick="document.getElementById('passport-file-${idx}').click()">Upload</button>
											<button type="button" class="jw-button typeD" onclick="removePassportPhotoInEdit(${idx})">Remove</button>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				`;
			}).join('');

			// ÏÇ¨Ïù¥ÎìúÎ∞î Î†åÎçîÎßÅÎèÑ Ìï®Íªò Ìò∏Ï∂ú
			renderTravelerSidebar();
		}

		// Ïó¨ÌñâÏûê ÏÇ¨Ïù¥ÎìúÎ∞î ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î†åÎçîÎßÅ
		function renderTravelerSidebar() {
			const sidebarNav = document.getElementById('traveler-sidebar-nav');
			if (!sidebarNav) return;

			if (allTravelers.length === 0) {
				sidebarNav.innerHTML = '<div style="padding: 20px; text-align: center; color: #9CA3AF; font-size: 13px;">No travelers</div>';
				return;
			}

			let html = '';
			allTravelers.forEach((t, index) => {
				const isPrimary = String(t.isMainTraveler || t.isMain || '0') === '1';
				const firstName = String(t.firstName || t.givenName || '');
				const lastName = String(t.lastName || t.familyName || '');
				const fullName = `${firstName} ${lastName}`.trim() || 'No Name';
				const travelerType = String(t.travelerType || t.type || 'adult').toLowerCase();
				const typeLabel = travelerType.charAt(0).toUpperCase() + travelerType.slice(1);

				html += `
					<div class="sidebar-nav-item ${isPrimary ? 'is-primary' : ''}" data-index="${index}" onclick="scrollToTravelerInEdit(${index})">
						<span class="nav-item-number">${index + 1}</span>
						<div class="nav-item-info">
							<div class="nav-item-name">${escapeHtml(fullName)}</div>
							<div class="nav-item-type">${typeLabel}</div>
						</div>
						${isPrimary ? '<span class="nav-item-badge">Primary</span>' : ''}
					</div>
				`;
			});

			sidebarNav.innerHTML = html;
		}

		// Ìï¥Îãπ traveler Ïπ¥ÎìúÎ°ú Ïä§ÌÅ¨Î°§
		function scrollToTravelerInEdit(index) {
			const container = document.getElementById('traveler-cards-container');
			const mainArea = document.querySelector('.traveler-modal-main');
			if (!container || !mainArea) return;

			const card = container.querySelector(`.traveler-card[data-traveler-index="${index}"]`);
			if (!card) return;

			// Ïä§ÌÅ¨Î°§ Ïï†ÎãàÎ©îÏù¥ÏÖò
			card.scrollIntoView({ behavior: 'smooth', block: 'start' });

			// ÌïòÏù¥ÎùºÏù¥Ìä∏ Ìö®Í≥º
			card.style.transition = 'box-shadow 0.3s';
			card.style.boxShadow = '0 0 0 3px rgba(0, 80, 200, 0.3)';
			setTimeout(() => {
				card.style.boxShadow = '';
			}, 1500);

			// ÏÇ¨Ïù¥ÎìúÎ∞î active ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
			updateSidebarActiveInEdit(index);
		}

		// ÏÇ¨Ïù¥ÎìúÎ∞î active ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
		function updateSidebarActiveInEdit(activeIndex) {
			const sidebarNav = document.getElementById('traveler-sidebar-nav');
			if (!sidebarNav) return;

			const items = sidebarNav.querySelectorAll('.sidebar-nav-item');
			items.forEach((item, i) => {
				if (i === activeIndex) {
					item.classList.add('active');
				} else {
					item.classList.remove('active');
				}
			});
		}

		// Ïó¨ÌñâÏûê Ï∂îÍ∞Ä
		function addTravelerCardInEdit() {
			const newTraveler = {
				travelerType: 'adult',
				title: '',
				gender: '',
				firstName: '',
				lastName: '',
				birthDate: '',
				nationality: '',
				passportNumber: '',
				passportIssueDate: '',
				passportExpiry: '',
				visaRequired: false,
				passportImage: '',
				isMainTraveler: allTravelers.length === 0 ? '1' : '0'
			};
			allTravelers.push(newTraveler);
			renderTravelerEditCards();
		}

		// Ïó¨ÌñâÏûê ÏÇ≠Ï†ú
		function deleteTravelerCardInEdit(idx) {
			if (allTravelers.length <= 1) {
				alert('At least one traveler is required.');
				return;
			}
			const wasPrimary = String(allTravelers[idx].isMainTraveler || allTravelers[idx].isMain || '0') === '1';
			allTravelers.splice(idx, 1);
			if (wasPrimary && allTravelers.length > 0) {
				allTravelers[0].isMainTraveler = '1';
				allTravelers[0].isMain = '1';
			}
			renderTravelerEditCards();
		}

		// ÎåÄÌëú Ïó¨ÌñâÏûê ÏÑ§Ï†ï
		function setPrimaryTravelerInEdit(idx) {
			allTravelers.forEach((t, i) => {
				t.isMainTraveler = i === idx ? '1' : '0';
				t.isMain = i === idx ? '1' : '0';
			});
			renderTravelerEditCards();
		}

		// Ïó¨Í∂å ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú Ï≤òÎ¶¨
		function handlePassportPhotoUploadInEdit(idx, input) {
			const file = input.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = function(e) {
				const preview = document.getElementById(`passport-preview-${idx}`);
				if (preview) preview.src = e.target.result;
				allTravelers[idx].passportImage = e.target.result;
				allTravelers[idx].passportPhoto = e.target.result;
			};
			reader.readAsDataURL(file);
		}

		// Ïó¨Í∂å ÏÇ¨ÏßÑ Ï†úÍ±∞
		function removePassportPhotoInEdit(idx) {
			const preview = document.getElementById(`passport-preview-${idx}`);
			if (preview) preview.src = '../image/no-image.svg';
			allTravelers[idx].passportImage = '';
			allTravelers[idx].passportPhoto = '';
		}

		// Ïó¨ÌñâÏûê Ìé∏Ïßë Î™®Îã¨ Ïó¥Í∏∞
		function openTravelerEditModal() {
			renderTravelerEditCards();
			const modal = document.getElementById('travelerEditAllModal');
			if (modal) modal.style.display = 'flex';
		}

		// Ïó¨ÌñâÏûê Ìé∏Ïßë Î™®Îã¨ Îã´Í∏∞
		function closeTravelerEditModal() {
			const modal = document.getElementById('travelerEditAllModal');
			if (modal) modal.style.display = 'none';
		}

		// Î™®Îì† Ïó¨ÌñâÏûê Ï†ÄÏû•
		async function saveAllTravelers() {
			const cards = document.querySelectorAll('#traveler-cards-container .traveler-card');
			cards.forEach((card) => {
				const idx = parseInt(card.dataset.travelerIndex, 10);
				if (isNaN(idx) || !allTravelers[idx]) return;

				card.querySelectorAll('[data-field]').forEach((input) => {
					const field = input.dataset.field;
					if (field === 'age') return;
					if (field === 'visaRequired') {
						allTravelers[idx][field] = input.value === 'apply';
					} else {
						allTravelers[idx][field] = input.value;
					}
				});
			});

			// ÏÑúÎ≤ÑÏóê Ï†ÄÏû•
			try {
				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({
						action: 'updateB2BBooking',
						bookingId: bookingId,
						travelers: allTravelers
					})
				});
				const result = await response.json().catch(() => ({}));
				if (!response.ok || !result.success) {
					throw new Error(result.message || 'Failed to save travelers');
				}

				// Ïù∏Ïõê Ïàò Î≥ÄÍ≤Ω ÌôïÏù∏ (Adult + ChildÎßå Í≥ÑÏÇ∞)
				const newTravelerCount = (allTravelers || []).filter(t => {
					const type = (t.type || t.travelerType || '').toLowerCase();
					return type === 'adult' || type === 'child';
				}).length;

				closeTravelerEditModal();
				renderTravelers();

				// Ïù∏Ïõê Î≥ÄÍ≤ΩÏù¥ ÏûàÏúºÎ©¥ Room Options Î™®Îã¨ ÎùÑÏö∞Í∏∞
				if (newTravelerCount !== originalTravelerCount) {
					alert('Travelers saved. Please select room options for the updated number of guests.');
					openRoomOptionModal();
				} else {
					alert('Travelers saved successfully.');
				}
			} catch (e) {
				console.error('Error saving travelers:', e);
				alert(e.message || 'An error occurred while saving.');
			}
		}

		// Traveler field helpers
		function __setTravelerField(bookingTravelerId, field, value) {
			const id = String(bookingTravelerId || '').trim();
			if (!id) return;
			const t = (allTravelers || []).find(x => String(x.bookingTravelerId || '') === id);
			if (!t) return;
			t[field] = value;
		}

		function __onTravelerStatusChange(bookingTravelerId, newStatus) {
			const id = String(bookingTravelerId || '').trim();
			const k = String(newStatus || '').trim().toLowerCase();
			const overall = computeUiStatus(lastLoadedBooking || {});
			const t = (allTravelers || []).find(x => String(x.bookingTravelerId || '') === id);
			if (!t) return;

			t.reservationStatus = k;
			// Í∞úÎ≥ÑÎ°ú ÏÉÅÌÉúÍ∞í Î≥ÄÍ≤ΩÌïú Í±¥Ïóê ÎåÄÌï¥ÏÑúÎäî ÎèôÍ∏∞Ìôî Ìï¥Ï†ú(Ï†ÑÏ≤¥ ÏÉÅÌÉúÏôÄ Îã§Î•¥Î©¥)
			if (k && k !== String(overall || '').toLowerCase()) t.statusSyncDisabled = 1;
			else t.statusSyncDisabled = 0; // Îã§Ïãú Í∞ôÍ≤å ÎßûÏ∂îÎ©¥ ÎèôÍ∏∞Ìôî Î≥µÏõê
		}

		async function deleteTravelerPassportImage(bookingTravelerId) {
			if (!__isSuperAdmin) return;
			const tid = String(bookingTravelerId || '').trim();
			if (!tid) return;
			try {
				const res = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({ action: 'deleteTravelerPassportImage', bookingTravelerId: tid })
				});
				const json = await res.json().catch(() => ({}));
				if (!res.ok || !json.success) throw new Error(json.message || `HTTP ${res.status}`);
				// Î°úÏª¨ ÏÉÅÌÉú Î∞òÏòÅ ÌõÑ Ïû¨Î†åÎçî
				const t = (allTravelers || []).find(x => String(x.bookingTravelerId || '') === tid);
				if (t) t.passportImage = '';
				renderTravelers();
			} catch (e) {
				console.error('deleteTravelerPassportImage failed:', e);
				alert(e?.message || 'Failed to delete passport image.');
			}
		}

		async function uploadTravelerPassportImage(bookingTravelerId, file) {
			if (!__isSuperAdmin) return;
			const tid = String(bookingTravelerId || '').trim();
			if (!tid || !file) return;
			try {
				if (file.size > 10 * 1024 * 1024) throw new Error('File size exceeds 10MB limit');
				const allowed = ['image/jpeg', 'image/png', 'image/gif'];
				if (!allowed.includes(file.type)) throw new Error('Invalid file type. Only JPG, PNG, GIF are allowed.');

				const fd = new FormData();
				fd.append('action', 'uploadTravelerPassportImage');
				fd.append('bookingTravelerId', tid);
				fd.append('passportImage', file);

				const res = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					credentials: 'same-origin',
					body: fd
				});
				const json = await res.json().catch(() => ({}));
				if (!res.ok || !json.success) throw new Error(json.message || `HTTP ${res.status}`);

				const path = String(json.data?.filePath || '').trim();
				const t = (allTravelers || []).find(x => String(x.bookingTravelerId || '') === tid);
				if (t) t.passportImage = path;
				renderTravelers();
			} catch (e) {
				console.error('uploadTravelerPassportImage failed:', e);
				alert(e?.message || 'Failed to upload passport image.');
			}
		}

		// ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖòÏùÄ Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå (Ïπ¥Îìú Î¶¨Ïä§Ìä∏Î°ú Ï†ÑÌôò)
		function renderTravelersPager() {
			// No-op: pagination removed in favor of card list
		}

		// Customer Ìé∏Ïßë Î≤ÑÌäº Ï¥àÍ∏∞Ìôî
		let originalCustomerData = {};
		function initCustomerEditButtons() {
			const editBtnsWrap = document.getElementById('customerEditBtns');
			const editBtn = document.getElementById('editCustomerBtn');
			const saveBtn = document.getElementById('saveCustomerBtn');
			const cancelBtn = document.getElementById('cancelCustomerBtn');

			if (!editBtnsWrap) return;

			// ÏµúÍ≥†Í¥ÄÎ¶¨ÏûêÎßå Î≤ÑÌäº ÌëúÏãú
			if (__isSuperAdmin) {
				editBtnsWrap.style.display = 'flex';
				editBtnsWrap.style.gap = '8px';
			}

			if (editBtn) {
				editBtn.addEventListener('click', () => {
					// ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ
					originalCustomerData = {
						name: document.getElementById('cust_name')?.value || '',
						email: document.getElementById('cust_email')?.value || '',
						phone: document.getElementById('cust_phone')?.value || ''
					};

					// ÌïÑÎìú ÌôúÏÑ±Ìôî
					['cust_name', 'cust_email', 'cust_phone'].forEach(id => {
						const el = document.getElementById(id);
						if (el) el.disabled = false;
					});

					editBtn.style.display = 'none';
					if (saveBtn) saveBtn.style.display = 'inline-block';
					if (cancelBtn) cancelBtn.style.display = 'inline-block';
				});
			}

			if (saveBtn) {
				saveBtn.addEventListener('click', async () => {
					try {
						const newName = document.getElementById('cust_name')?.value || '';
						const newEmail = document.getElementById('cust_email')?.value || '';
						const newPhone = document.getElementById('cust_phone')?.value || '';

						const response = await fetch('../backend/api/super-api.php', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							credentials: 'same-origin',
							body: JSON.stringify({
								action: 'updateB2BBooking',
								bookingId: bookingId,
								customerName: newName,
								customerEmail: newEmail,
								customerContact: newPhone
							})
						});
						const result = await response.json().catch(() => ({}));
						if (!response.ok || !result.success) {
							throw new Error(result.message || 'Failed to save customer info');
						}

						alert('Customer information saved successfully.');

						// ÌïÑÎìú ÎπÑÌôúÏÑ±Ìôî
						['cust_name', 'cust_email', 'cust_phone'].forEach(id => {
							const el = document.getElementById(id);
							if (el) el.disabled = true;
						});

						if (editBtn) editBtn.style.display = 'inline-block';
						saveBtn.style.display = 'none';
						if (cancelBtn) cancelBtn.style.display = 'none';
					} catch (e) {
						console.error('Error saving customer info:', e);
						alert(e.message || 'An error occurred while saving.');
					}
				});
			}

			if (cancelBtn) {
				cancelBtn.addEventListener('click', () => {
					// ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
					const nameEl = document.getElementById('cust_name');
					const emailEl = document.getElementById('cust_email');
					const phoneEl = document.getElementById('cust_phone');

					if (nameEl) nameEl.value = originalCustomerData.name || '';
					if (emailEl) emailEl.value = originalCustomerData.email || '';
					if (phoneEl) phoneEl.value = originalCustomerData.phone || '';

					// ÌïÑÎìú ÎπÑÌôúÏÑ±Ìôî
					['cust_name', 'cust_email', 'cust_phone'].forEach(id => {
						const el = document.getElementById(id);
						if (el) el.disabled = true;
					});

					if (editBtn) editBtn.style.display = 'inline-block';
					if (saveBtn) saveBtn.style.display = 'none';
					cancelBtn.style.display = 'none';
				});
			}
		}

		// Traveler Ìé∏Ïßë Î≤ÑÌäº Ï¥àÍ∏∞Ìôî
		function initTravelerEditButtons() {
			const editBtn = document.getElementById('editTravelerBtn');
			if (!editBtn) return;

			// ÏµúÍ≥†Í¥ÄÎ¶¨ÏûêÎßå Î≤ÑÌäº ÌëúÏãú
			if (__isSuperAdmin) {
				editBtn.style.display = 'inline-block';
			}

			editBtn.addEventListener('click', () => {
				openTravelerEditModal();
			});
		}

		// SMT ÏàòÏ†ï ÏãúÏûë - ÏõêÎ≥∏ ÌååÏùºÎ™Ö ÌëúÏãú ÏßÄÏõê
		function applyDepositProofUi(filePath, originalFileName) {
			let path = String(filePath || '').trim();
			const infoEl = document.getElementById('depositProofInfo');
			const btnEl = document.getElementById('depositProofDownloadBtn');
			if (!infoEl || !btnEl) return;

			if (!path) {
				// ÏöîÍµ¨ÏÇ¨Ìï≠: ÏóêÏù¥Ï†ÑÌä∏Í∞Ä ÏÑ†Í∏à Ï¶ùÎπô ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏßÄ ÏïäÏïòÏúºÎ©¥ Í≥µÎûÄÏù¥Ïñ¥Ïïº Ìï®
				infoEl.textContent = '';
				btnEl.disabled = true;
				btnEl.onclick = null;
				return;
			}

			// normalize path so download.php can resolve it (uploads/... or /uploads/...)
			try {
				path = path.replace(/\\/g, '/');
				// legacy/incorrect stored value: download.php?file=... ÌòïÌÉúÎ©¥ file ÌååÎùºÎØ∏ÌÑ∞Îßå Ï∂îÏ∂ú
				if (path.includes('download.php') && path.includes('file=')) {
					try {
						const u = new URL(path, window.location.origin);
						const fp = u.searchParams.get('file');
						if (fp) path = fp;
					} catch (_) { }
				}
				// absolute url containing /uploads/xxx ‚Üí trim to /uploads/...
				const pos = path.indexOf('/uploads/');
				if (pos !== -1) path = path.slice(pos);
				if (path.startsWith('uploads/')) path = '/' + path;
				if (!/^https?:\/\//i.test(path) && !path.startsWith('/')) path = '/' + path;
			} catch (_) { }

			// ÏõêÎ≥∏ ÌååÏùºÎ™ÖÏù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ ÏÑúÎ≤Ñ ÌååÏùºÎ™Ö ÏÇ¨Ïö©
			const displayName = originalFileName ? String(originalFileName).trim() : (path.split('/').pop() || 'file');
			infoEl.innerHTML = `<img src="../image/file.svg" alt=""> ${escapeHtml(displayName)}`;
			btnEl.disabled = false;
			btnEl.onclick = (e) => {
				e.preventDefault();
				e.stopPropagation();
				window.open(`/backend/api/download.php?file=${encodeURIComponent(path)}`, '_blank');
			};
		}
		// SMT ÏàòÏ†ï ÏôÑÎ£å

		// SMT ÏàòÏ†ï ÏãúÏûë - ÏÑ†Í∏à Ï¶ùÎπô ÌååÏùº ÏóÖÎ°úÎìú Ìï∏Îì§Îü¨
		async function handleDepositProofUpload(e) {
			const file = e.target.files?.[0];
			if (!file) return;

			// ÌååÏùº ÌÅ¨Í∏∞ Ï≤¥ÌÅ¨ (10MB)
			if (file.size > 10 * 1024 * 1024) {
				alert('File size exceeds 10MB limit');
				e.target.value = '';
				return;
			}

			// ÌååÏùº ÌÉÄÏûÖ Ï≤¥ÌÅ¨
			const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
			if (!allowedTypes.includes(file.type)) {
				alert('Invalid file type. Only JPG, PNG, GIF, and PDF are allowed.');
				e.target.value = '';
				return;
			}

			try {
				const formData = new FormData();
				formData.append('action', 'uploadDepositProof');
				formData.append('bookingId', bookingId);
				formData.append('depositProof', file);

				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					credentials: 'same-origin',
					body: formData
				});

				const result = await response.json().catch(() => ({}));
				if (!response.ok || !result.success) {
					throw new Error(result.message || 'Upload failed');
				}

				// UI ÏóÖÎç∞Ïù¥Ìä∏ (ÏõêÎ≥∏ ÌååÏùºÎ™Ö ÏÇ¨Ïö©)
				applyDepositProofUi(result.data?.filePath || '', result.data?.originalFileName || '');
				alert('File uploaded successfully');
			} catch (error) {
				console.error('Upload error:', error);
				alert(error?.message || 'Failed to upload file');
			}

			// ÏûÖÎ†• Ï¥àÍ∏∞Ìôî (Í∞ôÏùÄ ÌååÏùº Îã§Ïãú ÏÑ†ÌÉù Í∞ÄÎä•ÌïòÎèÑÎ°ù)
			e.target.value = '';
		}
		// SMT ÏàòÏ†ï ÏôÑÎ£å

		function applyBalanceProofUi(filePath) {
			const wrap = document.getElementById('b2b_booking_detail_target');
			if (!wrap) return;
			const path = String(filePath || '').trim();
			if (!path) {
				// Keep publishing default placeholder
				wrap.innerHTML = `<input type="text" class="jw-w" id="balanceProofPlaceholder" placeholder="-" disabled>`;
				return;
			}

			const name = path.split('/').pop() || 'file';
			wrap.innerHTML = `
				<div class="cell">
					<div class="field-row jw-center">
						<div class="jw-center jw-gap10">
							<img src="../image/file.svg" alt="">
							<span data-lan-eng="Proof of balance file">Proof of balance file</span> ${escapeHtml(name)}
						</div>
						<div class="jw-center jw-gap10">
							<i></i>
							<button type="button" class="jw-button typeF" aria-label="Download" onclick="event.preventDefault();event.stopPropagation();window.open('/backend/api/download.php?file=${encodeURIComponent(path)}','_blank');">
								<img src="../image/buttun-download.svg" alt="">
							</button>
						</div>
					</div>
				</div>
			`;
		}

		function computeUiStatus(b) {
			// ÏÉÅÌÉúÍ∞í - bookingStatus ÏßÅÏ†ë ÏÇ¨Ïö©
			const bs = String(b.bookingStatus || '').toLowerCase().trim();
			const validStatuses = [
				'pending',
				'waiting_down_payment', 'checking_down_payment',
				'waiting_second_payment', 'checking_second_payment',
				'waiting_balance', 'checking_balance',
				'waiting_full_payment', 'checking_full_payment',
				'rejected', 'confirmed', 'completed', 'cancelled', 'refunded'
			];
			if (validStatuses.includes(bs)) return bs;
			// ÌïòÏúÑ Ìò∏ÌôòÏÑ±
			if (bs === 'partial') return 'waiting_second_payment';
			return 'waiting_down_payment';
		}

		function statusLabel(key) {
			const labels = {
				'waiting_down_payment': 'Waiting for Down Payment',
				'checking_down_payment': 'Checking Down Payment',
				'waiting_second_payment': 'Waiting for Second Payment',
				'checking_second_payment': 'Checking Second Payment',
				'waiting_balance': 'Waiting for Balance',
				'checking_balance': 'Checking Balance',
				'waiting_full_payment': 'Waiting for Full Payment',
				'checking_full_payment': 'Checking Full Payment',
				'rejected': 'Payment Rejected',
				'confirmed': 'Reservation Confirmed',
				'completed': 'Trip Completed',
				'cancelled': 'Reservation Cancelled',
				'refunded': 'Refund Completed'
			};
			return labels[String(key || '').toLowerCase()] || 'Waiting for Down Payment';
		}

		function setFlight(kind, f) {
			const isDep = kind === 'departure';
			const set = (id, v) => setValue(id, v || '');
			const dt = (v) => formatDateTime(v);
			if (isDep) {
				set('departureFlightNumber', f.flight_number || f.flightNumber || '');
				set('departureDateTime', dt(f.departure_time || f.departureTime));
				set('departureArrivalDateTime', dt(f.arrival_time || f.arrivalTime));
				set('departurePoint', f.departure_point || f.departurePoint || '');
				set('departureDestination', f.destination || f.arrivalPoint || '');
			} else {
				set('returnFlightNumber', f.flight_number || f.flightNumber || '');
				set('returnDepartureDateTime', dt(f.departure_time || f.departureTime));
				set('returnArrivalDateTime', dt(f.arrival_time || f.arrivalTime));
				set('returnDeparturePoint', f.departure_point || f.departurePoint || '');
				set('returnDestination', f.destination || f.arrivalPoint || '');
			}
		}

		function setValue(id, v) {
			const el = document.getElementById(id);
			if (!el) return;
			el.value = String(v ?? '');
		}
		function setTextArea(id, v) {
			const el = document.getElementById(id);
			if (!el) return;
			el.value = String(v ?? '');
		}
		function setDatePickerValue(id, v) {
			const el = document.getElementById(id);
			if (!el) return;
			el.value = String(v ?? '');
		}
		// SMT ÏàòÏ†ï ÏãúÏûë - select Í∞í ÏÑ∏ÌåÖ Ìó¨Ìçº Ìï®Ïàò
		function setSelectValue(id, v) {
			const el = document.getElementById(id);
			if (!el) return;
			el.value = String(v ?? '');
		}
		// SMT ÏàòÏ†ï ÏôÑÎ£å

		function formatNumber(n) {
			const x = Number(n);
			if (!Number.isFinite(x)) return '';
			return x.toLocaleString();
		}
		function formatPeriod(sd, ed) {
			const s = String(sd || '').trim();
			const e = String(ed || '').trim();
			if (s && e) return `${s} - ${e}`;
			return s || e || '';
		}
		function formatDateTime(v) {
			if (!v) return '';
			const d = new Date(v);
			if (Number.isNaN(d.getTime())) return String(v);
			const y = d.getFullYear();
			const m = String(d.getMonth() + 1).padStart(2, '0');
			const day = String(d.getDate()).padStart(2, '0');
			const hh = String(d.getHours()).padStart(2, '0');
			const mm = String(d.getMinutes()).padStart(2, '0');
			return `${y}-${m}-${day} ${hh}:${mm}`;
		}
		function formatMeetingTime(b) {
			const date = String(b.departureDate || '').trim();
			const mt = String(b.meetingTime || '').trim().slice(0, 5);
			const dt = String(b.departureTime || '').trim().slice(0, 5);
			const t = mt || dt;
			if (!date && !t) return '';
			if (date && t) return `${date} ${t}`;
			return date || t;
		}
		function formatReservationPeople(booking, selectedOptions, travelers) {
			// 1) selectedOptions Í∏∞Î∞ò(ÏòàÏïΩ 1Îã®Í≥Ñ ÏÑ†ÌÉù ÏòµÏÖò/ÏàòÎüâ)
			try {
				const so = (selectedOptions && typeof selectedOptions === 'object') ? selectedOptions : {};
				const root = (so.selectedOptions && typeof so.selectedOptions === 'object') ? so.selectedOptions : so;
				const pickArray = (...keys) => {
					for (const k of keys) {
						const v = root?.[k];
						if (Array.isArray(v) && v.length) return v;
					}
					return null;
				};
				const arr =
					pickArray('reservationOptions', 'pricingOptionsSelected', 'pricingOptions', 'guestOptions', 'peopleOptions', 'selectedGuests') ||
					(Array.isArray(root?.options) ? root.options : null);

				if (arr && arr.length) {
					const parts = [];
					for (const it of arr) {
						if (!it || typeof it !== 'object') continue;
						const name = String(it.optionName ?? it.name ?? it.label ?? it.type ?? '').trim();
						const qty = Number(it.qty ?? it.quantity ?? it.count ?? it.num ?? (it.selectedQty ?? 0));
						if (!name || !Number.isFinite(qty) || qty <= 0) continue;
						parts.push(`${name} x${qty}`);
					}
					if (parts.length) return parts.join(', ');
				}
			} catch (_) {}

			// 2) travelers Í∏∞Î∞ò(travelerType Í∑∏Î£πÌïë)
			try {
				if (Array.isArray(travelers) && travelers.length) {
					const map = new Map();
					for (const t of travelers) {
						const raw = String(t?.travelerType ?? '').trim();
						if (!raw) continue;
						const key = raw.toLowerCase();
						map.set(key, { label: raw, count: (map.get(key)?.count || 0) + 1 });
					}
					const parts = [];
					for (const v of map.values()) {
						if (v.count > 0) parts.push(`${String(v.label).trim()} x${v.count}`);
					}
					if (parts.length) return parts.join(', ');
				}
			} catch (_) {}

			// 3) fallback: Í≥†Ï†ï Adult/Child/Infant ÌëúÍ∏∞Îäî ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÍ≥† Ï¥ù Ïù∏ÏõêÎßå ÌëúÏãú
			const a = Number(booking?.adults || 0), c = Number(booking?.children || 0), i = Number(booking?.infants || 0);
			const total = (Number.isFinite(a) ? a : 0) + (Number.isFinite(c) ? c : 0) + (Number.isFinite(i) ? i : 0);
			const rawTotal = String(booking?.numberOfPeople || booking?.guests || '').trim();
			const n = rawTotal !== '' ? Number(rawTotal) : total;
			return Number.isFinite(n) && n > 0 ? String(n) : '-';
		}
		function setPhone(codeId, phoneId, raw) {
			const codeEl = document.getElementById(codeId);
			const phoneEl = document.getElementById(phoneId);
			if (!phoneEl) return;
			const s = String(raw || '').trim();
			const m = s.match(/^(\\+\\d+)\\s*(.*)$/);
			if (m) {
				if (codeEl) {
					codeEl.dataset.pendingCode = m[1];
					codeEl.value = m[1];
				}
				phoneEl.value = m[2] || '';
			} else {
				phoneEl.value = s;
			}
		}
		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = String(text ?? '');
			return div.innerHTML;
		}
		function escapeJs(s) {
			return String(s || '').replace(/\\\\/g, '\\\\\\\\').replace(/'/g, "\\\\'");
		}

		// === 3Îã®Í≥Ñ Í≤∞Ï†ú Í¥ÄÎ†® Ìï®Ïàò ===

		// Payment confirmation status
		function updatePaymentSections(booking) {
			const paymentType = booking.paymentType || 'staged';

			// Payment Type ÌëúÏãú
			const paymentTypeDisplay = document.getElementById('paymentTypeDisplay');
			if (paymentTypeDisplay) {
				paymentTypeDisplay.value = paymentType === 'full' ? 'Full Payment (Ï†ÑÏï° Í≤∞Ï†ú)' : 'Staged Payment (3Îã®Í≥Ñ Í≤∞Ï†ú)';
			}

			// Í≤∞Ï†ú Ïú†ÌòïÏóê Îî∞Îùº ÏÑπÏÖò ÌëúÏãú/Ïà®Í∏∞Í∏∞
			const stagedSections = document.getElementById('stagedPaymentSections');
			const fullSection = document.getElementById('fullPaymentSection');

			if (paymentType === 'full') {
				// Full Payment
				if (stagedSections) stagedSections.style.display = 'none';
				if (fullSection) fullSection.style.display = 'block';
				updateFullPaymentSection(booking);
				return;
			} else {
				// Staged Payment
				if (stagedSections) stagedSections.style.display = 'block';
				if (fullSection) fullSection.style.display = 'none';
			}

			const downConfirmed = !!(booking.downPaymentConfirmedAt && booking.downPaymentConfirmedAt !== '0000-00-00 00:00:00');
			const secondConfirmed = !!(booking.advancePaymentConfirmedAt && booking.advancePaymentConfirmedAt !== '0000-00-00 00:00:00');
			const balanceConfirmed = !!(booking.balanceConfirmedAt && booking.balanceConfirmedAt !== '0000-00-00 00:00:00');

			// Í∏àÏï° ÏûêÎèô Í≥ÑÏÇ∞Ïö© Îç∞Ïù¥ÌÑ∞
			const orderAmount = Number(booking.totalAmount || booking.orderAmount || 0);
			const adultCount = Number(booking.adults || 0);
			const childCount = Number(booking.children || 0);
			const infantCount = Number(booking.infants || 0);
			const adultChildCount = adultCount + childCount;

			// Down Payment = 5000 √ó (Adult + Child)
			let downAmount = Number(booking.downPaymentAmount || 0);
			if (downAmount <= 0 && adultChildCount > 0) {
				downAmount = 5000 * adultChildCount;
			}
			setValue('downPaymentAmount', downAmount > 0 ? formatNumber(downAmount) : '-');
			setValue('downPaymentDeadline', booking.downPaymentDueDate || '-');
			applyPaymentProofUi('down', booking.downPaymentFile || '', booking.downPaymentFileName || '');

			// Down Payment ÏÉÅÌÉú ÌëúÏãú
			const downStatus = document.getElementById('downPaymentStatus');
			if (downStatus) {
				if (downConfirmed) {
					downStatus.innerHTML = '<span style="color: #28A745; font-weight: 500;">‚úì Confirmed</span>';
				} else if (booking.downPaymentFile) {
					downStatus.innerHTML = '<span style="color: #FFC107; font-weight: 500;">Pending Review</span>';
				} else {
					downStatus.innerHTML = '<span style="color: #6c757d;">Awaiting Upload</span>';
				}
			}

			// Down Payment Actions (ÌååÏùº ÏûàÍ≥† ÎØ∏ÌôïÏ†ïÏù∏ Í≤ΩÏö∞Îßå ÌëúÏãú)
			const downActions = document.getElementById('downPaymentActions');
			if (downActions) {
				downActions.style.display = (booking.downPaymentFile && !downConfirmed) ? 'flex' : 'none';
			}

			// Second Payment = 10000 √ó (Adult + Child)
			let secondAmount = Number(booking.advancePaymentAmount || 0);
			if (secondAmount <= 0 && adultChildCount > 0) {
				secondAmount = 10000 * adultChildCount;
			}
			// Í∏àÏï°Í≥º Îç∞ÎìúÎùºÏù∏ÏùÄ Ìï≠ÏÉÅ ÌëúÏãú
			setValue('secondPaymentAmount', secondAmount > 0 ? formatNumber(secondAmount) : '-');
			setValue('secondPaymentDeadline', booking.advancePaymentDueDate || '-');

			const secondNotice = document.getElementById('secondPaymentDisabledNotice');
			const secondFields = document.getElementById('secondPaymentFields');
			const secondActions = document.getElementById('secondPaymentActions');

			if (downConfirmed) {
				// Down Payment ÌôïÏ†ïÎê® ‚Üí Second Payment ÌååÏùº ÏóÖÎ°úÎìú ÌôúÏÑ±Ìôî
				if (secondNotice) secondNotice.style.display = 'none';
				if (secondFields) secondFields.style.display = 'flex';
				applyPaymentProofUi('second', booking.advancePaymentFile || '', booking.advancePaymentFileName || '');

				// Second Payment ÏÉÅÌÉú ÌëúÏãú
				const secondStatus = document.getElementById('secondPaymentStatus');
				if (secondStatus) {
					if (secondConfirmed) {
						secondStatus.innerHTML = '<span style="color: #28A745; font-weight: 500;">‚úì Confirmed</span>';
					} else if (booking.advancePaymentFile) {
						secondStatus.innerHTML = '<span style="color: #FFC107; font-weight: 500;">Pending Review</span>';
					} else {
						secondStatus.innerHTML = '<span style="color: #6c757d;">Awaiting Upload</span>';
					}
				}

				// Second Payment Actions
				if (secondActions) {
					secondActions.style.display = (booking.advancePaymentFile && !secondConfirmed) ? 'flex' : 'none';
				}
			} else {
				// Down Payment ÎØ∏ÌôïÏ†ï ‚Üí Second Payment ÌååÏùº ÏóÖÎ°úÎìú ÎπÑÌôúÏÑ±Ìôî
				if (secondNotice) secondNotice.style.display = 'block';
				if (secondFields) secondFields.style.display = 'none';
				if (secondActions) secondActions.style.display = 'none';
			}

			// Balance = Order Amount - Down Payment - Second Payment
			let balanceAmt = Number(booking.balanceAmount || 0);
			if (balanceAmt <= 0 && orderAmount > 0) {
				const calcDown = downAmount > 0 ? downAmount : (5000 * adultChildCount);
				const calcSecond = secondAmount > 0 ? secondAmount : (10000 * adultChildCount);
				balanceAmt = orderAmount - calcDown - calcSecond;
			}
			// Í∏àÏï°Í≥º Îç∞ÎìúÎùºÏù∏ÏùÄ Ìï≠ÏÉÅ ÌëúÏãú
			setValue('balanceAmount', balanceAmt > 0 ? formatNumber(balanceAmt) : '-');
			setValue('balanceDeadline', booking.balanceDueDate || '-');

			const balanceNotice = document.getElementById('balanceDisabledNotice');
			const balanceFields = document.getElementById('balanceFields');
			const balanceActions = document.getElementById('balanceActions');

			if (secondConfirmed) {
				// Second Payment ÌôïÏ†ïÎê® ‚Üí Balance ÌååÏùº ÏóÖÎ°úÎìú ÌôúÏÑ±Ìôî
				if (balanceNotice) balanceNotice.style.display = 'none';
				if (balanceFields) balanceFields.style.display = 'flex';
				applyPaymentProofUi('balance', booking.balanceFile || '', booking.balanceFileName || '');

				// Balance ÏÉÅÌÉú ÌëúÏãú
				const balanceStatus = document.getElementById('balanceStatus');
				if (balanceStatus) {
					if (balanceConfirmed) {
						balanceStatus.innerHTML = '<span style="color: #28A745; font-weight: 500;">‚úì Confirmed</span>';
					} else if (booking.balanceFile) {
						balanceStatus.innerHTML = '<span style="color: #FFC107; font-weight: 500;">Pending Review</span>';
					} else {
						balanceStatus.innerHTML = '<span style="color: #6c757d;">Awaiting Upload</span>';
					}
				}

				// Balance Actions
				if (balanceActions) {
					balanceActions.style.display = (booking.balanceFile && !balanceConfirmed) ? 'flex' : 'none';
				}
			} else {
				// Second Payment ÎØ∏ÌôïÏ†ï ‚Üí Balance ÌååÏùº ÏóÖÎ°úÎìú ÎπÑÌôúÏÑ±Ìôî
				if (balanceNotice) balanceNotice.style.display = 'block';
				if (balanceFields) balanceFields.style.display = 'none';
				if (balanceActions) balanceActions.style.display = 'none';
			}
		}

		// Full Payment section update
		function updateFullPaymentSection(booking) {
			const fullConfirmed = !!(booking.fullPaymentConfirmedAt && booking.fullPaymentConfirmedAt !== '0000-00-00 00:00:00');
			const fullAmount = Number(booking.fullPaymentAmount || booking.totalAmount || 0);

			setValue('fullPaymentAmount', fullAmount > 0 ? formatNumber(fullAmount) : '-');
			setValue('fullPaymentDeadline', booking.fullPaymentDueDate || '-');
			applyPaymentProofUi('full', booking.fullPaymentFile || '', booking.fullPaymentFileName || '');

			// Full Payment ÏÉÅÌÉú ÌëúÏãú
			const fullStatus = document.getElementById('fullPaymentStatus');
			if (fullStatus) {
				if (fullConfirmed) {
					fullStatus.innerHTML = '<span style="color: #28A745; font-weight: 500;">‚úì Confirmed</span>';
				} else if (booking.fullPaymentFile) {
					fullStatus.innerHTML = '<span style="color: #FFC107; font-weight: 500;">Pending Review</span>';
				} else {
					fullStatus.innerHTML = '<span style="color: #6c757d;">Awaiting Upload</span>';
				}
			}

			// Full Payment Actions (ÌååÏùº ÏûàÍ≥† ÎØ∏ÌôïÏ†ïÏù∏ Í≤ΩÏö∞Îßå ÌëúÏãú)
			const fullActions = document.getElementById('fullPaymentActions');
			if (fullActions) {
				fullActions.style.display = (booking.fullPaymentFile && !fullConfirmed) ? 'flex' : 'none';
			}
		}

		// Payment proof file UI helper
		function applyPaymentProofUi(type, filePath, originalFileName) {
			const infoId = type === 'down' ? 'downPaymentProofInfo'
				: type === 'second' ? 'secondPaymentProofInfo'
				: type === 'full' ? 'fullPaymentProofInfo'
				: 'balanceProofInfo';
			const btnId = type === 'down' ? 'downPaymentDownloadBtn'
				: type === 'second' ? 'secondPaymentDownloadBtn'
				: type === 'full' ? 'fullPaymentDownloadBtn'
				: 'balanceDownloadBtn';

			const infoEl = document.getElementById(infoId);
			const btnEl = document.getElementById(btnId);
			if (!infoEl || !btnEl) return;

			let path = String(filePath || '').trim();
			if (!path) {
				infoEl.textContent = '-';
				btnEl.disabled = true;
				btnEl.onclick = null;
				return;
			}

			// Normalize path
			try {
				path = path.replace(/\\/g, '/');
				const pos = path.indexOf('/uploads/');
				if (pos !== -1) path = path.slice(pos);
				if (path.startsWith('uploads/')) path = '/' + path;
				if (!/^https?:\/\//i.test(path) && !path.startsWith('/')) path = '/' + path;
			} catch (_) { }

			const displayName = originalFileName ? String(originalFileName).trim() : (path.split('/').pop() || 'file');
			infoEl.innerHTML = `<img src="../image/file.svg" alt=""> ${escapeHtml(displayName)}`;
			btnEl.disabled = false;
			btnEl.onclick = (e) => {
				e.preventDefault();
				e.stopPropagation();
				window.open(`/backend/api/download.php?file=${encodeURIComponent(path)}`, '_blank');
			};
		}

		// Confirm payment
		async function confirmPayment(type) {
			const typeLabel = type === 'down' ? 'Down Payment' : type === 'second' ? 'Second Payment' : type === 'full' ? 'Full Payment' : 'Balance';
			if (!confirm(`Are you sure you want to confirm this ${typeLabel}?`)) {
				return;
			}

			try {
				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({
						action: 'confirmPayment',
						bookingId: bookingId,
						paymentType: type
					})
				});

				const result = await response.json().catch(() => ({}));
				if (!response.ok || !result.success) {
					throw new Error(result.message || 'Failed to confirm payment');
				}

				alert('Payment confirmed successfully.');
				window.location.reload();
			} catch (error) {
				console.error('Confirm payment error:', error);
				alert(error?.message || 'An error occurred while confirming payment.');
			}
		}

		// Reject payment
		// Reject Modal Í¥ÄÎ†® Î≥ÄÏàò
		let currentRejectType = null;

		function rejectPayment(type) {
			currentRejectType = type;
			const typeLabel = type === 'down' ? 'Down Payment' : type === 'second' ? 'Second Payment' : type === 'full' ? 'Full Payment' : 'Balance';
			document.getElementById('rejectModalTitle').textContent = `Reject ${typeLabel}`;
			document.getElementById('rejectReason').value = '';
			document.getElementById('rejectModal').style.display = 'flex';
		}

		function closeRejectModal() {
			document.getElementById('rejectModal').style.display = 'none';
			currentRejectType = null;
		}

		async function submitReject() {
			const reason = document.getElementById('rejectReason').value.trim();
			if (!reason) {
				alert('Please enter a rejection reason.');
				return;
			}

			try {
				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({
						action: 'rejectPayment',
						bookingId: bookingId,
						paymentType: currentRejectType,
						reason: reason
					})
				});

				const result = await response.json().catch(() => ({}));
				if (!response.ok || !result.success) {
					throw new Error(result.message || 'Failed to reject payment');
				}

				closeRejectModal();
				alert('Payment rejected. The agent will need to upload a new proof file.');
				window.location.reload();
			} catch (error) {
				console.error('Reject payment error:', error);
				alert(error?.message || 'An error occurred while rejecting payment.');
			}
		}

		// ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
		document.addEventListener('keydown', function(e) {
			if (e.key === 'Escape' && document.getElementById('rejectModal').style.display === 'flex') {
				closeRejectModal();
			}
			if (e.key === 'Escape' && document.getElementById('room-option-modal').style.display === 'flex') {
				closeRoomOptionModal();
			}
		});

		// ========== Room Option Modal ==========
		let currentPackageId = null;
		let currentRoomOptions = [];
		let selectedRoomsInModal = [];
		let originalTravelerCount = 0; // ÏõêÎûò Ïù∏ÏõêÏàò Ï†ÄÏû•

		const defaultRoomOptions = [
			{ roomId: 'standard', roomType: 'Standard room', capacity: 2, roomPrice: 0 },
			{ roomId: 'double', roomType: 'Double room', capacity: 2, roomPrice: 0 },
			{ roomId: 'triple', roomType: 'Triple room', capacity: 3, roomPrice: 0 },
			{ roomId: 'family', roomType: 'Family room', capacity: 4, roomPrice: 0 },
			{ roomId: 'single', roomType: 'Single Supplement Surcharge', capacity: 1, roomPrice: 10000 }
		];

		function openRoomOptionModal() {
			if (!currentPackageId) {
				alert('Package information not available');
				return;
			}
			selectedRoomsInModal = []; // Ï¥àÍ∏∞Ìôî
			document.getElementById('room-option-modal').style.display = 'flex';
			loadRoomOptions();
		}

		function closeRoomOptionModal() {
			document.getElementById('room-option-modal').style.display = 'none';
		}

		async function loadRoomOptions() {
			const container = document.getElementById('room-option-list');
			if (!container) return;

			try {
				container.innerHTML = '<div style="text-align:center; padding:20px;">Loading...</div>';

				let roomOptions = [];
				try {
					const response = await fetch(`../backend/api/package-options.php?packageId=${currentPackageId}`, { credentials: 'same-origin' });
					const result = await response.json();
					if (result.success && result.data?.roomOptions?.length > 0) {
						roomOptions = result.data.roomOptions;
					} else {
						roomOptions = defaultRoomOptions;
					}
				} catch (error) {
					console.error('Error loading room options:', error);
					roomOptions = defaultRoomOptions;
				}
				currentRoomOptions = roomOptions;

				let html = '';
				roomOptions.forEach(room => {
					const existingRoom = selectedRoomsInModal.find(r => r.roomId === room.roomId);
					const count = existingRoom ? existingRoom.count : 0;
					const displayPrice = room.roomPrice > 0 ? `+‚Ç±${Number(room.roomPrice).toLocaleString()}` : 'Free';

					html += `
						<div class="room-option-item">
							<div class="room-option-info">
								<span class="room-option-name">${room.roomType}</span>
								<span class="room-option-price">${displayPrice}</span>
							</div>
							<div class="room-option-controls">
								<button type="button" class="room-qty-btn" onclick="changeRoomQuantity('${room.roomId}', -1)" ${count === 0 ? 'disabled' : ''}>-</button>
								<span class="room-qty-value" id="room-qty-${room.roomId}">${count}</span>
								<button type="button" class="room-qty-btn" onclick="changeRoomQuantity('${room.roomId}', 1)">+</button>
							</div>
						</div>
					`;
				});
				container.innerHTML = html;
				updateRoomOrderSummary();
			} catch (error) {
				console.error('Error loading room options:', error);
				container.innerHTML = '<div style="text-align:center; padding:20px; color:#DC3545;">Failed to load room options</div>';
			}
		}

		function changeRoomQuantity(roomId, change) {
			const room = currentRoomOptions.find(r => r.roomId === roomId);
			if (!room) return;

			const existingIndex = selectedRoomsInModal.findIndex(r => r.roomId === roomId);
			const currentCount = existingIndex >= 0 ? selectedRoomsInModal[existingIndex].count : 0;
			const newCount = Math.max(0, currentCount + change);

			if (newCount === 0) {
				selectedRoomsInModal = selectedRoomsInModal.filter(r => r.roomId !== roomId);
			} else {
				if (existingIndex >= 0) {
					selectedRoomsInModal[existingIndex].count = newCount;
				} else {
					selectedRoomsInModal.push({
						roomId: room.roomId,
						roomType: room.roomType,
						roomPrice: room.roomPrice || 0,
						capacity: room.capacity || 1,
						count: newCount
					});
				}
			}

			const qtyEl = document.getElementById(`room-qty-${roomId}`);
			if (qtyEl) qtyEl.textContent = newCount;

			const minusBtn = qtyEl?.parentElement?.querySelector('.room-qty-btn');
			if (minusBtn) minusBtn.disabled = (newCount === 0);

			updateRoomOrderSummary();
		}

		function updateRoomOrderSummary() {
			const summaryContainer = document.getElementById('order-summary-list');
			const amountEl = document.getElementById('order-amount-value');
			const confirmBtn = document.getElementById('confirm-room-selection-btn');
			const banner = document.getElementById('room-combination-count');

			let totalAmount = 0;
			let summaryHtml = '';

			selectedRoomsInModal.forEach(room => {
				if (room.count > 0) {
					const roomTotal = (room.roomPrice || 0) * room.count;
					totalAmount += roomTotal;
					summaryHtml += `
						<div class="order-summary-item">
							<span>${room.roomType} x${room.count}</span>
							<span>‚Ç±${roomTotal.toLocaleString()}</span>
						</div>
					`;
				}
			});

			if (summaryContainer) {
				summaryContainer.innerHTML = summaryHtml || '<div style="color:#999; text-align:center;">No rooms selected</div>';
			}
			if (amountEl) {
				amountEl.textContent = `‚Ç±${totalAmount.toLocaleString()}`;
			}

			// Ïù∏Ïõê Ïàò Í≥ÑÏÇ∞: allTravelersÏóêÏÑú Adult + Child (Infant Ï†úÏô∏)
			const totalBookingGuests = (allTravelers || []).filter(t => {
				const type = (t.type || t.travelerType || '').toLowerCase();
				return type === 'adult' || type === 'child';
			}).length;

			let totalCapacity = 0;
			selectedRoomsInModal.forEach(room => {
				totalCapacity += (room.capacity || 0) * (room.count || 0);
			});

			if (banner) {
				banner.textContent = `(${totalCapacity}/${totalBookingGuests} People)`;
			}

			if (confirmBtn) {
				confirmBtn.disabled = (totalCapacity !== totalBookingGuests || selectedRoomsInModal.length === 0);
			}
		}

		async function confirmRoomSelection() {
			const totalBookingGuests = (allTravelers || []).filter(t => {
				const type = (t.type || t.travelerType || '').toLowerCase();
				return type === 'adult' || type === 'child';
			}).length;

			let totalCapacity = 0;
			selectedRoomsInModal.forEach(room => {
				totalCapacity += (room.capacity || 0) * (room.count || 0);
			});

			if (totalCapacity !== totalBookingGuests) {
				alert('Room capacity must match the number of guests.');
				return;
			}

			try {
				const response = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({
						action: 'updateB2BBooking',
						bookingId: bookingId,
						selectedRooms: selectedRoomsInModal
					})
				});
				const result = await response.json();
				if (!response.ok || !result.success) {
					throw new Error(result.message || 'Failed to save room options');
				}

				const roomSummary = selectedRoomsInModal.map(r => `${r.roomType} x${r.count}`).join(', ');
				setValue('roomOption', roomSummary || '-');
				closeRoomOptionModal();
				alert('Room options saved successfully.');
				window.location.reload();
			} catch (error) {
				console.error('Error saving room options:', error);
				alert(error.message || 'Failed to save room options');
			}
		}

		// Room option Î™®Îã¨ Ïù¥Î≤§Ìä∏
		document.addEventListener('DOMContentLoaded', function() {
			const confirmBtn = document.getElementById('confirm-room-selection-btn');
			if (confirmBtn) {
				confirmBtn.addEventListener('click', confirmRoomSelection);
			}
			document.getElementById('room-option-modal')?.addEventListener('click', function(e) {
				if (e.target === this) closeRoomOptionModal();
			});
		});
	</script>

	<!-- Room Option Modal -->
	<div id="room-option-modal" class="modal" style="display: none;">
		<div class="modal-content modal-room-option">
			<div class="modal-body room-option-modal-body">
				<h2 class="room-option-title" data-lan-eng="Select Room Options">Select Room Options</h2>
				<div id="room-combination-banner" class="room-combination-banner">
					<div class="room-combination-text">
						<span data-lan-eng="Current Room Combination">Current Room Combination</span>
						<span id="room-combination-count">(0/0 People)</span>
					</div>
					<div class="room-combination-note" data-lan-eng="*Adults and Children with 'Child Room=Yes' are counted. (Infants excluded)">
						*Adults and Children with 'Child Room=Yes' are counted. (Infants excluded)
					</div>
				</div>
				<div class="room-option-notice" style="margin-bottom: 16px; padding: 12px 16px; background: #FFF8E6; border: 1px solid #FFE082; border-radius: 8px; color: #8B6914; font-size: 13px;">
					* All rooms are based on double occupancy. If a customer wants a private room or is traveling alone, Single Supplement Surcharge will be applied.
				</div>
				<div class="room-option-container">
					<div class="room-option-left">
						<div id="room-option-list"></div>
					</div>
					<div class="room-option-right">
						<div id="order-summary-list" class="order-summary-list"></div>
						<div class="order-amount-divider"></div>
						<div class="order-amount-row">
							<span class="order-amount-label" data-lan-eng="Order Amount">Order Amount</span>
							<span class="order-amount-value" id="order-amount-value">0(‚Ç±)</span>
						</div>
					</div>
				</div>
				<button type="button" id="confirm-room-selection-btn" class="room-option-submit-btn" data-lan-eng="Selection complete" disabled>Selection complete</button>
			</div>
		</div>
	</div>

	<!-- Reject Reason Modal -->
	<div id="rejectModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
		<div style="background: white; border-radius: 12px; padding: 24px; width: 100%; max-width: 480px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
				<h3 id="rejectModalTitle" style="margin: 0; font-size: 18px; font-weight: 600; color: #DC3545;">Reject Payment</h3>
				<button type="button" onclick="closeRejectModal()" style="background: none; border: none; cursor: pointer; padding: 4px;">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
						<line x1="18" y1="6" x2="6" y2="18"></line>
						<line x1="6" y1="6" x2="18" y2="18"></line>
					</svg>
				</button>
			</div>
			<div style="margin-bottom: 20px;">
				<label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #333;">Rejection Reason <span style="color: #DC3545;">*</span></label>
				<textarea id="rejectReason" rows="4" placeholder="Please enter the reason for rejection. This will be visible to the agent." style="width: 100%; padding: 12px; border: 1px solid #D4D4D4; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
				<p style="margin: 8px 0 0; font-size: 12px; color: #666;">The agent will see this reason and can upload a new proof file.</p>
			</div>
			<div style="display: flex; gap: 12px; justify-content: flex-end;">
				<button type="button" onclick="closeRejectModal()" style="padding: 10px 20px; border: 1px solid #D4D4D4; background: white; border-radius: 8px; font-size: 14px; cursor: pointer;">Cancel</button>
				<button type="button" onclick="submitReject()" style="padding: 10px 20px; border: none; background: #DC3545; color: white; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">Reject</button>
			</div>
		</div>
	</div>
</body>

</html>

