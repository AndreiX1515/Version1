<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>SMART TRAVEL ADMIN</title>

	<!-- 공통 스타일 -->
	<link rel="shortcut icon" href="../image/favicon.ico">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/a_reset.css">
	<link rel="stylesheet" href="../css/a_variables.css">
	<link rel="stylesheet" href="../css/a_components.css?v=20260111">
	<link rel="stylesheet" href="../css/a_contents.css?v=20260111">
</head>

<body>

	<!-- header 들어올 자리 -->
	<header class="layout-header"></header>

	<!-- 본문 영역 -->
	<main class="layout-main">
		<!-- nav 들어올 자리 -->
		<nav class="layout-nav"></nav>

		<section class="layout-content">
			<div class="page-toolbar">
				<a href="visa-app-list.html" class="jw-button" aria-label="목록으로 돌아가기">
					<img src="../image/arrow4.svg" alt="">
					<span data-lan-eng="Return to list">목록으로 돌아가기</span>
				</a>

				<div class="page-toolbar-actions">
					<select class="select" id="statusSelect" disabled>
						<option value="pending" data-lan-eng="Request Received">서류미비</option>
						<option value="reviewing" data-lan-eng="Under Review">심사중</option>
						<option value="approved" data-lan-eng="Issuance Complete">발급 완료</option>
						<option value="rejected" data-lan-eng="Returned">반려</option>
					</select>
					<!-- 퍼블리싱 원본과 동일하게 "저장" 버튼은 노출(요구사항: 상태 자동이므로 disabled) -->
					<button type="button" class="jw-button typeB" id="saveStatusBtn" data-lan-eng="Save" disabled>저장</button>
				</div>
			</div>
			<h1 class="page-title" data-lan-eng="Visa Application Details">비자 신청 상세</h1>
			
			<h2 class="section-title jw-mgt32" data-lan-eng="Document details">서류 내역</h2>
			<div class="card-panel jw-mgt16">
				<div class="grid-wrap" id="documentGridWrap">
					<!-- Documents will be rendered dynamically based on visaType -->
				</div>
			</div>

			<h2 class="section-title jw-mgt32" data-lan-eng="Application Information">신청 정보</h2>
			<div class="card-panel jw-mgt16">
				<div class="grid-wrap">
					<!-- 1행 -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Booking ID">Booking ID</label>
						<input type="text" class="form-control" id="bookingIdDisplay" value="" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Visa Type">Visa Type</label>
						<input type="text" class="form-control" id="visaTypeDisplay" value="" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Application date/time">Application Date</label>
						<input type="text" class="form-control" id="applicationDate" value="" disabled>
					</div>

					<!-- 2행 -->
					<div class="grid-item col-span-3">
						<label class="label-name" data-lan-eng="Package Name">Package Name</label>
						<input type="text" class="form-control" id="productName" value="" disabled>
					</div>

					<!-- 3행 -->
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Departure Date">Departure Date</label>
						<input type="text" class="form-control" id="departureDate" value="" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Booking Status">Booking Status</label>
						<input type="text" class="form-control" id="bookingStatusDisplay" value="" disabled>
					</div>

				</div>
			</div>

			<h2 class="section-title jw-mgt32" data-lan-eng="Applicant Information">신청자 정보</h2>
			<div class="card-panel jw-mgt16">
				<div class="grid-wrap">
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Title">호칭</label>
						<select class="select" id="honorific" disabled>
							<option value="">-</option>
							<option value="MR">MR</option>
							<option value="MS">MS</option>
							<option value="MRS">MRS</option>
						</select>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Name">이름</label>
						<input type="text" class="form-control" id="firstName" value="" disabled>
					</div>
					<div class="grid-item">
						<!-- SMT 수정 시작 -->
						<label class="label-name" data-lan-eng="Last Name">성</label>
						<!-- SMT 수정 완료 -->
						<input type="text" class="form-control" id="lastName" value="" disabled>
					</div>

					<div class="grid-item">
						<label class="label-name" data-lan-eng="Gender">성별</label>
						<select class="select" id="gender" disabled>
							<option value="">-</option>
							<option value="male">Male</option>
							<option value="female">Female</option>
						</select>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Age">나이</label>
						<input type="text" class="form-control" id="age" value="" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Date of birth">생년월일</label>
						<input type="text" class="form-control" id="birthDate" value="" disabled>
					</div>

					<div class="grid-item">
						<label class="label-name" data-lan-eng="Country of origin">출신국가</label>
						<input type="text" class="form-control" id="countryOfOrigin" value="" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Passport number">여권번호</label>
						<input type="text" class="form-control" id="passportNumber" value="" disabled>
					</div>
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Passport Issue Date">여권 발행일</label>
						<input type="text" class="form-control" id="passportIssueDate" value="" disabled>
					</div>
					
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Passport expiration date">여권 만료일</label>
						<input type="text" class="form-control" id="passportExpiryDate" value="" disabled>
					</div>
					
					<div class="grid-item">
						<label class="label-name" data-lan-eng="Passport photo">여권 사진</label>
						<!-- 기획서: 업로드가 아니라 프리뷰 표시(관리자 읽기전용) -->
						<div class="upload-box">
							<div class="thumb" id="passportPhotoPreview" aria-label="passport photo preview"></div>
							<div class="file-controller">
								<div class="jw-center jw-gap10">
									<img src="../image/file.svg" alt="">
									<span id="passportPhotoMeta" data-lan-eng="File not found">파일 없음</span>
								</div>
							</div>
						</div>
					</div>
					
				</div>
			</div>
			
			<h2 class="section-title jw-mgt32" data-lan-eng="Visa Upload">비자 업로드</h2>
			<div class="card-panel jw-mgt16">
				<div class="grid-wrap">
					<!-- 첨부파일 -->
					<div class="grid-item col-span-3">
						<label class="label-name" data-lan-eng="Visa file">비자 파일</label>
						<label class="inputFile jw-mgt8">
							<input id="visaFileInput" type="file">
							<button type="button" class="btn-upload" id="visaUploadBtn"><img src="../image/upload3.svg" alt="">&nbsp;Upload</button>
						  </label>
						<div class="attach-list" id="visaFileList"></div>
					</div>
				</div>
			</div>


		</section>

	</main>

	<script src="../js/default.js?v=20260111"></script>
	<script src="../js/super.js?v=20260111"></script>
	<script src="../js/passport-photo.js?v=20260111"></script>

	<script>
		init({
			headerUrl: '../inc/header.html',
			navUrl: '../inc/nav_super.html'
		});

		let visaApplicationId = null;
		let __visaApplication = null;
		let __currentVisaType = 'group'; // default to group

		// Document configuration by visa type (matches user page config)
		const DOCUMENT_CONFIG = {
			group: [
				{ key: 'passport', title: 'Passport bio page', required: true, multiple: false },
				{ key: 'visaApplicationForm', title: 'Visa Application Form', required: true, multiple: false, download: true, downloadPath: '/uploads/visa/doc/Korea-visa-application.pdf' },
				{ key: 'bankCertificate', title: 'Bank Certificate', required: true, multiple: false },
				{ key: 'bankStatement', title: 'Bank Statement', required: true, multiple: false },
				{ key: 'additionalDocuments', title: 'Additional requirements', required: false, multiple: true }
			],
			individual: [
				{ key: 'visaApplicationForm', title: 'Visa Application Form', required: false, multiple: false, download: true, downloadPath: '/uploads/visa/doc/Korea-visa-application.pdf' },
				{ key: 'dataPrivacyConsent', title: 'Signed Data Privacy Consent Form', required: false, multiple: false, download: true, downloadPath: '/uploads/visa/doc/Data-Privacy-Consent-Form_KVAC.pdf' }
			]
		};

		// SMT 수정: 변경사항은 즉시 반영하지 않고 "저장" 버튼 클릭 시에만 적용
		const __pending = {
			deleteDocs: new Set(),      // docKey list
			newVisaFilePath: '',        // 업로드한(아직 미저장) 비자 파일 경로
			newVisaFileSize: 0,         // 업로드한 파일 크기 (bytes)
			deleteVisaFile: false,      // 기존 비자 파일 삭제 예약
		};

		function formatFileSize(bytes) {
			if (!bytes || bytes <= 0) return '';
			if (bytes < 1024) return bytes + 'B';
			if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + 'KB';
			return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
		}

		function __setSaveEnabled(enabled) {
			const btn = document.getElementById('saveStatusBtn');
			if (!btn) return;
			btn.disabled = !enabled;
		}

		function __hasPendingChanges() {
			return (__pending.deleteDocs.size > 0) || Boolean(__pending.newVisaFilePath) || Boolean(__pending.deleteVisaFile);
		}

		function __effectiveApplication(base) {
			const app = base ? { ...base } : {};
			// doc 삭제 예약은 루트 키로 비우고, derive/status/UI 렌더가 이를 따라가게 한다.
			try {
				__pending.deleteDocs.forEach((k) => {
					// Clear the document key - works with any key dynamically
					app[k] = '';
				});
			} catch (_) {}

			// visa file
			if (__pending.deleteVisaFile) {
				app.visaFile = '';
				app.visa_file = '';
				app.visaDocument = '';
				app.visa_document = '';
				app.visaUrl = '';
			}
			if (__pending.newVisaFilePath) {
				app.visaFile = __pending.newVisaFilePath;
			}
			return app;
		}

		function __renderDocsAndVisaFile() {
			// 서류/비자파일 및 상태는 "효과 적용된" 데이터를 기준으로 UI만 갱신
			const effective = __effectiveApplication(__visaApplication);

			// 상태(자동 산정/표시)
			try {
				const derived = deriveUiStatusFromApplication(effective);
				setValue('statusDisplay', statusLabel(derived));
				setSelect('statusSelect', derived);
				syncJwSelectDisplay(document.getElementById('statusSelect'));
			} catch (_) {}

			// 서류 내역 - 현재 visaType에 맞는 문서들만 업데이트
			const config = DOCUMENT_CONFIG[__currentVisaType] || DOCUMENT_CONFIG.group;
			config.forEach(doc => {
				// download-only documents (individual visa) don't need file path checks
				if (doc.download && __currentVisaType === 'individual') return;
				setDocRow(doc.key, effective);
			});

			// 비자 파일 표시
			const visaFile = pickFirst(effective, ['visaFile', 'visa_file', 'visaDocument', 'visa_document', 'visaUrl']);
			const list = document.getElementById('visaFileList');
			if (list) {
				list.innerHTML = '';
				if (visaFile) {
					const p = String(visaFile);
					const fullName = p.split('/').pop() || p;
					const lastDot = fullName.lastIndexOf('.');
					const nameWithoutExt = lastDot > 0 ? fullName.substring(0, lastDot) : fullName;
					const ext = lastDot > 0 ? fullName.substring(lastDot + 1).toLowerCase() : '';
					// 파일 크기: pending upload 시 저장된 크기 사용, 기존 파일은 크기 정보 없음
					const fileSize = __pending.newVisaFilePath ? formatFileSize(__pending.newVisaFileSize) : '';
					const fileMeta = ext ? (fileSize ? `[${ext}, ${fileSize}]` : `[${ext}]`) : '';
					const pendingTag = '';
					list.innerHTML = `
						<div style="display:flex; align-items:center; gap:8px; padding:11px 12px; border:1px solid #D4D4D4; border-radius:12px; background:#fff; max-width:492px; margin-bottom:8px;">
							<div style="display:flex; align-items:center; gap:6px; flex:1;">
								<img src="../image/file.svg" alt="" style="width:20px; height:20px; flex-shrink:0;">
								<div style="display:flex; align-items:center; gap:2px; font-size:14px; line-height:20px; color:#121212;">
									<span style="font-weight:500;">${escapeHtml(nameWithoutExt)}</span>
									<span style="font-weight:400;">${escapeHtml(fileMeta)}</span>
									${pendingTag}
								</div>
							</div>
							<div style="width:1px; height:20px; background:#D4D4D4;"></div>
							<button type="button" style="padding:0; border:0; background:transparent; cursor:pointer; flex-shrink:0;" onclick="downloadAttachment('${escapeHtml(p)}')" title="Download">
								<img src="../image/button-download.svg" alt="" style="width:24px; height:24px;">
							</button>
							<button type="button" style="padding:0; border:0; background:transparent; cursor:pointer; flex-shrink:0;" onclick="deleteVisaFile()" title="Delete">
								<img src="../image/button-close2.svg" alt="" style="width:24px; height:24px;">
							</button>
						</div>
					`;
				} else if (__pending.deleteVisaFile) {
					list.innerHTML = `<div style="display:flex; align-items:center; gap:8px; padding:11px 12px; border:1px solid #D4D4D4; border-radius:12px; background:#fff; max-width:492px;"><img src="../image/file.svg" alt="" style="width:20px; height:20px;"><span style="font-size:14px; color:#121212;">Pending deletion</span></div>`;
				}
			}

			__setSaveEnabled(__hasPendingChanges());
		}

		document.addEventListener('DOMContentLoaded', async () => {
			try {
				const sessionResponse = await fetch('../backend/api/check-session.php', { credentials: 'same-origin' });
				const sessionData = await sessionResponse.json();
				if (!sessionData || !sessionData.authenticated) {
					window.location.href = '../index.html';
					return;
				}

				const urlParams = new URLSearchParams(window.location.search);
				visaApplicationId = urlParams.get('id') || urlParams.get('visaApplicationId');

				// 상태 셀렉트는 자동 산정이므로 수동 저장 비활성화
				try {
					const stSel = document.getElementById('statusSelect');
					if (stSel) stSel.disabled = true;
					const stBtn = document.getElementById('saveStatusBtn');
					if (stBtn) {
						stBtn.disabled = true; // 변경사항 발생 시에만 enable
						stBtn.addEventListener('click', handleSaveVisaChanges);
					}
				} catch (_) {}
				// 퍼블리싱 원본 버튼은 파일 선택 트리거 역할이므로, 업로드는 input change에서 처리
				document.getElementById('visaFileInput')?.addEventListener('change', handleVisaUpload);
				wireDocButtons();
				wireDocDeleteButtons();

				if (visaApplicationId) {
					await loadVisaApplicationDetail();
				}
			} catch (error) {
				console.error('Session check error:', error);
				window.location.href = '../index.html';
			}
		});

		function wireDocButtons() {
			// Now handled dynamically by wireDocButtonsDynamic() called after renderDocumentSection()
			// This function is kept for backward compatibility but does nothing
		}

		function pickFirst(obj, keys) {
			for (const k of keys) {
				const v = obj && obj[k];
				if (v !== null && typeof v !== 'undefined' && String(v).trim() !== '') return v;
			}
			return '';
		}

		function formatDateTime(val) {
			if (!val) return '';
			const s = String(val).replace('T', ' ');
			return s.length >= 16 ? s.substring(0, 16) : s;
		}

		function normalizeVisaStatus(raw) {
			const s = String(raw || 'pending');
			if (s === 'approved' || s === 'completed') return 'approved';
			if (s === 'rejected') return 'rejected';
			// document_required는 "요청 접수(서류 미비 포함)"로 취급
			if (s === 'under_review' || s === 'reviewing') return 'reviewing';
			if (s === 'document_required' || s === 'pending') return 'pending';
			return 'pending';
		}

		function statusLabel(status) {
			// 요구사항(id 93): 상태 표기는 영문 라벨로 노출
			const map = {
				pending: 'Request Received',
				reviewing: 'Under Review',
				approved: 'Issuance Complete',
				rejected: 'Returned'
			};
			return map[status] || status;
		}

		function setValue(id, val) {
			const el = document.getElementById(id);
			if (!el) return;
			el.value = (val === null || typeof val === 'undefined') ? '' : String(val);
		}

		function setSelect(id, val) {
			const el = document.getElementById(id);
			if (!el) return;
			const v = String(val || '');
			const opt = Array.from(el.options || []).find(o => o.value === v);
			el.value = opt ? v : (el.options?.[0]?.value || '');
		}

		// jw_select(커스텀 셀렉트) 표시 동기화: programmatic value 변경 시 UI가 갱신되지 않는 경우가 있어 보강
		function syncJwSelectDisplay(selectEl) {
			try {
				if (!selectEl) return;
				const wrap = selectEl.closest('.jw-select');
				if (!wrap) return;
				const box = wrap.querySelector('.jw-selected');
				if (!box) return;
				const opt = selectEl.selectedOptions?.[0] || selectEl.options?.[selectEl.selectedIndex] || selectEl.options?.[0];
				if (!opt) return;
				box.textContent = opt.textContent || '';
			} catch (_) { }
		}

		function __docPathFor(docKey, application) {
			// 1) application 루트 필드(가장 빠름)
			const rootMap = {
				// Group visa documents
				passport: ['passport', 'passportCopy', 'passport_copy', 'passport_copy_path', 'passportCopyPath'],
				visaApplicationForm: ['visaApplicationForm', 'visa_application_form', 'visaApplicationFormPath'],
				bankCertificate: ['bankCertificate', 'bank_certificate', 'bankCertificatePath'],
				bankStatement: ['bankStatement', 'bank_statement', 'bankStatementPath'],
				additionalDocuments: ['additionalDocuments', 'additional_documents', 'additionalDocumentsPath'],
				// Individual visa documents
				dataPrivacyConsent: ['dataPrivacyConsent', 'data_privacy_consent', 'dataPrivacyConsentPath'],
				// Legacy keys for backward compatibility
				idPhoto: ['idPhoto', 'id_photo', 'id_photo_path', 'idPhotoPath'],
				passportCopy: ['passportCopy', 'passport_copy', 'passport_copy_path', 'passportCopyPath'],
				itinerary: ['itinerary', 'itinerary_path', 'itineraryPath'],
			};
			const direct = String(pickFirst(application, rootMap[docKey] || [docKey]) || '').trim();
			if (direct) return direct[0] === '/' ? direct : ('/' + direct);

			// 2) application.documents 같은 중첩 구조 대응
			try {
				const docsObj = application?.documents || application?.docments || null;
				if (docsObj && typeof docsObj === 'object') {
					const v2 = String(pickFirst(docsObj, rootMap[docKey] || [docKey]) || '').trim();
					if (v2) return v2[0] === '/' ? v2 : ('/' + v2);
				}
			} catch (_) {}

			// 3) application.notes(JSON) 파싱하여 documents에서 찾기(키 변형/구버전 대응)
			try {
				const notesTxt = String(application?.notes || '').trim();
				if (!notesTxt) return '';
				const j = JSON.parse(notesTxt);
				const docs = (j && j.documents && typeof j.documents === 'object') ? j.documents : null;
				if (!docs) return '';
				const notesKeyMap = {
					// Group visa documents
					passport: ['passport', 'passportCopy', 'passport_copy', 'passport_copy_path'],
					visaApplicationForm: ['visaApplicationForm', 'visa_application_form'],
					bankCertificate: ['bankCertificate', 'bank_certificate', 'bankCertificatePath'],
					bankStatement: ['bankStatement', 'bank_statement', 'bankStatementPath'],
					additionalDocuments: ['additionalDocuments', 'additional_documents'],
					// Individual visa documents
					dataPrivacyConsent: ['dataPrivacyConsent', 'data_privacy_consent'],
					// Legacy keys
					idPhoto: ['idPhoto', 'photo', 'id_photo', 'id_photo_path'],
					passportCopy: ['passportCopy', 'passport', 'passport_copy', 'passport_copy_path'],
					itinerary: ['itinerary', 'itinerary_path', 'itineraryPath'],
				};
				const v3 = String(pickFirst(docs, notesKeyMap[docKey] || [docKey]) || '').trim();
				if (!v3) return '';
				return v3[0] === '/' ? v3 : ('/' + v3);
			} catch (_) {
				return '';
			}
		}

		function setDocRow(docKey, application) {
			const path = __docPathFor(docKey, application);
			const meta = document.getElementById(`docMeta-${docKey}`);
			const dlBtn = document.getElementById(`docDl-${docKey}`);
			const delBtn = document.getElementById(`docDel-${docKey}`);
			const rowEl = meta?.closest('.field-row') || dlBtn?.closest('.field-row') || delBtn?.closest('.field-row') || null;

			// UX 통일: 상태와 무관하게 항상 동일한 UI(파일 없음 표시)를 보여주고
			// 다운로드/삭제 버튼만 파일 존재 시 활성화한다.
			if (rowEl) rowEl.style.display = '';

			if (meta) {
				if (!path) {
					meta.textContent = 'No file';
				} else {
					const name = path.split('/').pop() || path;
					meta.textContent = `[${name}]`;
				}
			}

			// 버튼: 경로가 있을 때만 활성화/노출
			if (dlBtn) {
				dlBtn.disabled = !path;
				dlBtn.style.display = path ? '' : 'none';
			}
			if (delBtn) {
				delBtn.disabled = !path;
				delBtn.style.display = path ? '' : 'none';
			}
		}

		function deriveUiStatusFromApplication(application) {
			// Use current visa type's required documents for status calculation
			const config = DOCUMENT_CONFIG[__currentVisaType] || DOCUMENT_CONFIG.group;
			const requiredDocs = config.filter(d => d.required && !d.download).map(d => d.key);

			// For individual visa (download-only), consider it as pending/reviewing based on visaSend
			if (__currentVisaType === 'individual') {
				const visaFile = String(pickFirst(application, ['visaFile', 'visa_file', 'visaDocument', 'visa_document', 'visaUrl']) || '').trim();
				if (visaFile) return 'approved';
				// visaSend can be integer (1/0) or string ('yes'/'no')
				const visaSendRaw = application?.visaSend;
				if (visaSendRaw === 1 || visaSendRaw === '1' || String(visaSendRaw).toLowerCase() === 'yes') return 'reviewing';
				return 'pending';
			}

			// For group visa, check uploaded documents
			const present = requiredDocs.filter(k => String(__docPathFor(k, application) || '').trim() !== '').length;
			const visaFile = String(pickFirst(application, ['visaFile', 'visa_file', 'visaDocument', 'visa_document', 'visaUrl']) || '').trim();
			if (visaFile) return 'approved';
			if (present === 0) return 'pending';
			if (requiredDocs.length > 0 && present === requiredDocs.length) return 'reviewing';
			return 'rejected';
		}

		async function ensureAutoStatus(application) {
			try {
				const derived = deriveUiStatusFromApplication(application);
				const current = normalizeVisaStatus(application?.status);
				// UI만 갱신
				// 퍼블리싱 원본에는 statusDisplay가 없을 수 있어 optional
				setValue('statusDisplay', statusLabel(derived));
				setSelect('statusSelect', derived);
				// SMT 수정: DB는 즉시 갱신하지 않음(저장 버튼 클릭 시에만 반영)
				// (CSV 요구사항: 파일 삭제/업로드 변경사항은 저장 버튼을 눌러야 반영)
			} catch (_) {}
		}

		function wireDocDeleteButtons() {
			// Now handled dynamically by wireDocButtonsDynamic() called after renderDocumentSection()
			// This function is kept for backward compatibility but does nothing
		}

		async function loadVisaApplicationDetail() {
			try {
				const response = await fetch(`../backend/api/super-api.php?action=getVisaApplicationDetail&id=${encodeURIComponent(visaApplicationId)}`, {
					credentials: 'same-origin'
				});
				if (response.status === 401) {
					// 세션 만료/권한 없음
					alert('로그인이 필요합니다.');
					window.location.href = '../index.html';
					return;
				}
				if (!response.ok) throw new Error('HTTP ' + response.status);

				const result = await response.json();
				const application = result?.data?.application || null;
				if (!result?.success || !application) {
					alert(result?.message || '비자 신청 정보를 불러오지 못했습니다.');
					return;
				}
				__visaApplication = application;

				// Get visaType from application (default to 'group' if not set)
				const visaType = (application.visaType || 'group').toLowerCase();
				__currentVisaType = visaType;

				// Render document section based on visa type
				renderDocumentSection(visaType);

				const applyToDom = () => {
					// Booking 정보
					setValue('bookingIdDisplay', pickFirst(application, ['bookingId', 'transactNo']) || '-');
					setValue('productName', pickFirst(application, ['packageName', 'productName', 'package_name', 'destinationCountry']) || '-');

					const createdAt = pickFirst(application, ['submittedAt', 'createdAt', 'applicationDate', 'submitted_at']);
					setValue('applicationDate', formatDateTime(createdAt) || '-');

					// Departure date
					const depDate = pickFirst(application, ['departureDate', 'departure_date']);
					setValue('departureDate', depDate ? formatDateTime(depDate).split(' ')[0] : '-');

					// Booking Status
					const bookingStatus = pickFirst(application, ['bookingStatus', 'booking_status']) || '';
					const statusMap = {
						'pending': 'Pending',
						'confirmed': 'Confirmed',
						'completed': 'Completed',
						'cancelled': 'Cancelled'
					};
					setValue('bookingStatusDisplay', statusMap[bookingStatus.toLowerCase()] || bookingStatus || '-');

					// Visa Type 표시
					const visaTypeLabel = visaType === 'individual' ? 'Individual' : 'Group';
					setValue('visaTypeDisplay', visaTypeLabel);

					// Individual visa: Documents Send 상태 표시 (Document details 섹션에 표시)
					if (visaType === 'individual') {
						// visaSend can be integer (1/0) or string ('yes'/'no')
						const visaSendRaw = application.visaSend;
						const visaSendLabel = (visaSendRaw === 1 || visaSendRaw === '1' || String(visaSendRaw).toLowerCase() === 'yes') ? 'Yes' : 'No';
						setValue('docSendStatus', visaSendLabel);
					}

					// 상태(자동 산정/표시)
					let uiStatus = normalizeVisaStatus(application.status);

					// Individual visa: Documents Send가 yes면 Under Review로 표시
					if (visaType === 'individual') {
						// visaSend can be integer (1/0) or string ('yes'/'no')
						const visaSendRaw = application.visaSend;
						const isVisaSendYes = (visaSendRaw === 1 || visaSendRaw === '1' || String(visaSendRaw).toLowerCase() === 'yes');
						const visaFile = String(pickFirst(application, ['visaFile', 'visa_file', 'visaDocument', 'visa_document', 'visaUrl']) || '').trim();
						if (visaFile) {
							uiStatus = 'approved';
						} else if (isVisaSendYes) {
							uiStatus = 'reviewing';
						} else {
							uiStatus = 'pending';
						}
					}

					setValue('statusDisplay', statusLabel(uiStatus)); // (존재할 때만)
					setSelect('statusSelect', uiStatus);
					syncJwSelectDisplay(document.getElementById('statusSelect'));

					// 신청자 정보
					setSelect('honorific', pickFirst(application, ['honorific', 'title', 'salutation']));
					syncJwSelectDisplay(document.getElementById('honorific'));
					setValue('firstName', pickFirst(application, ['fName', 'firstName', 'fname', 'applicantFirstName']));
					setValue('lastName', pickFirst(application, ['lName', 'lastName', 'lname', 'applicantLastName']));
					setSelect('gender', String(pickFirst(application, ['gender']) || '').toLowerCase());
					syncJwSelectDisplay(document.getElementById('gender'));
					setValue('age', pickFirst(application, ['age']));
					setValue('birthDate', pickFirst(application, ['birthDate', 'dateOfBirth', 'dob']));

					setValue('countryOfOrigin', pickFirst(application, ['nationality', 'countryOfOrigin', 'country_of_origin']));
					setValue('passportNumber', pickFirst(application, ['passportNumber', 'passport_no', 'passportNo']));
					setValue('passportIssueDate', pickFirst(application, ['passportIssueDate', 'passport_issue_date']));
					setValue('passportExpiryDate', pickFirst(application, ['passportExpiryDate', 'passportExpirationDate', 'passport_expiry_date']));

					// 서류 내역 - 동적으로 렌더링된 문서들 업데이트
					const config = DOCUMENT_CONFIG[__currentVisaType] || DOCUMENT_CONFIG.group;
					config.forEach(doc => {
						// download-only documents (individual visa) don't need file path checks
						if (doc.download && __currentVisaType === 'individual') return;
						setDocRow(doc.key, application);
					});
				};

				applyToDom();
				// init(super.js)가 jw_select 등을 늦게 적용하는 경우가 있어 재적용(값이 “비어 보이는” 현상 방지)
				setTimeout(applyToDom, 120);
				setTimeout(applyToDom, 450);

				// 여권 사진 프리뷰
				const passportPhoto = pickFirst(application, ['passportPhoto', 'passport_photo', 'passportPhotoUrl']);
				const preview = document.getElementById('passportPhotoPreview');
				const metaEl = document.getElementById('passportPhotoMeta');
				if (preview) {
					if (passportPhoto) {
						let url = String(passportPhoto).trim();
						// uploads 경로는 절대경로로 보정(상대경로면 /admin/super/ 아래로 붙어서 깨짐)
						if (url.startsWith('uploads/')) url = '/' + url;

						// uploads 파일은 download.php(inline)로 불러오면 권한/헤더 차이에도 안정적으로 표시됨
						let bgUrl = url;
						if (bgUrl.startsWith('/uploads/')) {
							bgUrl = `/backend/api/download.php?file=${encodeURIComponent(bgUrl)}&inline=1`;
						}

						preview.style.backgroundImage = `url('${bgUrl}')`;
						preview.style.backgroundSize = 'cover';
						preview.style.backgroundPosition = 'center';
						if (metaEl) {
							const name = url.startsWith('data:') ? 'Image' : (url.split('/').pop() || url);
							metaEl.textContent = name;
							metaEl.setAttribute('data-lan-eng', url.startsWith('data:') ? 'Image' : name);
						}
					} else {
						preview.style.backgroundImage = 'none';
						if (metaEl) {
							metaEl.textContent = '파일 없음';
							metaEl.setAttribute('data-lan-eng', 'File not found');
						}
					}
				}

				// 비자 파일 표시(있으면 목록에 노출)
				__renderDocsAndVisaFile();

				// 상태 자동 산정/동기화(셀렉트는 비활성화)
				await ensureAutoStatus(application);
			} catch (error) {
				console.error('Error loading visa application detail:', error);
				alert('비자 신청 상세를 불러오는 중 오류가 발생했습니다.');
			}
		}

		// handleSaveStatus는 요구사항(자동 상태)으로 사용하지 않음

		async function handleVisaUpload() {
			try {
				if (!visaApplicationId) return;
				const input = document.getElementById('visaFileInput');
				const file = input?.files?.[0] || null;
				if (!file) {
					// 파일 선택 취소
					return;
				}

				const fd = new FormData();
				fd.append('file', file);
				fd.append('type', 'visa');
				fd.append('related_id', String(visaApplicationId));

				// admin 페이지에서는 절대경로로 업로드 API 호출해야 함(/admin/backend/api로 잘못 붙는 문제 방지)
				const upRes = await fetch('/backend/api/upload.php', {
					method: 'POST',
					body: fd,
					credentials: 'same-origin'
				});
				const upJson = await upRes.json();
				if (!upRes.ok || !upJson?.success) {
					alert('File upload failed: ' + (upJson?.message || ('HTTP ' + upRes.status)));
					return;
				}

				const filePath = upJson?.data?.filePath || upJson?.data?.file_path || '';
				if (!filePath) {
					alert('No file path returned from upload.');
					return;
				}
				// SMT 수정: DB 반영은 저장 버튼 클릭 시 수행
				__pending.newVisaFilePath = filePath;
				__pending.newVisaFileSize = file.size || 0;  // 파일 크기 저장
				__pending.deleteVisaFile = false;
				__renderDocsAndVisaFile();
				alert('File uploaded. Click Save to apply changes.');
			} catch (e) {
				console.error('handleVisaUpload error:', e);
				alert('An error occurred while uploading the visa file.');
			}
		}

		async function deleteVisaFile() {
			try {
				if (!visaApplicationId) return;
				// 1) 새로 업로드한(미저장) 파일이 있으면: "변경 취소"로 동작
				if (__pending.newVisaFilePath) {
					if (!confirm('Remove the uploaded file before saving?')) return;
					__pending.newVisaFilePath = '';
					__pending.newVisaFileSize = 0;
					__renderDocsAndVisaFile();
					return;
				}
				// 2) 기존 파일은 즉시 서버에서 삭제 처리
				const hasFile = String(pickFirst(__visaApplication, ['visaFile', 'visa_file', 'visaDocument', 'visa_document', 'visaUrl']) || '').trim() !== '';
				if (!hasFile) return;
				if (!confirm('Delete the uploaded visa file?')) return;
				const res = await fetch('../backend/api/super-api.php', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ action: 'deleteVisaFile', visaApplicationId }),
					credentials: 'same-origin'
				});
				const j = await res.json().catch(() => ({}));
				if (!res.ok || !j?.success) {
					alert('Failed to delete visa file: ' + (j?.message || ('HTTP ' + res.status)));
					return;
				}
				// 로컬 상태 초기화 후 재로딩
				__pending.deleteVisaFile = false;
				await loadVisaApplicationDetail();
			} catch (e) {
				console.error('deleteVisaFile error:', e);
				alert('An error occurred while deleting the visa file.');
			}
		}

		async function handleSaveVisaChanges() {
			try {
				if (!visaApplicationId) return;
				if (!__hasPendingChanges()) return;
				const btn = document.getElementById('saveStatusBtn');
				if (btn) btn.disabled = true;

				// 1) delete docs
				for (const k of Array.from(__pending.deleteDocs)) {
					const res = await fetch('../backend/api/super-api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'deleteVisaDocument', visaApplicationId, docKey: k }),
						credentials: 'same-origin'
					});
					const j = await res.json().catch(() => ({}));
					if (!res.ok || !j?.success) {
						alert('Failed to save (delete document): ' + (j?.message || ('HTTP ' + res.status)));
						__setSaveEnabled(true);
						return;
					}
				}

				// 2) delete visa file
				if (__pending.deleteVisaFile) {
					const res = await fetch('../backend/api/super-api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'deleteVisaFile', visaApplicationId }),
						credentials: 'same-origin'
					});
					const j = await res.json().catch(() => ({}));
					if (!res.ok || !j?.success) {
						alert('Failed to save (delete visa file): ' + (j?.message || ('HTTP ' + res.status)));
						__setSaveEnabled(true);
						return;
					}
				}

				// 3) update visa file
				if (__pending.newVisaFilePath) {
					const res = await fetch('../backend/api/super-api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'updateVisaFile', visaApplicationId, visaFilePath: __pending.newVisaFilePath }),
						credentials: 'same-origin'
					});
					const j = await res.json().catch(() => ({}));
					if (!res.ok || !j?.success) {
						alert('Failed to save (upload visa file): ' + (j?.message || ('HTTP ' + res.status)));
						__setSaveEnabled(true);
						return;
					}
				}

				// 4) status update (자동 산정 값으로 저장)
				try {
					const effective = __effectiveApplication(__visaApplication);
					const derived = deriveUiStatusFromApplication(effective);
					await fetch('../backend/api/super-api.php', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ action: 'updateVisaStatus', visaApplicationId, status: derived }),
						credentials: 'same-origin'
					}).catch(() => null);
				} catch (_) {}

				alert('Saved.');
				window.location.reload();
			} catch (e) {
				console.error('handleSaveVisaChanges error:', e);
				alert('An error occurred while saving.');
				__setSaveEnabled(true);
			}
		}

		function downloadAttachment(filePath) {
			const raw = String(filePath || '').trim();
			if (!raw) return;

			// 파일 경로가 "download.php?file=..." 형태로 들어오는 구버전/혼합 데이터 대응
			let p = raw;
			try {
				if (p.includes('download.php?file=')) {
					const u = new URL(p, window.location.origin);
					const fp = u.searchParams.get('file');
					if (fp) p = fp;
				}
			} catch (_) { /* ignore */ }

			// download.php는 /uploads 하위만 허용하므로, uploads로 시작하면 /를 보강
			if (p.startsWith('uploads/')) p = '/' + p;

			// admin 페이지에서는 절대경로로 호출해야 함(/admin/backend/api 경로로 잘못 붙는 문제 방지)
			window.open(`/backend/api/download.php?file=${encodeURIComponent(p)}`, '_blank');
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		// Render document section based on visa type
		function renderDocumentSection(visaType) {
			const container = document.getElementById('documentGridWrap');
			if (!container) return;

			const type = (visaType || 'group').toLowerCase();
			__currentVisaType = type;

			container.innerHTML = '';

			// For individual visa, show only "Documents Send" status
			if (type === 'individual') {
				const div = document.createElement('div');
				div.className = 'grid-item';
				div.innerHTML = `
					<label class="label-name">Documents Send</label>
					<input type="text" class="form-control" id="docSendStatus" value="" disabled>
				`;
				container.appendChild(div);
				return;
			}

			// For group visa, show upload documents
			const config = DOCUMENT_CONFIG[type] || DOCUMENT_CONFIG.group;

			config.forEach(doc => {
				const div = document.createElement('div');
				div.className = 'grid-item';

				// Regular upload-required documents (group visa)
				const uploadedHtml = doc.download ? `
					<button type="button" class="jw-button typeF" id="docStaticDl-${doc.key}" aria-label="download template" onclick="downloadStaticDoc('${escapeHtml(doc.downloadPath)}')" title="Download template">
						<img src="../image/button-download.svg" alt="">
					</button>
				` : '';

				div.innerHTML = `
					<label class="label-name">${escapeHtml(doc.title)}</label>
					<div class="cell">
						<div class="field-row jw-center">
							<div class="jw-center jw-gap10">
								<img src="../image/file.svg" alt="">
								<span id="docMeta-${doc.key}">No file</span>
							</div>
							<div class="jw-center jw-gap10">
								${uploadedHtml}
								<button type="button" class="jw-button typeF" id="docDl-${doc.key}" aria-label="download" style="display:none;">
									<img src="../image/button-download.svg" alt="">
								</button>
								<button type="button" class="jw-button typeF" id="docDel-${doc.key}" aria-label="delete" disabled style="display:none;">
									<img src="../image/button-close2.svg" alt="">
								</button>
							</div>
						</div>
					</div>
				`;

				container.appendChild(div);
			});

			// Wire download and delete buttons for dynamically created elements
			wireDocButtonsDynamic();
		}

		// Download static document (template files)
		function downloadStaticDoc(path) {
			if (!path) return;
			window.open(path, '_blank');
		}

		// Wire dynamic document buttons
		function wireDocButtonsDynamic() {
			const config = DOCUMENT_CONFIG[__currentVisaType] || DOCUMENT_CONFIG.group;
			config.forEach((doc) => {
				const dlBtn = document.getElementById(`docDl-${doc.key}`);
				if (dlBtn && !doc.download) {
					dlBtn.onclick = (e) => {
						e.preventDefault();
						const path = __docPathFor(doc.key, __visaApplication);
						if (path) downloadAttachment(path);
					};
				}

				const delBtn = document.getElementById(`docDel-${doc.key}`);
				if (delBtn) {
					delBtn.onclick = async (e) => {
						e.preventDefault();
						if (!visaApplicationId) return;
						const path = __docPathFor(doc.key, __visaApplication);
						if (!path) return;
						if (!confirm('해당 서류를 삭제하시겠습니까?')) return;
						try {
							const res = await fetch('../backend/api/super-api.php', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify({ action: 'deleteVisaDocument', visaApplicationId, docKey: doc.key }),
								credentials: 'same-origin'
							});
							const j = await res.json().catch(() => ({}));
							if (!res.ok || !j?.success) {
								alert('삭제 실패: ' + (j?.message || ('HTTP ' + res.status)));
								return;
							}
							try { __pending.deleteDocs.delete(doc.key); } catch (_) {}
							await loadVisaApplicationDetail();
						} catch (err) {
							console.error('deleteVisaDocument error:', err);
							alert('삭제 중 오류가 발생했습니다.');
						}
					};
				}
			});
		}

		// Get document keys for current visa type
		function getCurrentDocKeys() {
			const config = DOCUMENT_CONFIG[__currentVisaType] || DOCUMENT_CONFIG.group;
			return config.map(d => d.key);
		}
	</script>
</body>

</html>


