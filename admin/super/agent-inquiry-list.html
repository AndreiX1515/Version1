<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>SMART TRAVEL ADMIN</title>

	<!--   -->
	<link rel="shortcut icon" href="../image/favicon.ico">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/a_reset.css">
	<link rel="stylesheet" href="../css/a_variables.css">
	<link rel="stylesheet" href="../css/a_components.css">
	<link rel="stylesheet" href="../css/a_contents.css">
</head>

<body>

	<!-- header   -->
	<header class="layout-header"></header>

	<!--   -->
	<main class="layout-main">
		<!-- nav   -->
		<nav class="layout-nav"></nav>

		<section class="layout-content">
			<h1 class="page-title" data-lan-eng="Agent Inquiry List">Agent Inquiry List</h1>

			<div class="card-panel jw-mgt32">

				<div class="list-header">
					<div class="result-count">
						<span data-lan-eng="Search results">Search results</span> <span class="result-count__num" id="totalCount">0</span><span data-lan-eng="items">items</span>
					</div>
					<form class="search-form" action="" method="get" id="filterForm">
						<select class="select" name="replyStatus" id="replyStatusFilter" onchange="applyFilters()">
							<option value="" data-lan-eng="Response Status">Response Status</option>
							<option value="unanswered" data-lan-eng="Not Responded">Not Responded</option>
							<option value="answered" data-lan-eng="Response Complete">Response Complete</option>
						</select>
						<select class="select" name="processingStatus" id="processingStatusFilter" onchange="applyFilters()">
							<option value="" data-lan-eng="Processing Status">Processing Status</option>
							<option value="pending" data-lan-eng="Received">Received</option>
							<option value="processing" data-lan-eng="In Progress">In Progress</option>
							<option value="completed" data-lan-eng="Processing Complete">Processing Complete</option>
						</select>
						<select class="select" name="sortOrder" id="sortOrderFilter" onchange="applyFilters()">
							<option value="latest" data-lan-eng="Latest">Latest</option>
							<option value="oldest" data-lan-eng="Oldest">Oldest</option>
						</select>
					</form>
				</div>

				<table class="jw-tableA">
					<colgroup>
						<col class="col-60"> <!-- No -->
						<col> <!--  -->
						<col> <!--   -->
						<col> <!--  -->
						<col> <!--   -->
						<col> <!--   -->
					</colgroup>
					<thead>
						<tr>
							<th class="no">No</th>
							<th data-lan-eng="Agent Name">Agent Name</th>
							<th data-lan-eng="Inquiry Title">Inquiry Title</th>
							<th data-lan-eng="Date created">Date created</th>
							<th data-lan-eng="Response status">Response status</th>
							<th data-lan-eng="Processing status">Processing status</th>
						</tr>
					</thead>
					<tbody id="inquiriesTableBody">
						<tr>
							<td colspan="6" class="is-center">  ...</td>
						</tr>
					</tbody>
				</table>

				
				<div class="jw-pagebox" role="navigation" aria-label="">
					<div class="contents">
						<button type="button" class="first" aria-label=" " aria-disabled="false">
							<img src="../image/first.svg" alt="">
						</button>
						<button type="button" class="prev" aria-label=" " aria-disabled="false">
							<img src="../image/prev.svg" alt="">
						</button>

						<div class="page" role="list">
							<button type="button" class="p" role="listitem">1</button>
							<button type="button" class="p" role="listitem">2</button>
							<button type="button" class="p show" role="listitem" aria-current="page">3</button>
							<button type="button" class="p" role="listitem">4</button>
							<button type="button" class="p" role="listitem">5</button>
						</div>

						<button type="button" class="next" aria-label=" " aria-disabled="false">
							<img src="../image/next.svg" alt="">
						</button>
						<button type="button" class="last" aria-label=" " aria-disabled="false">
							<img src="../image/last.svg" alt="">
						</button>
					</div>
				</div>

			</div>
			
			<div class="controller">
				<button type="button" class="jw-button typeA" id="downloadBtn" data-lan-eng="Download">Download</button>
			</div>

		</section>

	</main>

	<script src="../js/default.js"></script>
	<script src="../js/super.js"></script>

	<script>
		init({
			headerUrl: '../inc/header.html',
			navUrl: '../inc/nav_super.html'
		});

		let currentPage = 1;
		const limit = 10;
		let currentFilters = { replyStatus: '', processingStatus: '', sortOrder: 'latest' };
		let __lastInquiries = [];

		function __adminLang() {
			try {
				let lang = (typeof getCookie === 'function' ? getCookie('lang') : null) || 'eng';
				lang = String(lang || 'eng').toLowerCase();
				if (lang !== 'eng' && lang !== 'tl') lang = 'eng';
				return lang;
			} catch (_) { return 'eng'; }
		}

		function __normalizeReplyStatus(v) {
			const raw = String(v ?? '').trim();
			const low = raw.toLowerCase();
			if (!raw) return 'unanswered';
			if (low === 'unanswered' || low === 'unanswered ' || low === 'unresponded' || low === 'not responded') return 'unanswered';
			if (low === 'answered' || low === 'responded' || low === 'response complete') return 'answered';
			if (raw.includes('')) return 'unanswered';
			if (raw.includes('')) return 'answered';
			return 'unanswered';
		}

		function __normalizeProcessingStatus(v) {
			const raw = String(v ?? '').trim();
			const low = raw.toLowerCase();
			if (!raw) return 'pending';
			if (low === 'pending' || low === 'received' || low === 'open') return 'pending';
			if (low === 'processing' || low === 'in progress' || low === 'in_progress') return 'processing';
			if (low === 'completed' || low === 'processing complete' || low === 'resolved' || low === 'closed') return 'completed';
			if (raw.includes('')) return 'pending';
			if (raw.includes('')) return 'processing';
			if (raw.includes(' ')) return 'completed';
			return 'pending';
		}

		function __tReplyStatus(raw) {
			const lang = __adminLang();
			const key = __normalizeReplyStatus(raw);
			const map = {
				unanswered: { eng: 'Not Responded', tl: 'Not Responded' },
				answered: { eng: 'Response Complete', tl: 'Response Complete' }
			};
			return (map[key] && map[key][lang]) ? map[key][lang] : String(raw ?? '');
		}

		function __tProcessingStatus(raw) {
			const lang = __adminLang();
			const key = __normalizeProcessingStatus(raw);
			const map = {
				pending: { eng: 'Received', tl: 'Received' },
				processing: { eng: 'In Progress', tl: 'In Progress' },
				completed: { eng: 'Processing Complete', tl: 'Processing Complete' }
			};
			return (map[key] && map[key][lang]) ? map[key][lang] : String(raw ?? '');
		}

		function renderInquiriesTable(inquiries) {
			const tbody = document.getElementById('inquiriesTableBody');
			if (!tbody) return;
			__lastInquiries = Array.isArray(inquiries) ? inquiries : [];

			if (!__lastInquiries.length) {
				tbody.innerHTML = '<tr><td colspan="6" class="is-center">  .</td></tr>';
				return;
			}

			tbody.innerHTML = __lastInquiries.map((inquiry) => {
				const createdAt = inquiry.createdAt ? inquiry.createdAt.split(' ')[0] : '';
				return `
					<tr onclick="window.location.href='agent-inquiry-detail.html?id=${escapeHtml(inquiry.inquiryId)}'" style="cursor: pointer;">
						<td class="no is-center">${inquiry.rowNum || ''}</td>
						<td class="is-center">${escapeHtml(inquiry.branchName || '')}</td>
						<td class="is-center">${escapeHtml(inquiry.inquiryTitle || '')}</td>
						<td class="is-center">${escapeHtml(createdAt)}</td>
						<td class="is-center">${escapeHtml(__tReplyStatus(inquiry.replyStatus || ''))}</td>
						<td class="is-center">${escapeHtml(__tProcessingStatus(inquiry.processingStatus || ''))}</td>
					</tr>
				`;
			}).join('');
		}

		document.addEventListener('DOMContentLoaded', async () => {
			try {
				const sessionResponse = await fetch('../backend/api/check-session.php', {
					credentials: 'same-origin'
				});
				const sessionData = await sessionResponse.json();
				
				const isAdmin = sessionData && sessionData.authenticated && (sessionData.userType === 'admin' || sessionData.userType === 'super');
				if (!isAdmin) {
					window.location.href = '../index.html';
					return;
				}
				
				await loadAgentInquiries();
			} catch (error) {
				console.error('Session check error:', error);
				window.location.href = '../index.html';
				return;
			}
		});

		function applyFilters() {
			currentFilters.replyStatus = document.getElementById('replyStatusFilter').value;
			currentFilters.processingStatus = document.getElementById('processingStatusFilter').value;
			currentFilters.sortOrder = document.getElementById('sortOrderFilter').value;
			currentPage = 1;
			loadAgentInquiries();
		}

		async function loadAgentInquiries(page = currentPage) {
			try {
				const tbody = document.getElementById('inquiriesTableBody');
				if (tbody) {
					tbody.innerHTML = '<tr><td colspan="6" class="is-center">  ...</td></tr>';
				}

				const params = new URLSearchParams({
					action: 'getAgentInquiries',
					page: page,
					limit: limit
				});
				
				if (currentFilters.replyStatus) params.append('replyStatus', currentFilters.replyStatus);
				if (currentFilters.processingStatus) params.append('processingStatus', currentFilters.processingStatus);
				if (currentFilters.sortOrder) params.append('sortOrder', currentFilters.sortOrder);

				const response = await fetch(`../backend/api/super-api.php?${params.toString()}`, {
					credentials: 'same-origin'
				});

				if (response.status === 401) {
					window.location.href = '../index.html';
					return;
				}
				if (!response.ok) throw new Error('HTTP ' + response.status);

				const result = await response.json();

				if (result.success && result.data) {
					const { inquiries, pagination } = result.data;
					
					const totalCountEl = document.getElementById('totalCount');
					if (totalCountEl) totalCountEl.textContent = pagination.totalCount || 0;

					renderInquiriesTable(inquiries);

					if (pagination) {
						updatePagination(pagination);
						currentPage = pagination.currentPage;
					}
				}
			} catch (error) {
				console.error('Error loading agent inquiries:', error);
				const tbody = document.getElementById('inquiriesTableBody');
				if (tbody) {
					tbody.innerHTML = '<tr><td colspan="6" class="is-center">    .</td></tr>';
				}
			}
		}

		//   ( lang   language_apply )    
		window.addEventListener('languageChanged', () => {
			try { renderInquiriesTable(__lastInquiries); } catch (_) { }
		});

		function updatePagination(pagination) {
			const box = document.querySelector('.jw-pagebox');
			if (!box) return;
			const pageWrap = box.querySelector('.page');
			if (!pageWrap) return;

			const totalPages = Math.max(1, Number(pagination.totalPages || 1));
			const current = Math.max(1, Number(pagination.currentPage || 1));
			const groupSize = 5;
			const groupStart = Math.floor((current - 1) / groupSize) * groupSize + 1;
			const groupEnd = Math.min(totalPages, groupStart + groupSize - 1);

			pageWrap.innerHTML = '';
			for (let p = groupStart; p <= groupEnd; p++) {
				const btn = document.createElement('button');
				btn.type = 'button';
				btn.className = 'p' + (p === current ? ' show' : '');
				btn.setAttribute('role', 'listitem');
				if (p === current) btn.setAttribute('aria-current', 'page');
				btn.textContent = String(p);
				btn.addEventListener('click', () => loadAgentInquiries(p));
				pageWrap.appendChild(btn);
			}

			const firstBtn = box.querySelector('.first');
			const prevBtn = box.querySelector('.prev');
			const nextBtn = box.querySelector('.next');
			const lastBtn = box.querySelector('.last');

			const prevTarget = Math.max(1, groupStart - groupSize);
			const nextTarget = Math.min(totalPages, groupStart + groupSize);

			if (firstBtn) firstBtn.onclick = () => loadAgentInquiries(1);
			if (lastBtn) lastBtn.onclick = () => loadAgentInquiries(totalPages);
			if (prevBtn) prevBtn.onclick = () => loadAgentInquiries(prevTarget);
			if (nextBtn) nextBtn.onclick = () => loadAgentInquiries(nextTarget);
		}

		function handleDownload() {
			const params = new URLSearchParams({
				action: 'downloadAgentInquiries',
				replyStatus: currentFilters.replyStatus,
				processingStatus: currentFilters.processingStatus,
				sortOrder: currentFilters.sortOrder
			});
			window.location.href = `../backend/api/super-api.php?${params.toString()}`;
		}

		document.getElementById('downloadBtn')?.addEventListener('click', (e) => {
			e.preventDefault();
			handleDownload();
		});

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}
	</script>
</body>

</html>
