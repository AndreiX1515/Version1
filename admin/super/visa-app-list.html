<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0">
	<title>SMART TRAVEL ADMIN</title>

	<!-- 공통 스타일 -->
	<link rel="shortcut icon" href="../image/favicon.ico">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="../css/a_reset.css">
	<link rel="stylesheet" href="../css/a_variables.css">
	<link rel="stylesheet" href="../css/a_components.css">
	<link rel="stylesheet" href="../css/a_contents.css">
</head>

<body>

	<!-- header 들어올 자리 -->
	<header class="layout-header"></header>

	<!-- 본문 영역 -->
	<main class="layout-main">
		<!-- nav 들어올 자리 -->
		<nav class="layout-nav"></nav>

		<section class="layout-content">
			<h1 class="page-title" data-lan-eng="Visa Application List">비자 신청 목록</h1>

			<div class="card-panel jw-mgt32">

				<div class="list-header">
					<div class="result-count">
						<span data-lan-eng="Search results">검색결과</span> <span class="result-count__num" id="totalCount">0</span><span data-lan-eng="items">개</span>
					</div>
					<form class="search-form" action="" method="get" id="filterForm">
						<select class="select" name="status" id="statusFilter" onchange="applyFilters()">
							<option value="" data-lan-eng="Overall Status">전체 상태</option>
							<option value="pending" data-lan-eng="Request Received">요청 접수</option>
							<option value="reviewing" data-lan-eng="Under Review">심사중</option>
							<option value="approved" data-lan-eng="Issuance Complete">발급 완료</option>
							<option value="rejected" data-lan-eng="Returned">반려</option>
						</select>
						<select class="select" name="sortOrder" id="sortOrderFilter" onchange="applyFilters()">
							<option value="latest" data-lan-eng="Latest">최신순</option>
							<option value="oldest" data-lan-eng="Oldest">오래된 순</option>
						</select>
					</form>
				</div>

				<table class="jw-tableA">
					<colgroup>
						<col class="col-60"> <!-- No -->
						<col> <!-- 신청자명 -->
						<col> <!-- Visa Type -->
						<col> <!-- 신청일시 -->
						<col> <!-- 상태 -->
					</colgroup>
					<thead>
						<tr>
							<th class="no is-center">No</th>
							<th class="is-center" data-lan-eng="Applicant name">신청자명</th>
							<th class="is-center" data-lan-eng="Visa Type">Visa Type</th>
							<th class="is-center" data-lan-eng="Application date/time">신청일시</th>
							<th class="is-center" data-lan-eng="Status">상태</th>
						</tr>
					</thead>
					<tbody id="visaAppsTableBody">
						<tr>
							<td colspan="5" class="is-center">데이터를 불러오는 중...</td>
						</tr>
					</tbody>
				</table>


				
				<div class="jw-pagebox" role="navigation" aria-label="페이지네이션">
					<div class="contents">
						<button type="button" class="first" aria-label="첫 페이지" aria-disabled="false">
							<img src="../image/first.svg" alt="">
						</button>
						<button type="button" class="prev" aria-label="이전 페이지" aria-disabled="false">
							<img src="../image/prev.svg" alt="">
						</button>

						<div class="page" role="list">
							<button type="button" class="p" role="listitem">1</button>
							<button type="button" class="p" role="listitem">2</button>
							<button type="button" class="p show" role="listitem" aria-current="page">3</button>
							<button type="button" class="p" role="listitem">4</button>
							<button type="button" class="p" role="listitem">5</button>
						</div>

						<button type="button" class="next" aria-label="다음 페이지" aria-disabled="false">
							<img src="../image/next.svg" alt="">
						</button>
						<button type="button" class="last" aria-label="마지막 페이지" aria-disabled="false">
							<img src="../image/last.svg" alt="">
						</button>
					</div>
				</div>

			</div>
			
			<div class="controller">
				<button type="button" class="jw-button typeA" id="downloadBtn" onclick="handleDownload()" data-lan-eng="Download">다운로드</button>
			</div>

		</section>

	</main>

	<script src="../js/default.js?v=20251226_visalistfix1"></script>
	<script src="../js/super.js?v=20251226_visalistfix1"></script>

	<script>
		init({
			headerUrl: '../inc/header.html',
			navUrl: '../inc/nav_super.html'
		});

		let currentPage = 1;
		const limit = 10;
		let currentFilters = { status: '', sortOrder: 'latest' };

		document.addEventListener('DOMContentLoaded', async () => {
			try {
				const sessionResponse = await fetch('../backend/api/check-session.php', {
					credentials: 'same-origin'
				});
				const sessionData = await sessionResponse.json();
				
				const isAdmin = sessionData && sessionData.authenticated && (sessionData.userType === 'admin' || sessionData.userType === 'super');
				if (!isAdmin) {
					window.location.href = '../index.html';
					return;
				}
				
				await loadVisaApplications();
			} catch (error) {
				console.error('Session check error:', error);
				window.location.href = '../index.html';
				return;
			}
		});

		function applyFilters() {
			currentFilters.status = document.getElementById('statusFilter').value;
			currentFilters.sortOrder = document.getElementById('sortOrderFilter').value;
			currentPage = 1;
			loadVisaApplications();
		}

		async function loadVisaApplications(page = currentPage) {
			try {
				const tbody = document.getElementById('visaAppsTableBody');
				if (tbody) {
					tbody.innerHTML = '<tr><td colspan="4" class="is-center">데이터를 불러오는 중...</td></tr>';
				}

				const params = new URLSearchParams({
					action: 'getVisaApplications',
					page: page,
					limit: limit
				});
				
				if (currentFilters.status) params.append('status', currentFilters.status);
				if (currentFilters.sortOrder) params.append('sortOrder', currentFilters.sortOrder);

				const response = await fetch(`../backend/api/super-api.php?${params.toString()}`, {
					credentials: 'same-origin'
				});

				if (response.status === 401) {
					window.location.href = '../index.html';
					return;
				}
				if (!response.ok) throw new Error('HTTP ' + response.status);

				const result = await response.json();

				if (result.success && result.data) {
					const { applications, pagination } = result.data;
					
					const totalCountEl = document.getElementById('totalCount');
					if (totalCountEl) totalCountEl.textContent = pagination.totalCount || 0;

					if (tbody) {
						if (applications.length === 0) {
							tbody.innerHTML = '<tr><td colspan="5" class="is-center">No visa applications found.</td></tr>';
						} else {
							tbody.innerHTML = applications.map((app, index) => {
								const createdAt = app.createdAt ? app.createdAt.replace('T', ' ').substring(0, 16) : '';
								// 요구사항(id 93): 상태 표기는 영문 라벨로 노출
								const statusMap = {
									'pending': 'Request Received',
									'reviewing': 'Under Review',
									'approved': 'Issuance Complete',
									'rejected': 'Returned'
								};
								const statusLabel = statusMap[String(app.status || '').toLowerCase()] || 'Request Received';
								const appId = app.visaApplicationId || app.applicationId || app.id;
								const rowNum = pagination ? (pagination.totalCount - (page - 1) * limit - index) : (app.rowNum || index + 1);
								// Visa Type 표시
								const visaType = (app.visaType || 'individual').toLowerCase();
								const visaTypeLabel = visaType === 'group' ? 'Group' : 'Individual';
								return `
									<tr onclick="window.location.href='visa-app-detail.html?id=${escapeHtml(appId)}'" style="cursor: pointer;">
										<td class="no is-center">${rowNum}</td>
										<td class="is-center">${escapeHtml(app.applicantName || '')}</td>
										<td class="is-center">${escapeHtml(visaTypeLabel)}</td>
										<td class="is-center">${escapeHtml(createdAt)}</td>
										<td class="is-center">${escapeHtml(statusLabel)}</td>
									</tr>
								`;
							}).join('');
						}
					}

					if (pagination) {
						updatePagination(pagination);
						currentPage = pagination.currentPage;
					}
				}
			} catch (error) {
				console.error('Error loading visa applications:', error);
				const tbody = document.getElementById('visaAppsTableBody');
				if (tbody) {
					tbody.innerHTML = '<tr><td colspan="5" class="is-center">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
				}
			}
		}
		
		function updatePagination(pagination) {
			const { currentPage, totalPages } = pagination;
			const pageContainer = document.querySelector('.jw-pagebox .page');
			
			if (pageContainer) {
				pageContainer.innerHTML = '';
				const groupSize = 5;
				const groupStart = Math.floor((currentPage - 1) / groupSize) * groupSize + 1;
				const groupEnd = Math.min(totalPages, groupStart + groupSize - 1);
				
				for (let i = groupStart; i <= groupEnd; i++) {
					const button = document.createElement('button');
					button.type = 'button';
					button.className = 'p' + (i === currentPage ? ' show' : '');
					button.setAttribute('role', 'listitem');
					if (i === currentPage) button.setAttribute('aria-current', 'page');
					button.textContent = i;
					button.onclick = () => loadVisaApplications(i);
					pageContainer.appendChild(button);
				}
			}
			
			const firstBtn = document.querySelector('.jw-pagebox .first');
			const prevBtn = document.querySelector('.jw-pagebox .prev');
			const nextBtn = document.querySelector('.jw-pagebox .next');
			const lastBtn = document.querySelector('.jw-pagebox .last');
			
			if (firstBtn) {
				firstBtn.disabled = currentPage === 1;
				firstBtn.setAttribute('aria-disabled', currentPage === 1);
				firstBtn.onclick = currentPage === 1 ? null : () => loadVisaApplications(1);
			}
			// prev/next는 5개 묶음 이동
			const groupSize = 5;
			const groupStart = Math.floor((currentPage - 1) / groupSize) * groupSize + 1;
			const prevTarget = Math.max(1, groupStart - groupSize);
			const nextTarget = Math.min(totalPages, groupStart + groupSize);

			if (prevBtn) {
				prevBtn.disabled = currentPage === 1;
				prevBtn.setAttribute('aria-disabled', currentPage === 1);
				prevBtn.onclick = currentPage === 1 ? null : () => loadVisaApplications(prevTarget);
			}
			if (nextBtn) {
				nextBtn.disabled = currentPage >= totalPages;
				nextBtn.setAttribute('aria-disabled', currentPage >= totalPages);
				nextBtn.onclick = currentPage >= totalPages ? null : () => loadVisaApplications(nextTarget);
			}
			if (lastBtn) {
				lastBtn.disabled = currentPage >= totalPages;
				lastBtn.setAttribute('aria-disabled', currentPage >= totalPages);
				lastBtn.onclick = currentPage >= totalPages ? null : () => loadVisaApplications(totalPages);
			}
		}
		
		async function handleDownload() {
			try {
				const params = new URLSearchParams({
					action: 'downloadVisaApplications',
					status: currentFilters.status,
					sortOrder: currentFilters.sortOrder
				});
				
				window.location.href = `../backend/api/super-api.php?${params.toString()}`;
			} catch (error) {
				console.error('Error downloading CSV:', error);
				alert('다운로드 중 오류가 발생했습니다.');
			}
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}
	</script>
</body>

</html>
