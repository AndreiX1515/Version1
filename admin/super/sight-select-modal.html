<div class="dialog-container">
	<button type="button" class="dialog-close" onclick="modal_close()">
		<i class="ic-close"></i>
	</button>

	<h1 data-lan-eng="Select Sights">Select Sights</h1>

	<div class="dialog-content jw-mgt24">
		<p class="form-desc" data-lan-eng="Select sights to load (multiple selection available)">Select sights to load (multiple selection available).</p>

		<div class="field-row jw-mgt16">
			<input type="text" class="form-control" id="sightSearchInput" placeholder="Search to filter..." autocomplete="off">
			<button type="button" class="jw-button typeA" id="sightSearchBtn">
				<span data-lan-eng="Search">Search</span>
			</button>
		</div>

		<div class="selected-sights jw-mgt12" id="selectedSightsArea" style="display:none;">
			<label class="label-name" style="font-size:12px;color:#4A90D9;">Selected Sights (<span id="selectedCount">0</span>)</label>
			<div id="selectedSightsList" class="selected-sights-list"></div>
		</div>

		<div class="jw-mgt16" id="sightResultsContainer" style="max-height:250px;overflow-y:auto;">
			<div class="sight-results" id="sightResults">
				<p class="is-center">Loading...</p>
			</div>
		</div>
	</div>

	<div class="dialog-controls jw-mgt24">
		<button type="button" class="jw-button typeB" onclick="modal_close()" data-lan-eng="Cancel">Cancel</button>
		<button type="button" class="jw-button typeA" id="confirmBtn" data-lan-eng="Add Selected" disabled>Add Selected</button>
	</div>
</div>

<style>
	.sight-result-item {
		display: flex;
		align-items: center;
		gap: 12px;
		padding: 12px;
		border: 1px solid #e0e0e0;
		border-radius: 8px;
		margin-bottom: 8px;
		cursor: pointer;
		transition: all 0.2s;
	}
	.sight-result-item:hover {
		background: #f5f5f5;
		border-color: #4A90D9;
	}
	.sight-result-item.selected {
		background: #e8f4fd;
		border-color: #4A90D9;
	}
	.sight-result-item .sight-thumb {
		width: 50px;
		height: 50px;
		object-fit: cover;
		border-radius: 4px;
		background: #eee;
		flex-shrink: 0;
	}
	.sight-result-item .sight-info {
		flex: 1;
		min-width: 0;
	}
	.sight-result-item .sight-name {
		font-weight: 600;
		font-size: 14px;
		color: #333;
	}
	.sight-result-item .sight-address {
		font-size: 12px;
		color: #666;
		margin-top: 4px;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}
	.sight-result-item .sight-checkbox {
		width: 20px;
		height: 20px;
		flex-shrink: 0;
		cursor: pointer;
	}
	.no-results {
		text-align: center;
		padding: 20px;
		color: #888;
	}
	.selected-sights-list {
		display: flex;
		flex-wrap: wrap;
		gap: 8px;
		margin-top: 8px;
	}
	.selected-sight-tag {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		padding: 4px 10px;
		background: #4A90D9;
		color: #fff;
		border-radius: 16px;
		font-size: 12px;
	}
	.selected-sight-tag .remove-tag {
		cursor: pointer;
		font-size: 14px;
		line-height: 1;
	}
	.selected-sight-tag .order-num {
		background: rgba(255,255,255,0.3);
		border-radius: 50%;
		width: 18px;
		height: 18px;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 10px;
		font-weight: bold;
	}
</style>

<script>
(function() {
	// Use window-level storage to avoid scope issues
	window._sightModal = {
		searchResults: [],
		selectedSights: []
	};

	const state = window._sightModal;

	async function loadSights() {
		const query = document.getElementById('sightSearchInput')?.value?.trim() || '';
		const resultsContainer = document.getElementById('sightResults');
		if (!resultsContainer) return;

		resultsContainer.innerHTML = '<p class="is-center">Loading...</p>';

		try {
			const params = new URLSearchParams({
				action: 'getSights',
				status: 'active',
				limit: '50'
			});
			if (query) {
				params.set('search', query);
			}

			const response = await fetch('../backend/api/super-api.php?' + params.toString());
			const data = await response.json();

			if (!data.success) {
				throw new Error(data.message || 'Failed to load');
			}

			state.searchResults = data.data?.sights || data.sights || [];

			if (state.searchResults.length === 0) {
				resultsContainer.innerHTML = '<p class="no-results">No sights found. Register sights first.</p>';
				return;
			}

			renderResults();

		} catch (e) {
			console.error('loadSights error:', e);
			resultsContainer.innerHTML = '<p class="no-results" style="color:red;">Error: ' + e.message + '</p>';
		}
	}

	function renderResults() {
		const resultsContainer = document.getElementById('sightResults');
		if (!resultsContainer) return;

		resultsContainer.innerHTML = state.searchResults.map((sight, idx) => {
			const isSelected = state.selectedSights.some(s => s.sightId === sight.sightId);
			const thumbHtml = sight.sightImage
				? '<img src="/uploads/sights/' + sight.sightImage + '" alt="" class="sight-thumb" onerror="this.style.display=\'none\'">'
				: '<div class="sight-thumb" style="display:flex;align-items:center;justify-content:center;background:#f0f0f0;"><span style="color:#ccc;font-size:20px;">&#128247;</span></div>';

			return '<div class="sight-result-item ' + (isSelected ? 'selected' : '') + '" data-idx="' + idx + '">' +
				'<input type="checkbox" class="sight-checkbox" ' + (isSelected ? 'checked' : '') + '>' +
				thumbHtml +
				'<div class="sight-info">' +
					'<div class="sight-name">' + escapeHtml(sight.sightName) + '</div>' +
					'<div class="sight-address">' + escapeHtml(sight.sightAddress || 'No address') + '</div>' +
				'</div>' +
			'</div>';
		}).join('');

		// Add click handlers
		resultsContainer.querySelectorAll('.sight-result-item').forEach(item => {
			item.addEventListener('click', function(e) {
				const idx = parseInt(this.dataset.idx);
				toggleSelection(idx);
			});
		});
	}

	async function toggleSelection(idx) {
		const sight = state.searchResults[idx];
		if (!sight) return;

		const existingIdx = state.selectedSights.findIndex(s => s.sightId === sight.sightId);

		if (existingIdx >= 0) {
			state.selectedSights.splice(existingIdx, 1);
		} else {
			// Fetch full details
			try {
				const response = await fetch('../backend/api/super-api.php?action=getSightDetail&sightId=' + sight.sightId);
				const data = await response.json();
				const fullSight = data.data?.sight || data.sight;
				state.selectedSights.push(fullSight || sight);
			} catch (e) {
				state.selectedSights.push(sight);
			}
		}

		renderResults();
		renderSelected();
		updateButton();
	}

	function removeFromSelection(sightId) {
		state.selectedSights = state.selectedSights.filter(s => s.sightId !== sightId);
		renderResults();
		renderSelected();
		updateButton();
	}
	// Expose to global for onclick
	window._removeSightFromSelection = removeFromSelection;

	function renderSelected() {
		const area = document.getElementById('selectedSightsArea');
		const list = document.getElementById('selectedSightsList');
		const countSpan = document.getElementById('selectedCount');
		if (!area || !list) return;

		if (state.selectedSights.length === 0) {
			area.style.display = 'none';
			return;
		}

		area.style.display = 'block';
		if (countSpan) countSpan.textContent = state.selectedSights.length;

		list.innerHTML = state.selectedSights.map((sight, idx) =>
			'<span class="selected-sight-tag">' +
				'<span class="order-num">' + (idx + 1) + '</span>' +
				escapeHtml(sight.sightName) +
				'<span class="remove-tag" onclick="event.stopPropagation(); window._removeSightFromSelection(' + sight.sightId + ')">&times;</span>' +
			'</span>'
		).join('');
	}

	function updateButton() {
		const btn = document.getElementById('confirmBtn');
		if (!btn) return;
		btn.disabled = state.selectedSights.length === 0;
		btn.textContent = state.selectedSights.length > 0
			? 'Add Selected (' + state.selectedSights.length + ')'
			: 'Add Selected';
	}

	function confirmSelection() {
		if (state.selectedSights.length === 0) return;

		// Call the handler function in parent scope
		if (typeof handleSightsSelected === 'function') {
			handleSightsSelected(state.selectedSights);
		} else if (typeof window.handleSightsSelected === 'function') {
			window.handleSightsSelected(state.selectedSights);
		}

		// Clean up
		state.searchResults = [];
		state.selectedSights = [];

		modal_close();
	}

	function escapeHtml(str) {
		if (!str) return '';
		const div = document.createElement('div');
		div.textContent = str;
		return div.innerHTML;
	}

	// Initialize
	function init() {
		// Reset state
		state.searchResults = [];
		state.selectedSights = [];

		// Bind events
		const searchBtn = document.getElementById('sightSearchBtn');
		const searchInput = document.getElementById('sightSearchInput');
		const confirmBtn = document.getElementById('confirmBtn');

		if (searchBtn) {
			searchBtn.addEventListener('click', loadSights);
		}
		if (searchInput) {
			searchInput.addEventListener('keypress', function(e) {
				if (e.key === 'Enter') {
					e.preventDefault();
					loadSights();
				}
			});
			searchInput.focus();
		}
		if (confirmBtn) {
			confirmBtn.addEventListener('click', confirmSelection);
		}

		// Load initial list
		loadSights();
	}

	// Run init after a short delay to ensure DOM is ready
	setTimeout(init, 50);
})();
</script>
