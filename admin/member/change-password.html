<style>
	.dialog-container .dialog-content::-webkit-scrollbar {
		display: none;
	}
</style>

<div class="dialog-container" style="display:flex; flex-direction:column; height:100%;">
	<button type="button" class="dialog-close" id="closeDialog" onclick="modal_close()"><i class="ic-close"></i></button>

	<h1 data-lan-eng="Change Password" style="flex-shrink:0;">Change Password</h1>

	<div class="dialog-content jw-mgt50" style="flex:1; overflow-y:auto; padding-right:8px; min-height:0; scrollbar-width:none; -ms-overflow-style:none;">
		<div class="field">
			<label class="label-name" data-lan-eng="Current Password">  <span class="req">*</span></label>
			<div class="input-box" style="padding-right:12px;">
				<input type="password" id="currentPassword" value="" placeholder="Please Enter" data-lan-eng-placeholder="Please Enter" required>
				<button type="button" class="password-toggle" onclick="togglePasswordVisibility('currentPassword', this)" style="background:none; border:none; cursor:pointer; padding:0; margin:0; display:flex; align-items:center; justify-content:center; width:24px; height:24px; flex-shrink:0;">
					<img src="../image/eye.svg" alt="Show password" style="width:20px; height:20px;">
				</button>
			</div>
		</div>

		<div class="field jw-mgt32">
			<label class="label-name" data-lan-eng="New Password">  <span class="req">*</span></label>
			<div class="input-box" style="padding-right:12px;">
				<input type="password" id="newPassword" value="" placeholder="Please Enter" data-lan-eng-placeholder="Please Enter" required>
				<button type="button" class="password-toggle" onclick="togglePasswordVisibility('newPassword', this)" style="background:none; border:none; cursor:pointer; padding:0; margin:0; display:flex; align-items:center; justify-content:center; width:24px; height:24px; flex-shrink:0;">
					<img src="../image/eye.svg" alt="Show password" style="width:20px; height:20px;">
				</button>
			</div>
		</div>

		<div class="field jw-mgt32">
			<label class="label-name" data-lan-eng="Confirm New Password">   <span class="req">*</span></label>
			<div class="input-box" style="padding-right:12px;">
				<input type="password" id="confirmPassword" value="" placeholder="Please Enter" data-lan-eng-placeholder="Please Enter" required>
				<button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmPassword', this)" style="background:none; border:none; cursor:pointer; padding:0; margin:0; display:flex; align-items:center; justify-content:center; width:24px; height:24px; flex-shrink:0;">
					<img src="../image/eye.svg" alt="Show password" style="width:20px; height:20px;">
				</button>
			</div>
		</div>

		<div id="changePasswordError" class="error-message" style="display:none; color:#ef4444; font-size:14px; margin-top:16px; line-height:1.4; word-wrap:break-word;"></div>
	</div>

	<div class="dialog-controls" style="flex-shrink:0; margin-top:24px; padding-top:16px; border-top:1px solid #e5e5e5;">
		<button type="button" class="jw-button typeB" id="changePasswordSubmitBtn" data-lan-eng="Change Password">Change Password</button>
	</div>
</div>

<script>
	(function () {
		const errorDiv = document.getElementById('changePasswordError');
		const btn = document.getElementById('changePasswordSubmitBtn');

		function showErr(msg) {
			// "."만 있는 메시지나 공백만 있는 메시지를 필터링
			const cleanMsg = String(msg || '').trim();
			if (!cleanMsg || cleanMsg === '.' || cleanMsg === '...' || cleanMsg === '....') {
				errorDiv.textContent = 'An error occurred. Please try again.';
			} else {
				errorDiv.textContent = cleanMsg;
			}
			errorDiv.style.display = cleanMsg ? 'block' : 'none';
			
			// 에러 메시지가 표시되면 스크롤을 최대 아래로 이동
			if (cleanMsg) {
				setTimeout(() => {
					const dialogContent = errorDiv.closest('.dialog-content');
					if (dialogContent) {
						dialogContent.scrollTop = dialogContent.scrollHeight;
					}
				}, 50);
			}
		}

		// 비밀번호 보기/숨기기 토글
		window.togglePasswordVisibility = function(inputId, btn) {
			const input = document.getElementById(inputId);
			const eyeImg = btn.querySelector('img');
			if (!input || !eyeImg) return;
			
			if (input.type === 'password') {
				input.type = 'text';
				eyeImg.src = '../image/eye-off.svg';
				eyeImg.alt = 'Hide password';
			} else {
				input.type = 'password';
				eyeImg.src = '../image/eye.svg';
				eyeImg.alt = 'Show password';
			}
		};

		btn.addEventListener('click', async () => {
			let shouldReenable = true;
			const prevText = btn.textContent;
			try {
				showErr('');
				const currentPassword = document.getElementById('currentPassword').value;
				const newPassword = document.getElementById('newPassword').value;
				const confirmPassword = document.getElementById('confirmPassword').value;

				if (!currentPassword) {
					showErr('Current password is required');
					return;
				}
				if (!newPassword) {
					showErr('New password is required');
					return;
				}
				if (!confirmPassword) {
					showErr('Please confirm your new password');
					return;
				}
				if (newPassword !== confirmPassword) {
					showErr('New password and confirmation do not match');
					return;
				}
				if (String(newPassword).length < 8) {
					showErr('New password must be at least 8 characters');
					return;
				}

				btn.disabled = true;
				btn.textContent = 'Processing...';

				const res = await fetch('/admin/backend/api/change-password.php', {
					method: 'POST',
					credentials: 'same-origin',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ currentPassword, newPassword })
				});

				if (res.status === 401) {
					alert('Login required');
					window.location.href = '/admin/index.html';
					shouldReenable = false;
					return;
				}

				const text = await res.text();
				let data = {};
				try { data = JSON.parse(text); } catch (_) { data = {}; }

				// debug:     .
				try {
					console.log('[ADMIN] change-password response:', {
						status: res.status,
						ok: res.ok,
						body: text
					});
				} catch (_) {}

				if (!res.ok || data.success === false) {
					const errMsg = (data && (data.message || data.error)) ? (data.message || data.error) : ('Failed to change password (HTTP ' + res.status + ')');
					showErr(errMsg);
					// 에러 발생 시에도 버튼을 다시 활성화
					shouldReenable = true;
					return;
				}

				alert((data && data.message) ? String(data.message) : 'Password changed successfully');
				modal_close();
				shouldReenable = false;
			} catch (e) {
				console.error('[ADMIN] change-password error:', e);
				showErr(e?.message ? String(e.message) : 'An error occurred while changing password');
				// 에러 발생 시에도 버튼을 다시 활성화
				shouldReenable = true;
			} finally {
				if (shouldReenable) {
					btn.disabled = false;
					btn.textContent = prevText;
				}
			}
		});
	})();
</script>


